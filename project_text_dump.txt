Dumping text-only project files...

=== app ===

--- FILE: app/admin/plans/page.tsx ---
"use client";

import { seedDefaultPlans } from "@/services/seed-plans";

export default function AdminPlansSeedPage() {
  return (
    <div className="p-8 space-y-4">
      <h1 className="text-xl font-semibold">Seed plans</h1>

      <button
        onClick={async () => {
          await seedDefaultPlans();
          alert("Plany zapisane w Firestore");
        }}
        className="px-4 py-2 rounded bg-black text-white"
      >
        Seed default plans
      </button>
    </div>
  );
}

--- FILE: app/admin/classes/page.tsx ---
import { WeekCalendar } from "@/components/admin/WeekCalendar";

export default function AdminClassesPage() {
  return (
    <div className="space-y-4">
      <h1 className="text-xl font-semibold">Zajƒôcia</h1>
      <WeekCalendar />
    </div>
  );
}

--- FILE: app/admin/groups/page.tsx ---
"use client";

import { useEffect, useState } from "react";
import type { Group } from "@/types/groups";
import {
  getGroups,
  createGroup,
  updateGroup,
  deleteGroup,
} from "@/services/groups.service";
import { Button } from "@/components/ui/button";
import { Dialog, DialogContent } from "@/components/ui/dialog";
import { Input } from "@/components/ui/input";

export default function GroupsPage() {
  const [groups, setGroups] = useState<Group[]>([]);
  const [editing, setEditing] = useState<Group | null>(null);
  const [open, setOpen] = useState(false);

  const [form, setForm] = useState({
    name: "",
    description: "",
    color: "#6366f1",
  });

  useEffect(() => {
    getGroups().then(setGroups);
  }, []);

  function openCreate() {
    setForm({ name: "", description: "", color: "#6366f1" });
    setEditing(null);
    setOpen(true);
  }

  function openEdit(group: Group) {
    setForm({
      name: group.name,
      description: group.description ?? "",
      color: group.color ?? "#6366f1",
    });
    setEditing(group);
    setOpen(true);
  }

  async function save() {
    if (!form.name.trim()) return alert("Podaj nazwƒô grupy.");

    if (editing) {
      await updateGroup(editing.id, form);
      setGroups((g) =>
        g.map((x) =>
          x.id === editing.id ? { ...x, ...form } : x
        )
      );
    } else {
      const ref = await createGroup({
        ...form,
        childIds: [],
      });

      setGroups((g) => [
        ...g,
        {
          id: ref.id,
          ...form,
          childIds: [],
          createdAt: Date.now(),
        },
      ]);
    }

    setOpen(false);
  }

  async function remove(group: Group) {
    if (!confirm(`UsunƒÖƒá grupƒô "${group.name}"?`)) return;
    await deleteGroup(group.id);
    setGroups((g) => g.filter((x) => x.id !== group.id));
  }

  return (
    <div className="space-y-6">
      <div className="flex justify-between items-center">
        <h1 className="text-xl font-semibold">Grupy</h1>
        <Button onClick={openCreate}>‚ûï Nowa grupa</Button>
      </div>

      <div className="grid sm:grid-cols-2 lg:grid-cols-3 gap-4">
        {groups.map((g) => (
          <div
            key={g.id}
            className="border rounded-xl p-4 space-y-2"
          >
            <div className="flex items-center justify-between">
              <div className="flex items-center gap-2">
                <div
                  className="w-3 h-3 rounded-full"
                  style={{ background: g.color }}
                />
                <p className="font-medium">{g.name}</p>
              </div>

              <div className="flex gap-2">
                <Button
                  size="sm"
                  variant="outline"
                  onClick={() => openEdit(g)}
                >
                  Edytuj
                </Button>
                <Button
                  size="sm"
                  variant="destructive"
                  onClick={() => remove(g)}
                >
                  Usu≈Ñ
                </Button>
              </div>
            </div>

            {g.description && (
              <p className="text-sm text-muted-foreground">
                {g.description}
              </p>
            )}

            <p className="text-xs text-muted-foreground">
              Dzieci: {g.childIds.length}
            </p>
          </div>
        ))}

        {groups.length === 0 && (
          <p className="text-sm text-muted-foreground">
            Brak grup.
          </p>
        )}
      </div>

      {/* Dialog */}
      <Dialog open={open} onOpenChange={setOpen}>
        <DialogContent className="space-y-4">
          <h2 className="font-medium">
            {editing ? "Edytuj grupƒô" : "Nowa grupa"}
          </h2>

          <Input
            placeholder="Nazwa grupy"
            value={form.name}
            onChange={(e) =>
              setForm((f) => ({ ...f, name: e.target.value }))
            }
          />

          <Input
            placeholder="Opis (opcjonalnie)"
            value={form.description}
            onChange={(e) =>
              setForm((f) => ({
                ...f,
                description: e.target.value,
              }))
            }
          />

          <div className="flex items-center gap-3">
            <label className="text-sm">Kolor</label>
            <input
              type="color"
              value={form.color}
              onChange={(e) =>
                setForm((f) => ({ ...f, color: e.target.value }))
              }
            />
          </div>

          <div className="flex justify-end gap-2 pt-2">
            <Button variant="outline" onClick={() => setOpen(false)}>
              Anuluj
            </Button>
            <Button onClick={save}>Zapisz</Button>
          </div>
        </DialogContent>
      </Dialog>
    </div>
  );
}

--- FILE: app/admin/layout.tsx ---
import { AuthGate } from "@/components/auth/AuthGate";
import { AdminGate } from "@/components/auth/AdminGate";
import { AdminLayout } from "@/components/admin/AdminLayout";

export default function Layout({ children }: { children: React.ReactNode }) {
  return (
    <AuthGate>
      <AdminGate>
        <AdminLayout>{children}</AdminLayout>
      </AdminGate>
    </AuthGate>
  );
}

--- FILE: app/admin/users/page.tsx ---
"use client";

import { useEffect, useMemo, useState } from "react";
import { getAdminUsers } from "@/services/admin-users.service";
import type { AdminUser } from "@/types/admin";
import { UserDetailsModal } from "@/components/admin/UserDetailsModal";
import { ProviderIcon } from "@/components/admin/ProviderIcon";
import { Input } from "@/components/ui/input";
import { Button } from "@/components/ui/button";
import { cn } from "@/lib/utils";

type SortKey = "name" | "lastLogin" | "created" | "presence";

function formatWhen(ts?: number) {
  if (!ts) return "‚Äî";
  const d = new Date(ts);
  const diffMs = Date.now() - ts;
  const diffMin = Math.floor(diffMs / 60000);

  if (diffMin < 1) return "przed chwilƒÖ";
  if (diffMin < 60) return `${diffMin} min temu`;
  if (diffMin < 24 * 60) return `${Math.floor(diffMin / 60)} h temu`;

  return d.toLocaleString("pl-PL");
}

function getPresence(u: AdminUser): { lastSeenAt?: number } {
  // Dostosowane elastycznie do r√≥≈ºnych struktur
  const anyU: any = u as any;

  return {
    lastSeenAt:
      anyU?.presence?.lastSeenAt ??
      anyU?.presenceLastSeenAt ??
      anyU?.lastSeenAtPresence ??
      undefined,
  };
}

function presenceColor(u: AdminUser): "green" | "yellow" | "gray" {
  const { lastSeenAt } = getPresence(u);
  if (!lastSeenAt) return "gray";

  const diffMs = Date.now() - lastSeenAt;
  if (diffMs <= 2 * 60 * 1000) return "green"; // <= 2 min
  if (diffMs <= 60 * 60 * 1000) return "yellow"; // <= 1h
  return "gray";
}

function PresenceDot({ color }: { color: "green" | "yellow" | "gray" }) {
  return (
    <span className="relative inline-flex h-2.5 w-2.5">
      <span
        className={cn(
          "absolute inline-flex h-full w-full rounded-full opacity-80",
          color === "green" && "bg-emerald-500",
          color === "yellow" && "bg-amber-500",
          color === "gray" && "bg-zinc-400"
        )}
      />
      {color === "green" && (
        <span className="absolute inline-flex h-full w-full rounded-full bg-emerald-500 animate-ping opacity-25" />
      )}
    </span>
  );
}

function childrenLabel(u: AdminUser) {
  const kids = u.children ?? [];
  if (kids.length === 0) return null;

  const names = kids.map((c) => `${c.firstName} ${c.lastName}`.trim()).filter(Boolean);
  if (names.length === 0) return `üë∂ Dzieci: ${kids.length}`;

  const short = names.slice(0, 2).join(", ");
  const rest = names.length - 2;

  return rest > 0 ? `üë∂ ${short} +${rest}` : `üë∂ ${short}`;
}

export default function AdminUsersPage() {
  const [users, setUsers] = useState<AdminUser[]>([]);
  const [selected, setSelected] = useState<AdminUser | null>(null);
  const [loading, setLoading] = useState(true);

  const [query, setQuery] = useState("");
  const [sortKey, setSortKey] = useState<SortKey>("name");
  const [sortDir, setSortDir] = useState<"asc" | "desc">("asc");
  const [onlyOnline, setOnlyOnline] = useState(false);

  useEffect(() => {
    setLoading(true);
    getAdminUsers()
      .then(setUsers)
      .finally(() => setLoading(false));
  }, []);

  const filtered = useMemo(() => {
    const q = query.toLowerCase().trim();

    let list = users.filter((u) => {
      const base = `${u.firstName} ${u.lastName} ${u.email}`.toLowerCase();
      const kids = (u.children ?? [])
        .map((c) => `${c.firstName} ${c.lastName}`.toLowerCase())
        .join(" ");
      return `${base} ${kids}`.includes(q);
    });

    if (onlyOnline) {
      list = list.filter((u) => presenceColor(u) === "green");
    }

    list.sort((a, b) => {
      const dir = sortDir === "asc" ? 1 : -1;

      if (sortKey === "name") {
        const av = `${a.lastName} ${a.firstName}`.localeCompare(
          `${b.lastName} ${b.firstName}`,
          "pl"
        );
        return av * dir;
      }

      if (sortKey === "lastLogin") {
        const av = a.lastLoginAt ?? 0;
        const bv = b.lastLoginAt ?? 0;
        return (av - bv) * dir;
      }

      if (sortKey === "created") {
        const av = a.createdAt ?? 0;
        const bv = b.createdAt ?? 0;
        return (av - bv) * dir;
      }

      if (sortKey === "presence") {
        const av = getPresence(a).lastSeenAt ?? 0;
        const bv = getPresence(b).lastSeenAt ?? 0;
        return (av - bv) * dir;
      }

      return 0;
    });

    return list;
  }, [users, query, sortKey, sortDir, onlyOnline]);

  if (loading) return <div className="p-6">≈Åadowanie‚Ä¶</div>;

  return (
    <div className="space-y-4 p-6">
      <div className="flex items-end justify-between gap-3 flex-wrap">
        <div className="space-y-1">
          <h1 className="text-xl font-semibold">U≈ºytkownicy</h1>
          <div className="text-sm text-muted-foreground">
            ≈ÅƒÖcznie: {users.length} ‚Ä¢ Widoczne: {filtered.length}
          </div>
        </div>
      </div>

      {/* Toolbar */}
      <div className="flex flex-wrap gap-2 items-center">
        <Input
          placeholder="Szukaj (imiƒô, nazwisko, email, dzieci)..."
          value={query}
          onChange={(e) => setQuery(e.target.value)}
          className="max-w-sm"
        />

        <select
          className="input"
          value={sortKey}
          onChange={(e) => setSortKey(e.target.value as SortKey)}
        >
          <option value="name">Sortuj: Nazwa</option>
          <option value="lastLogin">Sortuj: Ostatnie logowanie</option>
          <option value="created">Sortuj: Data utworzenia</option>
          <option value="presence">Sortuj: Aktywno≈õƒá (online)</option>
        </select>

        <Button
          variant="outline"
          onClick={() => setSortDir((d) => (d === "asc" ? "desc" : "asc"))}
        >
          {sortDir === "asc" ? "‚Üë RosnƒÖco" : "‚Üì MalejƒÖco"}
        </Button>

        <Button
          variant={onlyOnline ? "default" : "outline"}
          onClick={() => setOnlyOnline((v) => !v)}
        >
          {onlyOnline ? "Tylko online: TAK" : "Tylko online"}
        </Button>
      </div>

      {/* Lista */}
      <div className="rounded-xl border bg-background overflow-hidden">
        {filtered.length === 0 ? (
          <div className="p-6 text-sm text-muted-foreground">
            Brak wynik√≥w.
          </div>
        ) : (
          <div className="divide-y">
            {filtered.map((u) => {
              const dot = presenceColor(u);
              const lastSeen = getPresence(u).lastSeenAt;

              return (
                <button
                  key={u.id}
                  onClick={() => setSelected(u)}
                  className={cn(
                    "w-full text-left px-4 py-3 flex items-center justify-between gap-4",
                    "hover:bg-muted/60 transition-colors",
                    "active:scale-[0.99] transition-transform",
                    "focus:outline-none focus:ring-2 focus:ring-ring"
                  )}
                >
                  <div className="min-w-0 flex items-center gap-3">
                    <div className="flex items-center gap-2">
                      <PresenceDot color={dot} />
                      <span className="inline-flex items-center justify-center h-9 w-9 rounded-full bg-muted border">
                        <ProviderIcon provider={u.provider} />
                      </span>
                    </div>

                    <div className="min-w-0">
                      <div className="font-medium truncate">
                        {u.firstName} {u.lastName}
                      </div>
                      <div className="text-xs text-muted-foreground truncate">
                        {u.email}
                      </div>

                      {childrenLabel(u) && (
                        <div className="mt-1 text-xs text-muted-foreground truncate">
                          {childrenLabel(u)}
                        </div>
                      )}
                    </div>
                  </div>

                  <div className="shrink-0 text-right text-xs text-muted-foreground">
                    <div className="flex items-center justify-end gap-2">
                      <span className="rounded-full border px-2 py-0.5 bg-muted/40">
                        {dot === "green"
                          ? "online"
                          : dot === "yellow"
                          ? "aktywny < 1h"
                          : "offline"}
                      </span>
                    </div>

                    <div className="mt-1">
                      <span className="opacity-80">Ostatnio:</span>{" "}
                      {formatWhen(lastSeen)}
                    </div>

                    <div className="mt-1">
                      <span className="opacity-80">Logowanie:</span>{" "}
                      {formatWhen(u.lastLoginAt)}
                    </div>
                  </div>
                </button>
              );
            })}
          </div>
        )}
      </div>

      <UserDetailsModal
        user={selected}
        onClose={() => setSelected(null)}
        onUpdated={(updated) => {
          setUsers((u) => u.map((x) => (x.id === updated.id ? updated : x)));
          setSelected(updated); // opcjonalnie: od≈õwie≈º te≈º zaznaczonego
        }}
      />
    </div>
  );
}

--- FILE: app/layout.tsx ---
import "./globals.css";
import { AuthProvider } from "@/components/auth/AuthProvider";

export const metadata = {
  title: "Platforma",
  description: "Next.js + Firebase",
};

export default function RootLayout({ children }: { children: React.ReactNode }) {
  return (
    <html lang="pl">
      <body>
        <AuthProvider>{children}</AuthProvider>
      </body>
    </html>
  );
}

--- FILE: app/(public)/page.tsx ---

--- FILE: app/api/payments/tpay/start/route.ts ---
// app/api/payments/tpay/start/route.ts
import { NextRequest } from "next/server";
import { adminDb } from "@/lib/firebase/admin";
import { buildTpayForm } from "@/services/tpay.service";

export async function GET(req: NextRequest) {
  const intentId = req.nextUrl.searchParams.get("intentId");

  if (!intentId) {
    return new Response("Missing intentId", { status: 400 });
  }

  const snap = await adminDb
    .collection("payment_intents")
    .doc(intentId)
    .get();

  if (!snap.exists) {
    return new Response("PaymentIntent not found", { status: 404 });
  }

  const intent = snap.data()!;
  const APP_URL = process.env.NEXT_PUBLIC_APP_URL!;

  const tpay = buildTpayForm({
    merchantId: process.env.TPAY_MERCHANT_ID!,
    securityCode: process.env.TPAY_MD5_SECRET!, // ‚Üê KOD ZABEZPIECZAJƒÑCY
    amountCents: intent.amountCents,
    crc: intentId,
    description: "Zajƒôcia muzyczne",
    email: "test@test.pl",
    returnUrl: `${APP_URL}/dashboard/payments?intent=${intentId}`,
    resultUrl: `${APP_URL}/api/payments/tpay/webhook`,
  });

  return new Response(
    `<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <title>TPAY DEBUG</title>
  <style>
    body { font-family: monospace; padding: 20px; }
    pre { background: #111; color: #0f0; padding: 12px; }
    button { font-size: 16px; padding: 10px 20px; }
  </style>
</head>
<body>
  <h1>TPAY DEBUG FORM</h1>

  <h2>POST ‚Üí ${tpay.action}</h2>

  <pre>${JSON.stringify(tpay.fields, null, 2)}</pre>

  <form method="POST" action="${tpay.action}">
    ${Object.entries(tpay.fields)
      .map(([k, v]) => `<input type="hidden" name="${k}" value="${v}" />`)
      .join("\n")}
    <button type="submit">üöÄ Wy≈õlij do Tpay (sandbox)</button>
  </form>
</body>
</html>`,
    {
      headers: { "Content-Type": "text/html; charset=utf-8" },
    }
  );
}

--- FILE: app/api/payments/tpay/create/route.ts ---
// app/api/payments/tpay/create/route.ts
import { NextResponse } from "next/server";
import { adminDb } from "@/lib/firebase/admin";
import { createTpayTransaction } from "@/services/tpay-openapi.service";

function maskEmail(s?: string) {
  if (!s) return "EMPTY";
  const [a, b] = s.split("@");
  if (!a || !b) return "INVALID";
  return `${a.slice(0, 2)}***@${b}`;
}

export async function POST(req: Request) {
  try {
    const body = await req.json().catch(() => ({}));
    const intentId = String(body?.intentId || "").trim();

    console.log("\n=== /api/payments/tpay/create INPUT ===");
    console.log({ intentId, bodyKeys: Object.keys(body || {}) });
    console.log("======================================\n");

    if (!intentId) {
      return NextResponse.json({ error: "Missing intentId" }, { status: 400 });
    }

    const APP_URL =
      process.env.NEXT_PUBLIC_APP_URL || process.env.APP_URL || "";

    if (!APP_URL) {
      return NextResponse.json(
        { error: "NEXT_PUBLIC_APP_URL (or APP_URL) not set" },
        { status: 500 }
      );
    }

    const intentRef = adminDb.collection("payment_intents").doc(intentId);
    const snap = await intentRef.get();

    if (!snap.exists) {
      return NextResponse.json(
        { error: "PaymentIntent not found", intentId },
        { status: 404 }
      );
    }

    const intent: any = snap.data();

    const amountCents = Number(intent?.amountCents);
    const amount = Number((amountCents / 100).toFixed(2));
    const email = String(intent?.email || "").trim();
    const description = String(
      intent?.description || `Plan ${intent?.planId || ""}`
    ).trim();

    // payerName z users/{uid}
    let payerName: string | undefined = undefined;
    try {
      const parentId = String(intent?.parentId || "").trim();
      if (parentId) {
        const userSnap = await adminDb.collection("users").doc(parentId).get();
        if (userSnap.exists) {
          const u: any = userSnap.data();
          const fn = String(u?.firstName || "").trim();
          const ln = String(u?.lastName || "").trim();
          const full = `${fn} ${ln}`.trim();
          if (full) payerName = full;
        }
      }
    } catch {}

    console.log("=== INTENT DATA (resolved) ===");
    console.log({
      intentId,
      parentId: intent?.parentId,
      amountCents,
      amount,
      emailMasked: maskEmail(email),
      description,
      payerName,
      intentKeys: Object.keys(intent || {}),
      metadataKeys: Object.keys(intent?.metadata || {}),
    });
    console.log("===================================\n");

    if (!amountCents || !Number.isFinite(amount) || amount <= 0) {
      return NextResponse.json(
        { error: "Invalid amount in PaymentIntent", intentId, amountCents },
        { status: 400 }
      );
    }

    if (!email) {
      return NextResponse.json(
        { error: "Missing email in PaymentIntent", intentId },
        { status: 400 }
      );
    }

    // ‚úÖ wracamy na dashboard/classes i pokazujemy banner/toast
    const successUrl = `${APP_URL}/dashboard/classes?payment=success&intent=${intentId}`;
    const errorUrl = `${APP_URL}/dashboard/classes?payment=error&intent=${intentId}`;

    // ‚úÖ webhook:
    const notificationUrl = `${APP_URL}/api/tpay/webhook`;

    const tpay = await createTpayTransaction({
      intentId,
      amount,
      currency: "PLN",
      description,
      payerEmail: email,
      payerName,
      successUrl,
      errorUrl,
      notificationUrl,
    });

    await intentRef.set(
      {
        status: "redirected",
        provider: "tpay",
        providerTransactionId: tpay.transactionId,
        providerTitle: tpay.title,
        updatedAt: Date.now(),
      },
      { merge: true }
    );

    return NextResponse.json({ paymentUrl: tpay.paymentUrl });
  } catch (err: any) {
    console.error("TPAY CREATE ERROR:", err);
    return NextResponse.json(
      { error: "TPAY OPENAPI FAILED", details: String(err?.message || err) },
      { status: 500 }
    );
  }
}

--- FILE: app/api/enrollments/consume/route.ts ---
// app/api/enrollments/consume/route.ts
import { NextResponse } from "next/server";
import { adminAuth, adminDb } from "@/lib/firebase/admin";
import { FieldValue } from "firebase-admin/firestore";
import { parseYMD, usageKeyForPeriod } from "@/services/time";

export const runtime = "nodejs";

type ClassDoc = {
  isActive?: boolean;
  weekday?: number; // 1=Mon..7=Sun
  recurrence?: {
    type?: "none" | "weekly" | "biweekly" | "monthly";
    interval?: number;
    startDate: string; // YYYY-MM-DD
    endDate?: string | null;
  };
};

function uniqSortedDates(dates: string[]) {
  return Array.from(
    new Set(dates.map((s) => String(s || "").trim()).filter(Boolean))
  ).sort();
}

// class.weekday: 1=Mon..7=Sun, JS: 0=Sun..6=Sat
function classWeekdayToJs(weekday: number) {
  return weekday % 7; // 7->0
}

function nextWeekday(from: Date, jsDay: number) {
  const d = new Date(from);
  const diff = (jsDay - d.getDay() + 7) % 7;
  d.setDate(d.getDate() + diff);
  return d;
}

function getAnchorDate(cls: ClassDoc) {
  const start = parseYMD(cls.recurrence?.startDate || "1970-01-01");
  const jsDay = classWeekdayToJs(Number(cls.weekday || 1));
  return nextWeekday(start, jsDay);
}

function weeksBetween(a: Date, b: Date) {
  const DAY_MS = 24 * 60 * 60 * 1000;
  const diff = Math.floor((b.getTime() - a.getTime()) / DAY_MS);
  return Math.floor(diff / 7);
}

/** Czy zajƒôcia wystƒôpujƒÖ w danym dniu (YYYY-MM-DD) wg recurrence? */
function isClassOnDate(cls: ClassDoc, ymd: string) {
  const rec = cls.recurrence;
  if (!rec?.startDate) return false;

  const d = parseYMD(ymd);

  const startLimit = parseYMD(rec.startDate);
  const endLimit = rec.endDate ? parseYMD(rec.endDate) : null;

  if (d < startLimit) return false;
  if (endLimit && d > endLimit) return false;

  if (rec.type === "none") {
    return ymd === rec.startDate;
  }

  const interval = Math.max(1, Number(rec.interval || 1));
  const anchor = getAnchorDate(cls);

  const jsDay = classWeekdayToJs(Number(cls.weekday || 1));
  if (d.getDay() !== jsDay) return false;

  const w = weeksBetween(anchor, d);
  if (w < 0) return false;
  return w % interval === 0;
}

type EntDoc = {
  parentId: string;
  childId?: string | null;
  status: "active" | "inactive" | "expired" | "cancelled" | string;
  validFrom: number;
  validTo: number;
  limits?: {
    credits?: {
      amount?: number;
      period?: "none" | "month" | "week";
      unlimited?: boolean;
      oneTime?: boolean;
    };
  };
  usage?: { credits?: Record<string, number> };
};

export async function POST(req: Request) {
  try {
    const authHeader = req.headers.get("authorization") || "";
    const token = authHeader.startsWith("Bearer ")
      ? authHeader.slice(7)
      : null;

    if (!token) {
      return NextResponse.json({ error: "Unauthorized" }, { status: 401 });
    }

    const decoded = await adminAuth.verifyIdToken(token);
    const parentId = decoded.uid;

    const body = await req.json();
    const classId = String(body?.classId || "").trim();
    const childId = String(body?.childId || "").trim();
    const requestedDates = uniqSortedDates(
      Array.isArray(body?.dates) ? body.dates : []
    );

    if (!classId || !childId || requestedDates.length === 0) {
      return NextResponse.json({ error: "Bad request" }, { status: 400 });
    }

    // --- child must belong to parent ---
    const childSnap = await adminDb.collection("children").doc(childId).get();
    if (!childSnap.exists) {
      return NextResponse.json({ error: "Child not found" }, { status: 404 });
    }
    if (String(childSnap.data()?.parentId || "") !== parentId) {
      return NextResponse.json({ error: "Forbidden" }, { status: 403 });
    }

    // --- class exists + active ---
    const classSnap = await adminDb.collection("classes").doc(classId).get();
    if (!classSnap.exists) {
      return NextResponse.json({ error: "Class not found" }, { status: 404 });
    }
    const cls = classSnap.data() as ClassDoc;
    if (cls.isActive === false) {
      return NextResponse.json({ error: "Class inactive" }, { status: 400 });
    }

    // --- validate requested dates ---
    const now = Date.now();
    for (const ymd of requestedDates) {
      const ts = parseYMD(ymd).getTime();
      if (ts < now) {
        return NextResponse.json(
          { error: "Date in the past", date: ymd },
          { status: 400 }
        );
      }
      if (!isClassOnDate(cls, ymd)) {
        return NextResponse.json(
          { error: "Date not valid for this class", date: ymd },
          { status: 400 }
        );
      }
    }

    // --- load active entitlements (then filter by validity) ---
    const entSnap = await adminDb
      .collection("entitlements")
      .where("parentId", "==", parentId)
      .where("status", "==", "active")
      .get();

    // ‚úÖ krytyczne: tylko entitlements wa≈ºne dla TERAZ i dla wszystkich dat
    const entDocs = entSnap.docs
      .map((d) => ({ id: d.id, ...(d.data() as EntDoc) }))
      .filter((e) => now >= Number(e.validFrom || 0) && now <= Number(e.validTo || 0))
      .filter((e) => {
        // entitlement musi obejmowaƒá wszystkie daty rezerwacji
        return requestedDates.every((ymd) => {
          const ts = parseYMD(ymd).getTime();
          return ts >= Number(e.validFrom || 0) && ts <= Number(e.validTo || 0);
        });
      });

    if (entDocs.length === 0) {
      return NextResponse.json(
        { error: "No valid entitlement for these dates" },
        { status: 402 }
      );
    }

    // --- choose best entitlement (enough credits for all dates) ---
    let best:
      | {
          id: string;
          ent: EntDoc;
          remainingByKey: Record<string, number>;
          score: number;
        }
      | null = null;

    for (const item of entDocs) {
      const entChildId = String(item.childId || "").trim();
      if (entChildId && entChildId !== childId) continue;

      const credits = item.limits?.credits || {};
      const unlimited = Boolean(credits.unlimited);
      const amount = Number(credits.amount || 0);
      const period = (credits.period || "none") as "none" | "month" | "week";

      if (!unlimited && amount <= 0) continue;

      // ile potrzeba spaliƒá w danym okresie (kluczu)
      const needByKey: Record<string, number> = {};
      for (const ymd of requestedDates) {
        const ts = parseYMD(ymd).getTime();
        const k = usageKeyForPeriod(period, ts);
        needByKey[k] = (needByKey[k] || 0) + 1;
      }

      // stan u≈ºycia
      const usedMap = item.usage?.credits || {};
      const remainingByKey: Record<string, number> = {};
      let ok = true;

      for (const [k, need] of Object.entries(needByKey)) {
        const used = Number(usedMap[k] || 0);
        const remaining = unlimited ? 999999 : Math.max(0, amount - used);
        remainingByKey[k] = remaining;
        if (!unlimited && remaining < need) {
          ok = false;
          break;
        }
      }

      if (!ok) continue;

      // scoring: prefer child-specific + more remaining
      const sumRemaining = Object.values(remainingByKey).reduce((a, b) => a + b, 0);
      const score = (entChildId ? 100000 : 0) + sumRemaining;

      if (!best || score > best.score) {
        best = { id: item.id, ent: item, remainingByKey, score };
      }
    }

    if (!best) {
      return NextResponse.json(
        { error: "Not enough credits" },
        { status: 402 }
      );
    }

    const entitlementId = best.id;

    // --- transaction: re-check + create reservations + burn credits ---
    const entRef = adminDb.collection("entitlements").doc(entitlementId);

    const reservations = requestedDates.map((ymd) => {
      const rid = `${childId}__${classId}__${ymd}`;
      return { id: rid, ymd, ref: adminDb.collection("reservations").doc(rid) };
    });

    const reqId = `${classId}_${childId}`;
    const reqRef = adminDb.collection("enrollment_requests").doc(reqId);

    const result = await adminDb.runTransaction(async (tx) => {
      // READS
      const entSnap2 = await tx.get(entRef);
      if (!entSnap2.exists) throw new Error("Entitlement missing");
      const ent2 = entSnap2.data() as EntDoc;

      if (ent2.status !== "active") throw new Error("Entitlement not active");

      // ‚úÖ wa≈ºno≈õƒá w transakcji
      if (!(now >= Number(ent2.validFrom || 0) && now <= Number(ent2.validTo || 0))) {
        throw new Error("Entitlement expired");
      }
      for (const ymd of requestedDates) {
        const ts = parseYMD(ymd).getTime();
        if (ts < Number(ent2.validFrom || 0) || ts > Number(ent2.validTo || 0)) {
          throw new Error("Entitlement not valid for date " + ymd);
        }
      }

      const resSnaps = await Promise.all(reservations.map((r) => tx.get(r.ref)));

      const toCreate = reservations.filter((r, idx) => !resSnaps[idx].exists);
      if (toCreate.length === 0) {
        return { created: 0, alreadyHadAll: true };
      }

      const credits = ent2.limits?.credits || {};
      const unlimited = Boolean(credits.unlimited);
      const amount = Number(credits.amount || 0);
      const period = (credits.period || "none") as "none" | "month" | "week";

      if (!unlimited && amount <= 0) throw new Error("No credits limit found");

      // burn map for only the NEW reservations
      const burnByKey: Record<string, number> = {};
      for (const r of toCreate) {
        const ts = parseYMD(r.ymd).getTime();
        const k = usageKeyForPeriod(period, ts);
        burnByKey[k] = (burnByKey[k] || 0) + 1;
      }

      // check credits again with current usage
      const usedMap = ent2.usage?.credits || {};
      if (!unlimited) {
        for (const [k, burn] of Object.entries(burnByKey)) {
          const used = Number(usedMap[k] || 0);
          if (used + burn > amount) throw new Error("No credits");
        }
      }

      // WRITES
      for (const r of toCreate) {
        tx.set(
          r.ref,
          {
            parentId,
            childId,
            classId,
            dateYMD: r.ymd,
            status: "active",
            paymentMethod: "credits",
            entitlementId,
            createdAt: Date.now(),
            createdAtServer: FieldValue.serverTimestamp(),
          },
          { merge: true }
        );
      }

      tx.set(
        reqRef,
        {
          parentId,
          childId,
          classId,
          status: "approved",
          paymentMethod: "credits",
          dates: FieldValue.arrayUnion(...toCreate.map((x) => x.ymd)),
          updatedAt: Date.now(),
          updatedAtServer: FieldValue.serverTimestamp(),
          createdAt: Date.now(),
          createdAtServer: FieldValue.serverTimestamp(),
        },
        { merge: true }
      );

      if (!unlimited) {
        const incObj: Record<string, any> = {};
        for (const [k, burn] of Object.entries(burnByKey)) {
          incObj[k] = FieldValue.increment(burn);
        }
        tx.set(
          entRef,
          {
            usage: { credits: incObj },
            updatedAt: Date.now(),
            updatedAtServer: FieldValue.serverTimestamp(),
          },
          { merge: true }
        );
      }

      return { created: toCreate.length, alreadyHadAll: false };
    });

    return NextResponse.json({ ok: true, entitlementId, ...result });
  } catch (e: any) {
    console.error("[consume] error:", e);
    const msg = String(e?.message || "Unknown error");
    const status =
      msg.includes("No credits") ? 402 :
      msg.includes("expired") ? 402 :
      500;
    return NextResponse.json({ error: msg }, { status });
  }
}

--- FILE: app/api/admin/seed-plans/route.ts ---
import { NextResponse } from "next/server";
import { seedDefaultPlans } from "@/services/seed-plans";

export async function POST() {
  try {
    await seedDefaultPlans();
    return NextResponse.json({ ok: true });
  } catch (e) {
    console.error(e);
    return NextResponse.json({ error: "seed failed" }, { status: 500 });
  }
}

--- FILE: app/api/tpay/webhook/route.ts ---
// app/api/tpay/webhook/route.ts
import crypto from "crypto";
import { adminDb } from "@/lib/firebase/admin";
import {
  finalizePaidIntent,
  markIntentFailed,
} from "@/services/billing-finalize.service";

export const runtime = "nodejs";

/** Tpay POST: application/x-www-form-urlencoded */
function parseFormUrlEncoded(raw: string) {
  const sp = new URLSearchParams(raw);
  const obj: Record<string, string> = {};
  for (const [k, v] of sp.entries()) obj[k] = v;
  return obj;
}

function md5(input: string) {
  return crypto.createHash("md5").update(input, "utf8").digest("hex");
}

function mask(s?: string, left = 4, right = 4) {
  if (!s) return "EMPTY";
  if (s.length <= left + right) return `${s.slice(0, 1)}***`;
  return `${s.slice(0, left)}***${s.slice(-right)}`;
}

function tpayOk() {
  // KLUCZ: Tpay oczekuje "TRUE" jako body (text/plain), inaczej robi retry
  return new Response("TRUE", {
    status: 200,
    headers: { "Content-Type": "text/plain; charset=utf-8" },
  });
}

export async function POST(req: Request) {
  const raw = await req.text();
  const payload = parseFormUrlEncoded(raw);

  // wyciƒÖgniƒôcie p√≥l
  const merchantId = String(payload.id || "").trim();
  const trId = String(payload.tr_id || "").trim();
  const intentId = String(payload.tr_crc || "").trim(); // u Ciebie: intentId
  const trStatus = String(payload.tr_status || "").trim(); // "TRUE" / "FALSE"
  const trAmount = String(payload.tr_amount || "").trim(); // np "40.00"
  const md5sum = String(payload.md5sum || "").trim();

  console.log("\n=== TPAY WEBHOOK IN ===");
  console.log("merchantId:", mask(merchantId));
  console.log("trId:", mask(trId));
  console.log("intentId:", mask(intentId));
  console.log("trStatus:", trStatus);
  console.log("trAmount:", trAmount);
  console.log("md5sum:", mask(md5sum));
  console.log("payloadKeys:", Object.keys(payload));
  console.log("=======================\n");

  // Minimalna walidacja ‚Äî zawsze TRUE, ≈ºeby nie by≈Ço retry storm
  if (!merchantId || !trId || !intentId) {
    console.error("[TPAY WEBHOOK] Missing required fields", {
      merchantId: !!merchantId,
      trId: !!trId,
      intentId: !!intentId,
    });
    return tpayOk();
  }

  // 1) MD5 verify (opcjonalnie, ale polecam)
  const md5Secret = (process.env.TPAY_MD5_SECRET || "").trim();
  if (md5Secret) {
    // Najczƒô≈õciej spotykany uk≈Çad: md5(id + tr_id + tr_amount + tr_crc + secret)
    const expected = md5(`${merchantId}${trId}${trAmount}${intentId}${md5Secret}`);
    if (expected !== md5sum) {
      console.error("[TPAY WEBHOOK] MD5 mismatch", {
        expected: mask(expected),
        got: mask(md5sum),
      });
      // ‚úÖ nie przetwarzamy, ale zwracamy TRUE ≈ºeby Tpay nie retryowa≈Ç w k√≥≈Çko
      return tpayOk();
    }
  } else {
    // nie spamuj w prod logami, ale warto wiedzieƒá w dev
    console.warn("[TPAY WEBHOOK] TPAY_MD5_SECRET not set -> skipping MD5 verify");
  }

  // 2) Pobierz PaymentIntent
  const intentRef = adminDb.collection("payment_intents").doc(intentId);

  const snap = await intentRef.get();
  if (!snap.exists) {
    console.error("[TPAY WEBHOOK] PaymentIntent not found:", intentId);
    return tpayOk();
  }

  const intent: any = snap.data() || {};

  // Idempotencja: je≈õli ju≈º finalizedAt -> nic nie robimy
  if (intent.finalizedAt) {
    console.log("[TPAY WEBHOOK] already finalized:", intentId);
    return tpayOk();
  }

  // (opcjonalnie) anty-duplikacja: ustaw processingAt tylko je≈õli jeszcze nie by≈Ço
  // dziƒôki temu jak Tpay uderzy 2x na raz, drugi request szybko zako≈Ñczy
  try {
    await adminDb.runTransaction(async (tx) => {
      const fresh = await tx.get(intentRef);
      const data: any = fresh.data() || {};

      if (data.finalizedAt) return; // ju≈º zako≈Ñczone
      if (data.processingAt) {
        // kto≈õ ju≈º obrabia ‚Äî nie przerywamy, tylko pozwalamy temu doj≈õƒá do ko≈Ñca
        return;
      }

      tx.set(
        intentRef,
        { processingAt: Date.now(), updatedAt: Date.now() },
        { merge: true }
      );
    });
  } catch (e) {
    // nie przerywamy webhooka ‚Äî zawsze TRUE
    console.warn("[TPAY WEBHOOK] processingAt transaction failed (non-fatal)", e);
  }

  // 3) FAIL
  if (trStatus !== "TRUE") {
    try {
      await markIntentFailed({
        intentId,
        providerTransactionId: trId,
      });
      await intentRef.set(
        { processingAt: null, updatedAt: Date.now() },
        { merge: true }
      );
      console.log("[TPAY WEBHOOK] Marked intent failed:", intentId);
    } catch (e) {
      console.error("[TPAY WEBHOOK] markIntentFailed error", e);
    }
    return tpayOk();
  }

  // 4) PAID -> FINALIZE
  try {
    await finalizePaidIntent({
      intentId,
      providerTransactionId: trId,
    });

    // wyczy≈õƒá processingAt
    await intentRef.set(
      { processingAt: null, updatedAt: Date.now() },
      { merge: true }
    );

    console.log("[TPAY WEBHOOK] Finalized intent:", intentId);
  } catch (e) {
    console.error("[TPAY WEBHOOK] Finalize error", e);

    // nie ko≈Ñczymy FALSE ‚Äî ale warto wyczy≈õciƒá processingAt, by kolejne retry mog≈Ço spr√≥bowaƒá ponownie
    try {
      await intentRef.set(
        { processingAt: null, updatedAt: Date.now() },
        { merge: true }
      );
    } catch {}
  }

  return tpayOk();
}

export async function GET() {
  return new Response("OK", { status: 200 });
}

--- FILE: app/(auth)/register/page.tsx ---
"use client";

import { useMemo, useState } from "react";
import Link from "next/link";
import { useRouter } from "next/navigation";
import { createUserWithEmailAndPassword, updateProfile } from "firebase/auth";
import { auth } from "@/lib/firebase/client";
import type { ChildInput } from "@/types/auth";
import { createParentAndChildren } from "@/services/registration.service";

function emptyChild(): ChildInput {
  return { firstName: "", lastName: "", ageYears: "" };
}

function isEmailLike(v: string) {
  return /\S+@\S+\.\S+/.test(v);
}

export default function RegisterPage() {
  const router = useRouter();

  // Parent fields
  const [firstName, setFirstName] = useState("");
  const [lastName, setLastName] = useState("");

  const [email, setEmail] = useState("");
  const [password, setPassword] = useState("");

  const [phone, setPhone] = useState("");

  const [street, setStreet] = useState("");
  const [houseNumber, setHouseNumber] = useState("");
  const [apartmentNumber, setApartmentNumber] = useState("");

  const [city, setCity] = useState("");
  const [postalCode, setPostalCode] = useState("");

  // Children dynamic
  const [children, setChildren] = useState<ChildInput[]>([emptyChild()]);

  const [pending, setPending] = useState(false);
  const [error, setError] = useState<string | null>(null);

  const canSubmit = useMemo(() => {
    if (!firstName.trim() || !lastName.trim()) return false;
    if (!isEmailLike(email)) return false;
    if (password.length < 6) return false;
    if (!phone.trim()) return false;

    if (
      !street.trim() ||
      !houseNumber.trim() ||
      !city.trim() ||
      !postalCode.trim()
    )
      return false;

    // Minimum 1 dziecko poprawne
    return children.some(
      (c) =>
        c.firstName.trim() &&
        c.lastName.trim() &&
        Number(c.ageYears) > 0
    );
  }, [
    firstName,
    lastName,
    email,
    password,
    phone,
    street,
    houseNumber,
    city,
    postalCode,
    children,
  ]);

  function updateChild(index: number, patch: Partial<ChildInput>) {
    setChildren((prev) =>
      prev.map((c, i) => (i === index ? { ...c, ...patch } : c))
    );
  }

  function addChild() {
    setChildren((prev) => [...prev, emptyChild()]);
  }

  function removeChild(index: number) {
    setChildren((prev) => prev.filter((_, i) => i !== index));
  }

  async function onSubmit(e: React.FormEvent) {
    e.preventDefault();
    setError(null);

    if (!canSubmit) {
      setError("Uzupe≈Çnij wymagane pola (w tym co najmniej 1 dziecko).");
      return;
    }

    setPending(true);

    try {
      // 1) Firebase Auth
      const cred = await createUserWithEmailAndPassword(
        auth,
        email,
        password
      );

      await updateProfile(cred.user, {
        displayName: `${firstName.trim()} ${lastName.trim()}`,
      });

      // 2) Firestore: users + children
      await createParentAndChildren({
        uid: cred.user.uid,
        parent: {
          firstName: firstName.trim(),
          lastName: lastName.trim(),
          email: email.trim().toLowerCase(),
          phone: phone.trim(),

          street: street.trim(),
          houseNumber: houseNumber.trim(),
          apartmentNumber: apartmentNumber.trim() || "",

          city: city.trim(),
          postalCode: postalCode.trim(),

          role: "user",
        },
        children: children.map((c) => ({
          firstName: c.firstName,
          lastName: c.lastName,
          ageYears: c.ageYears === "" ? "" : Number(c.ageYears),
        })),
      });

      router.replace("/dashboard");
    } catch (err: any) {
      const code = err?.code as string | undefined;

      if (code === "auth/email-already-in-use") {
        setError("Ten email jest ju≈º zajƒôty.");
      } else if (code === "auth/weak-password") {
        setError("Has≈Ço jest za s≈Çabe (min. 6 znak√≥w).");
      } else {
        setError(err?.message ?? "B≈ÇƒÖd rejestracji.");
      }
    } finally {
      setPending(false);
    }
  }

  return (
    <div className="space-y-4">
      <h1 className="text-xl font-semibold">Rejestracja rodzica</h1>

      <form onSubmit={onSubmit} className="space-y-6">
        {/* Rodzic */}
        <section className="space-y-3">
          <h2 className="font-medium">Dane rodzica</h2>

          <div className="grid grid-cols-1 gap-3 sm:grid-cols-2">
            <div>
              <label className="text-sm">Imiƒô *</label>
              <input
                className="mt-1 w-full border rounded-lg px-3 py-2"
                value={firstName}
                onChange={(e) => setFirstName(e.target.value)}
                required
              />
            </div>

            <div>
              <label className="text-sm">Nazwisko *</label>
              <input
                className="mt-1 w-full border rounded-lg px-3 py-2"
                value={lastName}
                onChange={(e) => setLastName(e.target.value)}
                required
              />
            </div>
          </div>

          <div>
            <label className="text-sm">Email *</label>
            <input
              className="mt-1 w-full border rounded-lg px-3 py-2"
              value={email}
              onChange={(e) => setEmail(e.target.value)}
              type="email"
              required
            />
          </div>

          <div>
            <label className="text-sm">Has≈Ço *</label>
            <input
              className="mt-1 w-full border rounded-lg px-3 py-2"
              value={password}
              onChange={(e) => setPassword(e.target.value)}
              type="password"
              required
              minLength={6}
            />
            <p className="text-xs text-gray-500 mt-1">
              Minimum 6 znak√≥w.
            </p>
          </div>

          <div>
            <label className="text-sm">Telefon *</label>
            <input
              className="mt-1 w-full border rounded-lg px-3 py-2"
              value={phone}
              onChange={(e) => setPhone(e.target.value)}
              required
            />
          </div>

          <div>
            <label className="text-sm">Ulica *</label>
            <input
              className="mt-1 w-full border rounded-lg px-3 py-2"
              value={street}
              onChange={(e) => setStreet(e.target.value)}
              required
            />
          </div>

          <div>
            <label className="text-sm">Nr domu *</label>
            <input
              className="mt-1 w-full border rounded-lg px-3 py-2"
              value={houseNumber}
              onChange={(e) => setHouseNumber(e.target.value)}
              required
            />
          </div>

          <div>
            <label className="text-sm">
              Nr mieszkania (opcjonalnie)
            </label>
            <input
              className="mt-1 w-full border rounded-lg px-3 py-2"
              value={apartmentNumber}
              onChange={(e) =>
                setApartmentNumber(e.target.value)
              }
            />
          </div>

          <div className="grid grid-cols-1 gap-3 sm:grid-cols-2">
            <div>
              <label className="text-sm">Miasto *</label>
              <input
                className="mt-1 w-full border rounded-lg px-3 py-2"
                value={city}
                onChange={(e) => setCity(e.target.value)}
                required
              />
            </div>

            <div>
              <label className="text-sm">Kod pocztowy *</label>
              <input
                className="mt-1 w-full border rounded-lg px-3 py-2"
                value={postalCode}
                onChange={(e) =>
                  setPostalCode(e.target.value)
                }
                required
              />
            </div>
          </div>
        </section>

        {/* Dzieci */}
        <section className="space-y-3">
          <div className="flex items-center justify-between gap-3">
            <h2 className="font-medium">Dzieci</h2>

            <button
              type="button"
              onClick={addChild}
              className="border rounded-lg px-3 py-2"
            >
              ‚ûï Dodaj dziecko
            </button>
          </div>

          <div className="space-y-3">
            {children.map((child, idx) => (
              <div
                key={idx}
                className="border rounded-xl p-4 space-y-3"
              >
                <div className="flex items-center justify-between">
                  <p className="font-medium">
                    Dziecko {idx + 1}
                  </p>

                  {children.length > 1 && (
                    <button
                      type="button"
                      onClick={() => removeChild(idx)}
                      className="text-sm underline"
                    >
                      Usu≈Ñ
                    </button>
                  )}
                </div>

                <div className="grid grid-cols-1 gap-3 sm:grid-cols-3">
                  <div>
                    <label className="text-sm">Imiƒô *</label>
                    <input
                      className="mt-1 w-full border rounded-lg px-3 py-2"
                      value={child.firstName}
                      onChange={(e) =>
                        updateChild(idx, {
                          firstName: e.target.value,
                        })
                      }
                      required={idx === 0}
                    />
                  </div>

                  <div>
                    <label className="text-sm">Nazwisko *</label>
                    <input
                      className="mt-1 w-full border rounded-lg px-3 py-2"
                      value={child.lastName}
                      onChange={(e) =>
                        updateChild(idx, {
                          lastName: e.target.value,
                        })
                      }
                      required={idx === 0}
                    />
                  </div>

                  <div>
                    <label className="text-sm">
                      Wiek (lata) *
                    </label>
                    <input
                      className="mt-1 w-full border rounded-lg px-3 py-2"
                      value={child.ageYears}
                      onChange={(e) =>
                        updateChild(idx, {
                          ageYears:
                            e.target.value === ""
                              ? ""
                              : Number(e.target.value),
                        })
                      }
                      type="number"
                      min={1}
                      max={25}
                      required={idx === 0}
                    />
                  </div>
                </div>

                <p className="text-xs text-gray-500">
                  Wymagane jest co najmniej jedno dziecko.
                </p>
              </div>
            ))}
          </div>
        </section>

        {error && (
          <div className="rounded-lg bg-red-50 border border-red-200 text-red-700 text-sm p-3">
            {error}
          </div>
        )}

        <button
          disabled={pending}
          className="w-full rounded-lg bg-black text-white py-2 hover:opacity-90 transition disabled:opacity-60"
          type="submit"
        >
          {pending ? "Tworzƒô konto..." : "Utw√≥rz konto"}
        </button>
      </form>

      <p className="text-sm text-center">
        Masz konto?{" "}
        <Link className="underline" href="/login">
          Zaloguj siƒô
        </Link>
      </p>
    </div>
  );
}

--- FILE: app/(auth)/layout.tsx ---
export default function AuthLayout({ children }: { children: React.ReactNode }) {
  return (
    <main className="min-h-screen grid place-items-center p-6">
      <div className="w-full max-w-md border rounded-xl p-6">
        {children}
      </div>
    </main>
  );
}

--- FILE: app/(auth)/complete-profile/page.tsx ---
"use client";

import { useEffect } from "react";
import { useRouter } from "next/navigation";
import { useAuth } from "@/components/auth/AuthProvider";
import { ParentProfileForm } from "@/components/profile/ParentProfileForm";
import type { ParentFormData } from "@/types/profile";
import { createParentAndChildren } from "@/services/registration.service";
import { Alert, AlertDescription, AlertTitle } from "@/components/ui/alert";
import { AlertTriangleIcon } from "lucide-react"

export default function CompleteProfilePage() {
  const { user } = useAuth();
  const router = useRouter();

  if (!user) return null;

  const [firstName = "", lastName = ""] = user.displayName?.split(" ") ?? [];

  const initialValues: ParentFormData = {
    firstName,
    lastName,
    email: user.email ?? "",
    phone: "",

    street: "",
    houseNumber: "",
    apartmentNumber: "",
    postalCode: "",
    city: "",

    children: [{ firstName: "", lastName: "", ageYears: "" }],
};


  async function handleSubmit(data: ParentFormData) {
    await createParentAndChildren({
      uid: user!.uid,
      parent: {
        ...data,
        role: "user",
      },
      children: data.children,
    });

    router.replace("/dashboard");
  }

  return (
    <div className="max-w-2xl mx-auto p-6 space-y-4">
      <h1 className="text-xl font-semibold">Uzupe≈Çnij profil</h1>
      <Alert className="max-w-md border-amber-200 bg-amber-50 text-amber-900 dark:border-amber-900 dark:bg-amber-950 dark:text-amber-50">
        <AlertTriangleIcon />
        <AlertTitle>Uzupe≈Çnij dane</AlertTitle>
        <AlertDescription>
          Aby korzystaƒá z aplikacji, uzupe≈Çnij dane kontaktowe i dane dzieci.
        </AlertDescription>
      </Alert>
      <ParentProfileForm
        initialValues={initialValues}
        mode="complete"
        submitLabel="Zapisz profil"
        onSubmit={handleSubmit}
      />
    </div>
  );
}

--- FILE: app/(auth)/login/page.tsx ---
"use client";

import { useState } from "react";
import Image from "next/image";
import Link from "next/link";
import { useRouter, useSearchParams } from "next/navigation";
import {
  GoogleAuthProvider,
  signInWithEmailAndPassword,
  signInWithPopup,
} from "firebase/auth";
import { auth } from "@/lib/firebase/client";

function mapFirebaseError(code?: string) {
  switch (code) {
    case "auth/user-not-found":
      return "Nie znaleziono konta z tym adresem email.";
    case "auth/wrong-password":
    case "auth/invalid-credential":
      return "Nieprawid≈Çowy email lub has≈Ço.";
    case "auth/too-many-requests":
      return "Zbyt wiele pr√≥b logowania. Spr√≥buj ponownie p√≥≈∫niej.";
    case "auth/popup-closed-by-user":
      return "Okno logowania zosta≈Ço zamkniƒôte.";
    default:
      return "WystƒÖpi≈Ç b≈ÇƒÖd podczas logowania.";
  }
}

export default function LoginPage() {
  const router = useRouter();
  const search = useSearchParams();
  const next = search.get("next") || "/dashboard";

  const [email, setEmail] = useState("");
  const [password, setPassword] = useState("");
  const [pending, setPending] = useState(false);
  const [error, setError] = useState<string | null>(null);

  async function handleEmailLogin(e: React.FormEvent) {
    e.preventDefault();
    setPending(true);
    setError(null);

    try {
      await signInWithEmailAndPassword(auth, email, password);
      router.replace(next);
    } catch (err: any) {
      setError(mapFirebaseError(err?.code));
    } finally {
      setPending(false);
    }
  }

  async function handleGoogleLogin() {
    setPending(true);
    setError(null);

    try {
      const provider = new GoogleAuthProvider();
      await signInWithPopup(auth, provider);
      router.replace(next);
    } catch (err: any) {
      setError(mapFirebaseError(err?.code));
    } finally {
      setPending(false);
    }
  }

  return (
    <div className="space-y-6">
      {/* Logo */}
      <div className="flex flex-col items-center gap-2">
        <Image
          src="/logo.png"
          alt="Logo"
          width={640}
          height={640}
          priority
        />
        <h1 className="text-2xl font-semibold">Zaloguj siƒô</h1>
        <p className="text-sm text-gray-500">
          Dostƒôp do panelu u≈ºytkownika
        </p>
      </div>

      {/* Google */}
      <button
        onClick={handleGoogleLogin}
        disabled={pending}
        className="w-full flex items-center justify-center gap-3 border rounded-lg px-4 py-2 hover:bg-gray-50 transition"
      >
        <Image src="/google.svg" alt="Google" width={20} height={20} />
        Zaloguj siƒô przez Google
      </button>

      <div className="flex items-center gap-3">
        <div className="flex-1 h-px bg-gray-200" />
        <span className="text-xs text-gray-400">lub</span>
        <div className="flex-1 h-px bg-gray-200" />
      </div>

      {/* Formularz */}
      <form onSubmit={handleEmailLogin} className="space-y-4">
        <div>
          <label className="text-sm">Email</label>
          <input
            className="mt-1 w-full border rounded-lg px-3 py-2 focus:outline-none focus:ring"
            value={email}
            onChange={(e) => setEmail(e.target.value)}
            type="email"
            required
          />
        </div>

        <div>
          <label className="text-sm">Has≈Ço</label>
          <input
            className="mt-1 w-full border rounded-lg px-3 py-2 focus:outline-none focus:ring"
            value={password}
            onChange={(e) => setPassword(e.target.value)}
            type="password"
            required
          />
        </div>

        {error && (
          <div className="rounded-lg bg-red-50 border border-red-200 text-red-700 text-sm p-3">
            {error}
          </div>
        )}

        <button
          disabled={pending}
          className="w-full rounded-lg bg-black text-white py-2 hover:opacity-90 transition"
        >
          {pending ? "Logowanie..." : "Zaloguj siƒô"}
        </button>
      </form>

      <p className="text-sm text-center">
        Nie masz konta?{" "}
        <Link href="/register" className="underline">
          Zarejestruj siƒô
        </Link>
      </p>
    </div>
  );
}

--- FILE: app/(dashboard)/dashboard/payments/page.tsx ---
"use client";

import { useState } from "react";
import { Tabs, TabsContent, TabsList, TabsTrigger } from "@/components/ui/tabs";
import { Button } from "@/components/ui/button";
import { RefreshCw } from "lucide-react";

import { CreditsByChildPanel } from "@/components/billing/CreditsByChildPanel";
import { OrdersList } from "@/components/billing/OrdersList";

export default function PaymentsPage() {
  const [refreshTick, setRefreshTick] = useState(0);

  return (
    <div className="p-6 space-y-4">
      <div className="flex items-center justify-between gap-3">
        <h1 className="text-2xl font-semibold">P≈Çatno≈õci</h1>

        <Button variant="outline" onClick={() => setRefreshTick((x) => x + 1)}>
          <RefreshCw className="w-4 h-4 mr-2" />
          Od≈õwie≈º
        </Button>
      </div>

      <Tabs defaultValue="credits" className="w-full">
        <TabsList>
          <TabsTrigger value="credits">Kredyty i subskrypcje</TabsTrigger>
          <TabsTrigger value="orders">Zam√≥wienia</TabsTrigger>
        </TabsList>

        <TabsContent value="credits" className="mt-4">
          <CreditsByChildPanel refreshTick={refreshTick} />
        </TabsContent>

        <TabsContent value="orders" className="mt-4">
          <OrdersList refreshTick={refreshTick} />
        </TabsContent>
      </Tabs>
    </div>
  );
}
--- FILE: app/(dashboard)/dashboard/classes/page.tsx ---
"use client";

import { useCallback, useState } from "react";
import { PaymentReturnBanner } from "@/components/classes/PaymentReturnBanner";
import { ClassesTabs } from "@/components/user-classes/ClassesTabs";

export default function ClassesPage() {
  const [refreshTick, setRefreshTick] = useState(0);

  const handleFinalized = useCallback(() => {
    setRefreshTick((x) => x + 1);
  }, []);

  return (
    <div className="p-6">
      <h1 className="text-2xl font-semibold mb-4">Zajƒôcia</h1>

      {/* Banner mo≈ºe oznaczaƒá ‚Äúp≈Çatno≈õƒá zako≈Ñczona‚Äù i wtedy od≈õwie≈ºasz UI */}
      <PaymentReturnBanner onFinalized={handleFinalized} />

      <ClassesTabs refreshTick={refreshTick} />
    </div>
  );
}

--- FILE: app/(dashboard)/dashboard/profile/page.tsx ---
"use client";

import { useEffect, useState } from "react";
import { useAuth } from "@/components/auth/AuthProvider";
import { ParentProfileForm } from "@/components/profile/ParentProfileForm";
import type { ParentFormData } from "@/types/profile";
import {
  getUserProfile,
  updateUserProfile,
} from "@/services/profile.service";

export default function ProfilePage() {
  const { user } = useAuth();
  const [initialValues, setInitialValues] =
    useState<ParentFormData | null>(null);

  const [loading, setLoading] = useState(true);

  useEffect(() => {
    if (!user) return;

    getUserProfile(user.uid)
      .then(setInitialValues)
      .finally(() => setLoading(false));
  }, [user]);

  if (loading) {
    return <div className="p-6">≈Åadowanie profilu...</div>;
  }

  if (!initialValues) {
    return <div className="p-6">Nie znaleziono profilu.</div>;
  }

  return (
    <div className="max-w-3xl mx-auto p-6 space-y-4">
      <h1 className="text-xl font-semibold">Edytuj dane profilu</h1>

     <ParentProfileForm
        initialValues={initialValues}
        mode="edit"
        submitLabel="Zapisz zmiany"
        onSubmit={async (data) => {
          if (!user) return;
          await updateUserProfile(user.uid, data);

          // üî• refetch, ≈ºeby pobraƒá dzieci ju≈º z id i nie robiƒá duplikat√≥w przy kolejnym zapisie
          const fresh = await getUserProfile(user.uid);
          setInitialValues(fresh);
        }}
      />

    </div>
  );
}

--- FILE: app/(dashboard)/dashboard/children/page.tsx ---
export default function ChildrenPage() {
  return (
    <div className="p-6">
      <h1 className="text-2xl font-semibold mb-4">Moje dzieci</h1>
      <p>Tu bƒôdzie zarzƒÖdzanie dzieƒámi üë∂</p>
    </div>
  );
}
--- FILE: app/(dashboard)/dashboard/page.tsx ---
"use client";

import { signOut } from "firebase/auth";
import { auth } from "@/lib/firebase/client";
import { useAuth } from "@/components/auth/AuthProvider";
import Link from "next/link";
import { Button } from "@/components/ui/button";

export default function DashboardPage() {
  const { user } = useAuth();

  return (
    <main className="p-8 space-y-4">
      <h1 className="text-2xl font-semibold">Dashboard</h1>

      <div className="border rounded-xl p-4 space-y-2">
        <p className="text-sm">Zalogowany jako:</p>
        <p className="font-medium">{user?.displayName || user?.email}</p>
      </div>

      <Link href="/dashboard/profile">
        <Button variant="outline">‚úèÔ∏è Edytuj dane</Button>
      </Link>

      <button className="border rounded-md px-3 py-2" onClick={() => signOut(auth)}>
        Wyloguj
      </button>
    </main>
  );
}

--- FILE: app/(dashboard)/layout.tsx ---
import { DashboardLayout } from "@/components/dashboard/DashboardLayout";
import { AuthGate } from "@/components/auth/AuthGate";

export default function Layout({
  children,
}: {
  children: React.ReactNode;
}) {
  return (
    <AuthGate>
      <DashboardLayout>{children}</DashboardLayout>
    </AuthGate>
  );
}

--- FILE: app/page.tsx ---
import Link from "next/link";

export default function HomePage() {
  return (
    <main className="p-8 space-y-4">
      <h1 className="text-2xl font-semibold">Platforma</h1>
      <p>Publiczna strona g≈Ç√≥wna.</p>

      <div className="flex gap-3">
        <Link className="underline" href="/login">Logowanie</Link>
        <Link className="underline" href="/register">Rejestracja</Link>
        <Link className="underline" href="/dashboard">Dashboard</Link>
      </div>
    </main>
  );
}

--- FILE: app/globals.css ---
@import "tailwindcss";
@import "tw-animate-css";

@custom-variant dark (&:is(.dark *));

@theme inline {
  --color-background: var(--background);
  --color-foreground: var(--foreground);
  --font-sans: var(--font-geist-sans);
  --font-mono: var(--font-geist-mono);
  --color-sidebar-ring: var(--sidebar-ring);
  --color-sidebar-border: var(--sidebar-border);
  --color-sidebar-accent-foreground: var(--sidebar-accent-foreground);
  --color-sidebar-accent: var(--sidebar-accent);
  --color-sidebar-primary-foreground: var(--sidebar-primary-foreground);
  --color-sidebar-primary: var(--sidebar-primary);
  --color-sidebar-foreground: var(--sidebar-foreground);
  --color-sidebar: var(--sidebar);
  --color-chart-5: var(--chart-5);
  --color-chart-4: var(--chart-4);
  --color-chart-3: var(--chart-3);
  --color-chart-2: var(--chart-2);
  --color-chart-1: var(--chart-1);
  --color-ring: var(--ring);
  --color-input: var(--input);
  --color-border: var(--border);
  --color-destructive: var(--destructive);
  --color-accent-foreground: var(--accent-foreground);
  --color-accent: var(--accent);
  --color-muted-foreground: var(--muted-foreground);
  --color-muted: var(--muted);
  --color-secondary-foreground: var(--secondary-foreground);
  --color-secondary: var(--secondary);
  --color-primary-foreground: var(--primary-foreground);
  --color-primary: var(--primary);
  --color-popover-foreground: var(--popover-foreground);
  --color-popover: var(--popover);
  --color-card-foreground: var(--card-foreground);
  --color-card: var(--card);
  --radius-sm: calc(var(--radius) - 4px);
  --radius-md: calc(var(--radius) - 2px);
  --radius-lg: var(--radius);
  --radius-xl: calc(var(--radius) + 4px);
  --radius-2xl: calc(var(--radius) + 8px);
  --radius-3xl: calc(var(--radius) + 12px);
  --radius-4xl: calc(var(--radius) + 16px);
}
.input {
  @apply w-full border rounded-lg px-3 py-2 focus:outline-none focus:ring;
}

.btn-primary {
  @apply w-full rounded-lg bg-black text-white py-2 hover:opacity-90 transition disabled:opacity-60;
}

.btn-secondary {
  @apply border rounded-lg px-3 py-2 hover:bg-gray-50;
}
@keyframes shake {
  0% { transform: translateX(0); }
  25% { transform: translateX(-2px); }
  50% { transform: translateX(2px); }
  75% { transform: translateX(-2px); }
  100% { transform: translateX(0); }
}

.input.border-red-500 {
  animation: shake 0.2s ease-in-out;
}

:root {
  --radius: 0.625rem;
  --background: oklch(1 0 0);
  --foreground: oklch(0.145 0 0);
  --card: oklch(1 0 0);
  --card-foreground: oklch(0.145 0 0);
  --popover: oklch(1 0 0);
  --popover-foreground: oklch(0.145 0 0);
  --primary: oklch(0.205 0 0);
  --primary-foreground: oklch(0.985 0 0);
  --secondary: oklch(0.97 0 0);
  --secondary-foreground: oklch(0.205 0 0);
  --muted: oklch(0.97 0 0);
  --muted-foreground: oklch(0.556 0 0);
  --accent: oklch(0.97 0 0);
  --accent-foreground: oklch(0.205 0 0);
  --destructive: oklch(0.577 0.245 27.325);
  --border: oklch(0.922 0 0);
  --input: oklch(0.922 0 0);
  --ring: oklch(0.708 0 0);
  --chart-1: oklch(0.646 0.222 41.116);
  --chart-2: oklch(0.6 0.118 184.704);
  --chart-3: oklch(0.398 0.07 227.392);
  --chart-4: oklch(0.828 0.189 84.429);
  --chart-5: oklch(0.769 0.188 70.08);
  --sidebar: oklch(0.985 0 0);
  --sidebar-foreground: oklch(0.145 0 0);
  --sidebar-primary: oklch(0.205 0 0);
  --sidebar-primary-foreground: oklch(0.985 0 0);
  --sidebar-accent: oklch(0.97 0 0);
  --sidebar-accent-foreground: oklch(0.205 0 0);
  --sidebar-border: oklch(0.922 0 0);
  --sidebar-ring: oklch(0.708 0 0);
}

.dark {
  --background: oklch(0.145 0 0);
  --foreground: oklch(0.985 0 0);
  --card: oklch(0.205 0 0);
  --card-foreground: oklch(0.985 0 0);
  --popover: oklch(0.205 0 0);
  --popover-foreground: oklch(0.985 0 0);
  --primary: oklch(0.922 0 0);
  --primary-foreground: oklch(0.205 0 0);
  --secondary: oklch(0.269 0 0);
  --secondary-foreground: oklch(0.985 0 0);
  --muted: oklch(0.269 0 0);
  --muted-foreground: oklch(0.708 0 0);
  --accent: oklch(0.269 0 0);
  --accent-foreground: oklch(0.985 0 0);
  --destructive: oklch(0.704 0.191 22.216);
  --border: oklch(1 0 0 / 10%);
  --input: oklch(1 0 0 / 15%);
  --ring: oklch(0.556 0 0);
  --chart-1: oklch(0.488 0.243 264.376);
  --chart-2: oklch(0.696 0.17 162.48);
  --chart-3: oklch(0.769 0.188 70.08);
  --chart-4: oklch(0.627 0.265 303.9);
  --chart-5: oklch(0.645 0.246 16.439);
  --sidebar: oklch(0.205 0 0);
  --sidebar-foreground: oklch(0.985 0 0);
  --sidebar-primary: oklch(0.488 0.243 264.376);
  --sidebar-primary-foreground: oklch(0.985 0 0);
  --sidebar-accent: oklch(0.269 0 0);
  --sidebar-accent-foreground: oklch(0.985 0 0);
  --sidebar-border: oklch(1 0 0 / 10%);
  --sidebar-ring: oklch(0.556 0 0);
}

@layer base {
  * {
    @apply border-border outline-ring/50;
  }
  body {
    @apply bg-background text-foreground;
  }
}


=== components ===

--- FILE: components/ui/alert-dialog.tsx ---
"use client"

import * as React from "react"
import * as AlertDialogPrimitive from "@radix-ui/react-alert-dialog"

import { cn } from "@/lib/utils"
import { Button } from "@/components/ui/button"

function AlertDialog({
  ...props
}: React.ComponentProps<typeof AlertDialogPrimitive.Root>) {
  return <AlertDialogPrimitive.Root data-slot="alert-dialog" {...props} />
}

function AlertDialogTrigger({
  ...props
}: React.ComponentProps<typeof AlertDialogPrimitive.Trigger>) {
  return (
    <AlertDialogPrimitive.Trigger data-slot="alert-dialog-trigger" {...props} />
  )
}

function AlertDialogPortal({
  ...props
}: React.ComponentProps<typeof AlertDialogPrimitive.Portal>) {
  return (
    <AlertDialogPrimitive.Portal data-slot="alert-dialog-portal" {...props} />
  )
}

function AlertDialogOverlay({
  className,
  ...props
}: React.ComponentProps<typeof AlertDialogPrimitive.Overlay>) {
  return (
    <AlertDialogPrimitive.Overlay
      data-slot="alert-dialog-overlay"
      className={cn(
        "data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 fixed inset-0 z-50 bg-black/50",
        className
      )}
      {...props}
    />
  )
}

function AlertDialogContent({
  className,
  size = "default",
  ...props
}: React.ComponentProps<typeof AlertDialogPrimitive.Content> & {
  size?: "default" | "sm"
}) {
  return (
    <AlertDialogPortal>
      <AlertDialogOverlay />
      <AlertDialogPrimitive.Content
        data-slot="alert-dialog-content"
        data-size={size}
        className={cn(
          "bg-background data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 group/alert-dialog-content fixed top-[50%] left-[50%] z-50 grid w-full max-w-[calc(100%-2rem)] translate-x-[-50%] translate-y-[-50%] gap-4 rounded-lg border p-6 shadow-lg duration-200 data-[size=sm]:max-w-xs data-[size=default]:sm:max-w-lg",
          className
        )}
        {...props}
      />
    </AlertDialogPortal>
  )
}

function AlertDialogHeader({
  className,
  ...props
}: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="alert-dialog-header"
      className={cn(
        "grid grid-rows-[auto_1fr] place-items-center gap-1.5 text-center has-data-[slot=alert-dialog-media]:grid-rows-[auto_auto_1fr] has-data-[slot=alert-dialog-media]:gap-x-6 sm:group-data-[size=default]/alert-dialog-content:place-items-start sm:group-data-[size=default]/alert-dialog-content:text-left sm:group-data-[size=default]/alert-dialog-content:has-data-[slot=alert-dialog-media]:grid-rows-[auto_1fr]",
        className
      )}
      {...props}
    />
  )
}

function AlertDialogFooter({
  className,
  ...props
}: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="alert-dialog-footer"
      className={cn(
        "flex flex-col-reverse gap-2 group-data-[size=sm]/alert-dialog-content:grid group-data-[size=sm]/alert-dialog-content:grid-cols-2 sm:flex-row sm:justify-end",
        className
      )}
      {...props}
    />
  )
}

function AlertDialogTitle({
  className,
  ...props
}: React.ComponentProps<typeof AlertDialogPrimitive.Title>) {
  return (
    <AlertDialogPrimitive.Title
      data-slot="alert-dialog-title"
      className={cn(
        "text-lg font-semibold sm:group-data-[size=default]/alert-dialog-content:group-has-data-[slot=alert-dialog-media]/alert-dialog-content:col-start-2",
        className
      )}
      {...props}
    />
  )
}

function AlertDialogDescription({
  className,
  ...props
}: React.ComponentProps<typeof AlertDialogPrimitive.Description>) {
  return (
    <AlertDialogPrimitive.Description
      data-slot="alert-dialog-description"
      className={cn("text-muted-foreground text-sm", className)}
      {...props}
    />
  )
}

function AlertDialogMedia({
  className,
  ...props
}: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="alert-dialog-media"
      className={cn(
        "bg-muted mb-2 inline-flex size-16 items-center justify-center rounded-md sm:group-data-[size=default]/alert-dialog-content:row-span-2 *:[svg:not([class*='size-'])]:size-8",
        className
      )}
      {...props}
    />
  )
}

function AlertDialogAction({
  className,
  variant = "default",
  size = "default",
  ...props
}: React.ComponentProps<typeof AlertDialogPrimitive.Action> &
  Pick<React.ComponentProps<typeof Button>, "variant" | "size">) {
  return (
    <Button variant={variant} size={size} asChild>
      <AlertDialogPrimitive.Action
        data-slot="alert-dialog-action"
        className={cn(className)}
        {...props}
      />
    </Button>
  )
}

function AlertDialogCancel({
  className,
  variant = "outline",
  size = "default",
  ...props
}: React.ComponentProps<typeof AlertDialogPrimitive.Cancel> &
  Pick<React.ComponentProps<typeof Button>, "variant" | "size">) {
  return (
    <Button variant={variant} size={size} asChild>
      <AlertDialogPrimitive.Cancel
        data-slot="alert-dialog-cancel"
        className={cn(className)}
        {...props}
      />
    </Button>
  )
}

export {
  AlertDialog,
  AlertDialogAction,
  AlertDialogCancel,
  AlertDialogContent,
  AlertDialogDescription,
  AlertDialogFooter,
  AlertDialogHeader,
  AlertDialogMedia,
  AlertDialogOverlay,
  AlertDialogPortal,
  AlertDialogTitle,
  AlertDialogTrigger,
}

--- FILE: components/ui/tabs.tsx ---
"use client"

import * as React from "react"
import * as TabsPrimitive from "@radix-ui/react-tabs"
import { cva, type VariantProps } from "class-variance-authority"

import { cn } from "@/lib/utils"

function Tabs({
  className,
  orientation = "horizontal",
  ...props
}: React.ComponentProps<typeof TabsPrimitive.Root>) {
  return (
    <TabsPrimitive.Root
      data-slot="tabs"
      data-orientation={orientation}
      orientation={orientation}
      className={cn(
        "group/tabs flex gap-2 data-[orientation=horizontal]:flex-col",
        className
      )}
      {...props}
    />
  )
}

const tabsListVariants = cva(
  "rounded-lg p-[3px] group-data-[orientation=horizontal]/tabs:h-9 data-[variant=line]:rounded-none group/tabs-list text-muted-foreground inline-flex w-fit items-center justify-center group-data-[orientation=vertical]/tabs:h-fit group-data-[orientation=vertical]/tabs:flex-col",
  {
    variants: {
      variant: {
        default: "bg-muted",
        line: "gap-1 bg-transparent",
      },
    },
    defaultVariants: {
      variant: "default",
    },
  }
)

function TabsList({
  className,
  variant = "default",
  ...props
}: React.ComponentProps<typeof TabsPrimitive.List> &
  VariantProps<typeof tabsListVariants>) {
  return (
    <TabsPrimitive.List
      data-slot="tabs-list"
      data-variant={variant}
      className={cn(tabsListVariants({ variant }), className)}
      {...props}
    />
  )
}

function TabsTrigger({
  className,
  ...props
}: React.ComponentProps<typeof TabsPrimitive.Trigger>) {
  return (
    <TabsPrimitive.Trigger
      data-slot="tabs-trigger"
      className={cn(
        "focus-visible:border-ring focus-visible:ring-ring/50 focus-visible:outline-ring text-foreground/60 hover:text-foreground dark:text-muted-foreground dark:hover:text-foreground relative inline-flex h-[calc(100%-1px)] flex-1 items-center justify-center gap-1.5 rounded-md border border-transparent px-2 py-1 text-sm font-medium whitespace-nowrap transition-all group-data-[orientation=vertical]/tabs:w-full group-data-[orientation=vertical]/tabs:justify-start focus-visible:ring-[3px] focus-visible:outline-1 disabled:pointer-events-none disabled:opacity-50 group-data-[variant=default]/tabs-list:data-[state=active]:shadow-sm group-data-[variant=line]/tabs-list:data-[state=active]:shadow-none [&_svg]:pointer-events-none [&_svg]:shrink-0 [&_svg:not([class*='size-'])]:size-4",
        "group-data-[variant=line]/tabs-list:bg-transparent group-data-[variant=line]/tabs-list:data-[state=active]:bg-transparent dark:group-data-[variant=line]/tabs-list:data-[state=active]:border-transparent dark:group-data-[variant=line]/tabs-list:data-[state=active]:bg-transparent",
        "data-[state=active]:bg-background dark:data-[state=active]:text-foreground dark:data-[state=active]:border-input dark:data-[state=active]:bg-input/30 data-[state=active]:text-foreground",
        "after:bg-foreground after:absolute after:opacity-0 after:transition-opacity group-data-[orientation=horizontal]/tabs:after:inset-x-0 group-data-[orientation=horizontal]/tabs:after:bottom-[-5px] group-data-[orientation=horizontal]/tabs:after:h-0.5 group-data-[orientation=vertical]/tabs:after:inset-y-0 group-data-[orientation=vertical]/tabs:after:-right-1 group-data-[orientation=vertical]/tabs:after:w-0.5 group-data-[variant=line]/tabs-list:data-[state=active]:after:opacity-100",
        className
      )}
      {...props}
    />
  )
}

function TabsContent({
  className,
  ...props
}: React.ComponentProps<typeof TabsPrimitive.Content>) {
  return (
    <TabsPrimitive.Content
      data-slot="tabs-content"
      className={cn("flex-1 outline-none", className)}
      {...props}
    />
  )
}

export { Tabs, TabsList, TabsTrigger, TabsContent, tabsListVariants }

--- FILE: components/ui/card.tsx ---
import * as React from "react"

import { cn } from "@/lib/utils"

function Card({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="card"
      className={cn(
        "bg-card text-card-foreground flex flex-col gap-6 rounded-xl border py-6 shadow-sm",
        className
      )}
      {...props}
    />
  )
}

function CardHeader({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="card-header"
      className={cn(
        "@container/card-header grid auto-rows-min grid-rows-[auto_auto] items-start gap-2 px-6 has-data-[slot=card-action]:grid-cols-[1fr_auto] [.border-b]:pb-6",
        className
      )}
      {...props}
    />
  )
}

function CardTitle({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="card-title"
      className={cn("leading-none font-semibold", className)}
      {...props}
    />
  )
}

function CardDescription({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="card-description"
      className={cn("text-muted-foreground text-sm", className)}
      {...props}
    />
  )
}

function CardAction({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="card-action"
      className={cn(
        "col-start-2 row-span-2 row-start-1 self-start justify-self-end",
        className
      )}
      {...props}
    />
  )
}

function CardContent({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="card-content"
      className={cn("px-6", className)}
      {...props}
    />
  )
}

function CardFooter({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="card-footer"
      className={cn("flex items-center px-6 [.border-t]:pt-6", className)}
      {...props}
    />
  )
}

export {
  Card,
  CardHeader,
  CardFooter,
  CardTitle,
  CardAction,
  CardDescription,
  CardContent,
}

--- FILE: components/ui/popover.tsx ---
"use client"

import * as React from "react"
import * as PopoverPrimitive from "@radix-ui/react-popover"

import { cn } from "@/lib/utils"

function Popover({
  ...props
}: React.ComponentProps<typeof PopoverPrimitive.Root>) {
  return <PopoverPrimitive.Root data-slot="popover" {...props} />
}

function PopoverTrigger({
  ...props
}: React.ComponentProps<typeof PopoverPrimitive.Trigger>) {
  return <PopoverPrimitive.Trigger data-slot="popover-trigger" {...props} />
}

function PopoverContent({
  className,
  align = "center",
  sideOffset = 4,
  ...props
}: React.ComponentProps<typeof PopoverPrimitive.Content>) {
  return (
    <PopoverPrimitive.Portal>
      <PopoverPrimitive.Content
        data-slot="popover-content"
        align={align}
        sideOffset={sideOffset}
        className={cn(
          "bg-popover text-popover-foreground data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 z-50 w-72 origin-(--radix-popover-content-transform-origin) rounded-md border p-4 shadow-md outline-hidden",
          className
        )}
        {...props}
      />
    </PopoverPrimitive.Portal>
  )
}

function PopoverAnchor({
  ...props
}: React.ComponentProps<typeof PopoverPrimitive.Anchor>) {
  return <PopoverPrimitive.Anchor data-slot="popover-anchor" {...props} />
}

function PopoverHeader({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="popover-header"
      className={cn("flex flex-col gap-1 text-sm", className)}
      {...props}
    />
  )
}

function PopoverTitle({ className, ...props }: React.ComponentProps<"h2">) {
  return (
    <div
      data-slot="popover-title"
      className={cn("font-medium", className)}
      {...props}
    />
  )
}

function PopoverDescription({
  className,
  ...props
}: React.ComponentProps<"p">) {
  return (
    <p
      data-slot="popover-description"
      className={cn("text-muted-foreground", className)}
      {...props}
    />
  )
}

export {
  Popover,
  PopoverTrigger,
  PopoverContent,
  PopoverAnchor,
  PopoverHeader,
  PopoverTitle,
  PopoverDescription,
}

--- FILE: components/ui/progress.tsx ---
"use client"

import * as React from "react"
import { Progress as ProgressPrimitive } from "radix-ui"

import { cn } from "@/lib/utils"

function Progress({
  className,
  value,
  ...props
}: React.ComponentProps<typeof ProgressPrimitive.Root>) {
  return (
    <ProgressPrimitive.Root
      data-slot="progress"
      className={cn(
        "bg-primary/20 relative h-2 w-full overflow-hidden rounded-full",
        className
      )}
      {...props}
    >
      <ProgressPrimitive.Indicator
        data-slot="progress-indicator"
        className="bg-primary h-full w-full flex-1 transition-all"
        style={{ transform: `translateX(-${100 - (value || 0)}%)` }}
      />
    </ProgressPrimitive.Root>
  )
}

export { Progress }

--- FILE: components/ui/ConfirmModal.tsx ---
"use client";

type Props = {
  open: boolean;
  title: string;
  description: string;
  confirmLabel?: string;
  cancelLabel?: string;
  onConfirm(): void;
  onCancel(): void;
};

export function ConfirmModal({
  open,
  title,
  description,
  confirmLabel = "Kontynuuj",
  cancelLabel = "Wr√≥ƒá",
  onConfirm,
  onCancel,
}: Props) {
  if (!open) return null;

  return (
    <div className="fixed inset-0 z-50 bg-black/40 flex items-center justify-center">
      <div className="bg-white rounded-xl shadow-xl max-w-md w-full p-6 space-y-4 animate-in fade-in zoom-in">
        <h2 className="text-lg font-semibold">{title}</h2>
        <p className="text-sm text-gray-600">{description}</p>

        <div className="flex justify-end gap-3 pt-2">
          <button
            onClick={onCancel}
            className="px-4 py-2 rounded-lg border hover:bg-gray-50"
          >
            {cancelLabel}
          </button>

          <button
            onClick={onConfirm}
            className="px-4 py-2 rounded-lg bg-black text-white hover:opacity-90"
          >
            {confirmLabel}
          </button>
        </div>
      </div>
    </div>
  );
}

--- FILE: components/ui/alert.tsx ---
import * as React from "react"
import { cva, type VariantProps } from "class-variance-authority"

import { cn } from "@/lib/utils"

const alertVariants = cva(
  "relative w-full rounded-lg border px-4 py-3 text-sm grid has-[>svg]:grid-cols-[calc(var(--spacing)*4)_1fr] grid-cols-[0_1fr] has-[>svg]:gap-x-3 gap-y-0.5 items-start [&>svg]:size-4 [&>svg]:translate-y-0.5 [&>svg]:text-current",
  {
    variants: {
      variant: {
        default: "bg-card text-card-foreground",
        destructive:
          "text-destructive bg-card [&>svg]:text-current *:data-[slot=alert-description]:text-destructive/90",
      },
    },
    defaultVariants: {
      variant: "default",
    },
  }
)

function Alert({
  className,
  variant,
  ...props
}: React.ComponentProps<"div"> & VariantProps<typeof alertVariants>) {
  return (
    <div
      data-slot="alert"
      role="alert"
      className={cn(alertVariants({ variant }), className)}
      {...props}
    />
  )
}

function AlertTitle({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="alert-title"
      className={cn(
        "col-start-2 line-clamp-1 min-h-4 font-medium tracking-tight",
        className
      )}
      {...props}
    />
  )
}

function AlertDescription({
  className,
  ...props
}: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="alert-description"
      className={cn(
        "text-muted-foreground col-start-2 grid justify-items-start gap-1 text-sm [&_p]:leading-relaxed",
        className
      )}
      {...props}
    />
  )
}

export { Alert, AlertTitle, AlertDescription }

--- FILE: components/ui/NumberField.tsx ---
"use client";

import { FieldError } from "./FieldError";

type Props = {
  value: number | "";
  placeholder?: string;
  min?: number;
  error?: string;
  touched?: boolean;
  onChange(value: number | ""): void;
  onBlur(): void;
};

export function NumberField({
  value,
  placeholder,
  min,
  error,
  touched,
  onChange,
  onBlur,
}: Props) {
  return (
    <div>
      <input
        type="number"
        min={min}
        value={value}
        placeholder={placeholder}
        onChange={(e) =>
          onChange(e.target.value === "" ? "" : Number(e.target.value))
        }
        onBlur={onBlur}
        className={`input ${
          error && touched ? "border-red-500" : ""
        }`}
      />

      <FieldError message={touched ? error : undefined} />
    </div>
  );
}

--- FILE: components/ui/radio-group.tsx ---
"use client"

import * as React from "react"
import * as RadioGroupPrimitive from "@radix-ui/react-radio-group"
import { CircleIcon } from "lucide-react"

import { cn } from "@/lib/utils"

function RadioGroup({
  className,
  ...props
}: React.ComponentProps<typeof RadioGroupPrimitive.Root>) {
  return (
    <RadioGroupPrimitive.Root
      data-slot="radio-group"
      className={cn("grid gap-3", className)}
      {...props}
    />
  )
}

function RadioGroupItem({
  className,
  ...props
}: React.ComponentProps<typeof RadioGroupPrimitive.Item>) {
  return (
    <RadioGroupPrimitive.Item
      data-slot="radio-group-item"
      className={cn(
        "border-input text-primary focus-visible:border-ring focus-visible:ring-ring/50 aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive dark:bg-input/30 aspect-square size-4 shrink-0 rounded-full border shadow-xs transition-[color,box-shadow] outline-none focus-visible:ring-[3px] disabled:cursor-not-allowed disabled:opacity-50",
        className
      )}
      {...props}
    >
      <RadioGroupPrimitive.Indicator
        data-slot="radio-group-indicator"
        className="relative flex items-center justify-center"
      >
        <CircleIcon className="fill-primary absolute top-1/2 left-1/2 size-2 -translate-x-1/2 -translate-y-1/2" />
      </RadioGroupPrimitive.Indicator>
    </RadioGroupPrimitive.Item>
  )
}

export { RadioGroup, RadioGroupItem }

--- FILE: components/ui/command.tsx ---
"use client"

import * as React from "react"
import { Command as CommandPrimitive } from "cmdk"
import { SearchIcon } from "lucide-react"

import { cn } from "@/lib/utils"
import {
  Dialog,
  DialogContent,
  DialogDescription,
  DialogHeader,
  DialogTitle,
} from "@/components/ui/dialog"

function Command({
  className,
  ...props
}: React.ComponentProps<typeof CommandPrimitive>) {
  return (
    <CommandPrimitive
      data-slot="command"
      className={cn(
        "bg-popover text-popover-foreground flex h-full w-full flex-col overflow-hidden rounded-md",
        className
      )}
      {...props}
    />
  )
}

function CommandDialog({
  title = "Command Palette",
  description = "Search for a command to run...",
  children,
  className,
  showCloseButton = true,
  ...props
}: React.ComponentProps<typeof Dialog> & {
  title?: string
  description?: string
  className?: string
  showCloseButton?: boolean
}) {
  return (
    <Dialog {...props}>
      <DialogHeader className="sr-only">
        <DialogTitle>{title}</DialogTitle>
        <DialogDescription>{description}</DialogDescription>
      </DialogHeader>
      <DialogContent
        className={cn("overflow-hidden p-0", className)}
        showCloseButton={showCloseButton}
      >
        <Command className="[&_[cmdk-group-heading]]:text-muted-foreground **:data-[slot=command-input-wrapper]:h-12 [&_[cmdk-group-heading]]:px-2 [&_[cmdk-group-heading]]:font-medium [&_[cmdk-group]]:px-2 [&_[cmdk-group]:not([hidden])_~[cmdk-group]]:pt-0 [&_[cmdk-input-wrapper]_svg]:h-5 [&_[cmdk-input-wrapper]_svg]:w-5 [&_[cmdk-input]]:h-12 [&_[cmdk-item]]:px-2 [&_[cmdk-item]]:py-3 [&_[cmdk-item]_svg]:h-5 [&_[cmdk-item]_svg]:w-5">
          {children}
        </Command>
      </DialogContent>
    </Dialog>
  )
}

function CommandInput({
  className,
  ...props
}: React.ComponentProps<typeof CommandPrimitive.Input>) {
  return (
    <div
      data-slot="command-input-wrapper"
      className="flex h-9 items-center gap-2 border-b px-3"
    >
      <SearchIcon className="size-4 shrink-0 opacity-50" />
      <CommandPrimitive.Input
        data-slot="command-input"
        className={cn(
          "placeholder:text-muted-foreground flex h-10 w-full rounded-md bg-transparent py-3 text-sm outline-hidden disabled:cursor-not-allowed disabled:opacity-50",
          className
        )}
        {...props}
      />
    </div>
  )
}

function CommandList({
  className,
  ...props
}: React.ComponentProps<typeof CommandPrimitive.List>) {
  return (
    <CommandPrimitive.List
      data-slot="command-list"
      className={cn(
        "max-h-[300px] scroll-py-1 overflow-x-hidden overflow-y-auto",
        className
      )}
      {...props}
    />
  )
}

function CommandEmpty({
  ...props
}: React.ComponentProps<typeof CommandPrimitive.Empty>) {
  return (
    <CommandPrimitive.Empty
      data-slot="command-empty"
      className="py-6 text-center text-sm"
      {...props}
    />
  )
}

function CommandGroup({
  className,
  ...props
}: React.ComponentProps<typeof CommandPrimitive.Group>) {
  return (
    <CommandPrimitive.Group
      data-slot="command-group"
      className={cn(
        "text-foreground [&_[cmdk-group-heading]]:text-muted-foreground overflow-hidden p-1 [&_[cmdk-group-heading]]:px-2 [&_[cmdk-group-heading]]:py-1.5 [&_[cmdk-group-heading]]:text-xs [&_[cmdk-group-heading]]:font-medium",
        className
      )}
      {...props}
    />
  )
}

function CommandSeparator({
  className,
  ...props
}: React.ComponentProps<typeof CommandPrimitive.Separator>) {
  return (
    <CommandPrimitive.Separator
      data-slot="command-separator"
      className={cn("bg-border -mx-1 h-px", className)}
      {...props}
    />
  )
}

function CommandItem({
  className,
  ...props
}: React.ComponentProps<typeof CommandPrimitive.Item>) {
  return (
    <CommandPrimitive.Item
      data-slot="command-item"
      className={cn(
        "data-[selected=true]:bg-accent data-[selected=true]:text-accent-foreground [&_svg:not([class*='text-'])]:text-muted-foreground relative flex cursor-default items-center gap-2 rounded-sm px-2 py-1.5 text-sm outline-hidden select-none data-[disabled=true]:pointer-events-none data-[disabled=true]:opacity-50 [&_svg]:pointer-events-none [&_svg]:shrink-0 [&_svg:not([class*='size-'])]:size-4",
        className
      )}
      {...props}
    />
  )
}

function CommandShortcut({
  className,
  ...props
}: React.ComponentProps<"span">) {
  return (
    <span
      data-slot="command-shortcut"
      className={cn(
        "text-muted-foreground ml-auto text-xs tracking-widest",
        className
      )}
      {...props}
    />
  )
}

export {
  Command,
  CommandDialog,
  CommandInput,
  CommandList,
  CommandEmpty,
  CommandGroup,
  CommandItem,
  CommandShortcut,
  CommandSeparator,
}

--- FILE: components/ui/TextField.tsx ---
"use client";

import { FieldError } from "./FieldError";

type Props = {
  name: string;
  value: string | number;
  placeholder?: string;
  type?: string;
  disabled?: boolean;
  error?: string;
  touched?: boolean;
  onChange(value: string): void;
  onBlur(): void;
};

export function TextField({
  value,
  placeholder,
  type = "text",
  disabled,
  error,
  touched,
  onChange,
  onBlur,
}: Props) {
  return (
    <div>
      <input
        type={type}
        value={value}
        placeholder={placeholder}
        disabled={disabled}
        onChange={(e) => onChange(e.target.value)}
        onBlur={onBlur}
        className={`input ${
          error && touched ? "border-red-500" : ""
        } ${disabled ? "opacity-70" : ""}`}
      />

      <FieldError message={touched ? error : undefined} />
    </div>
  );
}

--- FILE: components/ui/avatar.tsx ---
"use client"

import * as React from "react"
import * as AvatarPrimitive from "@radix-ui/react-avatar"

import { cn } from "@/lib/utils"

function Avatar({
  className,
  size = "default",
  ...props
}: React.ComponentProps<typeof AvatarPrimitive.Root> & {
  size?: "default" | "sm" | "lg"
}) {
  return (
    <AvatarPrimitive.Root
      data-slot="avatar"
      data-size={size}
      className={cn(
        "group/avatar relative flex size-8 shrink-0 overflow-hidden rounded-full select-none data-[size=lg]:size-10 data-[size=sm]:size-6",
        className
      )}
      {...props}
    />
  )
}

function AvatarImage({
  className,
  ...props
}: React.ComponentProps<typeof AvatarPrimitive.Image>) {
  return (
    <AvatarPrimitive.Image
      data-slot="avatar-image"
      className={cn("aspect-square size-full", className)}
      {...props}
    />
  )
}

function AvatarFallback({
  className,
  ...props
}: React.ComponentProps<typeof AvatarPrimitive.Fallback>) {
  return (
    <AvatarPrimitive.Fallback
      data-slot="avatar-fallback"
      className={cn(
        "bg-muted text-muted-foreground flex size-full items-center justify-center rounded-full text-sm group-data-[size=sm]/avatar:text-xs",
        className
      )}
      {...props}
    />
  )
}

function AvatarBadge({ className, ...props }: React.ComponentProps<"span">) {
  return (
    <span
      data-slot="avatar-badge"
      className={cn(
        "bg-primary text-primary-foreground ring-background absolute right-0 bottom-0 z-10 inline-flex items-center justify-center rounded-full ring-2 select-none",
        "group-data-[size=sm]/avatar:size-2 group-data-[size=sm]/avatar:[&>svg]:hidden",
        "group-data-[size=default]/avatar:size-2.5 group-data-[size=default]/avatar:[&>svg]:size-2",
        "group-data-[size=lg]/avatar:size-3 group-data-[size=lg]/avatar:[&>svg]:size-2",
        className
      )}
      {...props}
    />
  )
}

function AvatarGroup({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="avatar-group"
      className={cn(
        "*:data-[slot=avatar]:ring-background group/avatar-group flex -space-x-2 *:data-[slot=avatar]:ring-2",
        className
      )}
      {...props}
    />
  )
}

function AvatarGroupCount({
  className,
  ...props
}: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="avatar-group-count"
      className={cn(
        "bg-muted text-muted-foreground ring-background relative flex size-8 shrink-0 items-center justify-center rounded-full text-sm ring-2 group-has-data-[size=lg]/avatar-group:size-10 group-has-data-[size=sm]/avatar-group:size-6 [&>svg]:size-4 group-has-data-[size=lg]/avatar-group:[&>svg]:size-5 group-has-data-[size=sm]/avatar-group:[&>svg]:size-3",
        className
      )}
      {...props}
    />
  )
}

export {
  Avatar,
  AvatarImage,
  AvatarFallback,
  AvatarBadge,
  AvatarGroup,
  AvatarGroupCount,
}

--- FILE: components/ui/dialog.tsx ---
"use client"

import * as React from "react"
import * as DialogPrimitive from "@radix-ui/react-dialog"
import { XIcon } from "lucide-react"

import { cn } from "@/lib/utils"
import { Button } from "@/components/ui/button"

function Dialog({
  ...props
}: React.ComponentProps<typeof DialogPrimitive.Root>) {
  return <DialogPrimitive.Root data-slot="dialog" {...props} />
}

function DialogTrigger({
  ...props
}: React.ComponentProps<typeof DialogPrimitive.Trigger>) {
  return <DialogPrimitive.Trigger data-slot="dialog-trigger" {...props} />
}

function DialogPortal({
  ...props
}: React.ComponentProps<typeof DialogPrimitive.Portal>) {
  return <DialogPrimitive.Portal data-slot="dialog-portal" {...props} />
}

function DialogClose({
  ...props
}: React.ComponentProps<typeof DialogPrimitive.Close>) {
  return <DialogPrimitive.Close data-slot="dialog-close" {...props} />
}

function DialogOverlay({
  className,
  ...props
}: React.ComponentProps<typeof DialogPrimitive.Overlay>) {
  return (
    <DialogPrimitive.Overlay
      data-slot="dialog-overlay"
      className={cn(
        "data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 fixed inset-0 z-50 bg-black/50",
        className
      )}
      {...props}
    />
  )
}

function DialogContent({
  className,
  children,
  showCloseButton = true,
  ...props
}: React.ComponentProps<typeof DialogPrimitive.Content> & {
  showCloseButton?: boolean
}) {
  return (
    <DialogPortal data-slot="dialog-portal">
      <DialogOverlay />
      <DialogPrimitive.Content
        data-slot="dialog-content"
        className={cn(
          "bg-background data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 fixed top-[50%] left-[50%] z-50 grid w-full max-w-[calc(100%-2rem)] translate-x-[-50%] translate-y-[-50%] gap-4 rounded-lg border p-6 shadow-lg duration-200 outline-none sm:max-w-lg",
          className
        )}
        {...props}
      >
        {children}
        {showCloseButton && (
          <DialogPrimitive.Close
            data-slot="dialog-close"
            className="ring-offset-background focus:ring-ring data-[state=open]:bg-accent data-[state=open]:text-muted-foreground absolute top-4 right-4 rounded-xs opacity-70 transition-opacity hover:opacity-100 focus:ring-2 focus:ring-offset-2 focus:outline-hidden disabled:pointer-events-none [&_svg]:pointer-events-none [&_svg]:shrink-0 [&_svg:not([class*='size-'])]:size-4"
          >
            <XIcon />
            <span className="sr-only">Close</span>
          </DialogPrimitive.Close>
        )}
      </DialogPrimitive.Content>
    </DialogPortal>
  )
}

function DialogHeader({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="dialog-header"
      className={cn("flex flex-col gap-2 text-center sm:text-left", className)}
      {...props}
    />
  )
}

function DialogFooter({
  className,
  showCloseButton = false,
  children,
  ...props
}: React.ComponentProps<"div"> & {
  showCloseButton?: boolean
}) {
  return (
    <div
      data-slot="dialog-footer"
      className={cn(
        "flex flex-col-reverse gap-2 sm:flex-row sm:justify-end",
        className
      )}
      {...props}
    >
      {children}
      {showCloseButton && (
        <DialogPrimitive.Close asChild>
          <Button variant="outline">Close</Button>
        </DialogPrimitive.Close>
      )}
    </div>
  )
}

function DialogTitle({
  className,
  ...props
}: React.ComponentProps<typeof DialogPrimitive.Title>) {
  return (
    <DialogPrimitive.Title
      data-slot="dialog-title"
      className={cn("text-lg leading-none font-semibold", className)}
      {...props}
    />
  )
}

function DialogDescription({
  className,
  ...props
}: React.ComponentProps<typeof DialogPrimitive.Description>) {
  return (
    <DialogPrimitive.Description
      data-slot="dialog-description"
      className={cn("text-muted-foreground text-sm", className)}
      {...props}
    />
  )
}

export {
  Dialog,
  DialogClose,
  DialogContent,
  DialogDescription,
  DialogFooter,
  DialogHeader,
  DialogOverlay,
  DialogPortal,
  DialogTitle,
  DialogTrigger,
}

--- FILE: components/ui/badge.tsx ---
import * as React from "react"
import { cva, type VariantProps } from "class-variance-authority"
import { Slot } from "radix-ui"

import { cn } from "@/lib/utils"

const badgeVariants = cva(
  "inline-flex items-center justify-center rounded-full border border-transparent px-2 py-0.5 text-xs font-medium w-fit whitespace-nowrap shrink-0 [&>svg]:size-3 gap-1 [&>svg]:pointer-events-none focus-visible:border-ring focus-visible:ring-ring/50 focus-visible:ring-[3px] aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive transition-[color,box-shadow] overflow-hidden",
  {
    variants: {
      variant: {
        default: "bg-primary text-primary-foreground [a&]:hover:bg-primary/90",
        secondary:
          "bg-secondary text-secondary-foreground [a&]:hover:bg-secondary/90",
        destructive:
          "bg-destructive text-white [a&]:hover:bg-destructive/90 focus-visible:ring-destructive/20 dark:focus-visible:ring-destructive/40 dark:bg-destructive/60",
        outline:
          "border-border text-foreground [a&]:hover:bg-accent [a&]:hover:text-accent-foreground",
        ghost: "[a&]:hover:bg-accent [a&]:hover:text-accent-foreground",
        link: "text-primary underline-offset-4 [a&]:hover:underline",
      },
    },
    defaultVariants: {
      variant: "default",
    },
  }
)

function Badge({
  className,
  variant = "default",
  asChild = false,
  ...props
}: React.ComponentProps<"span"> &
  VariantProps<typeof badgeVariants> & { asChild?: boolean }) {
  const Comp = asChild ? Slot.Root : "span"

  return (
    <Comp
      data-slot="badge"
      data-variant={variant}
      className={cn(badgeVariants({ variant }), className)}
      {...props}
    />
  )
}

export { Badge, badgeVariants }

--- FILE: components/ui/separator.tsx ---
"use client"

import * as React from "react"
import * as SeparatorPrimitive from "@radix-ui/react-separator"

import { cn } from "@/lib/utils"

function Separator({
  className,
  orientation = "horizontal",
  decorative = true,
  ...props
}: React.ComponentProps<typeof SeparatorPrimitive.Root>) {
  return (
    <SeparatorPrimitive.Root
      data-slot="separator"
      decorative={decorative}
      orientation={orientation}
      className={cn(
        "bg-border shrink-0 data-[orientation=horizontal]:h-px data-[orientation=horizontal]:w-full data-[orientation=vertical]:h-full data-[orientation=vertical]:w-px",
        className
      )}
      {...props}
    />
  )
}

export { Separator }

--- FILE: components/ui/button.tsx ---
import * as React from "react"
import { Slot } from "@radix-ui/react-slot"
import { cva, type VariantProps } from "class-variance-authority"

import { cn } from "@/lib/utils"

const buttonVariants = cva(
  "inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md text-sm font-medium transition-all disabled:pointer-events-none disabled:opacity-50 [&_svg]:pointer-events-none [&_svg:not([class*='size-'])]:size-4 shrink-0 [&_svg]:shrink-0 outline-none focus-visible:border-ring focus-visible:ring-ring/50 focus-visible:ring-[3px] aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive",
  {
    variants: {
      variant: {
        default: "bg-primary text-primary-foreground hover:bg-primary/90",
        destructive:
          "bg-destructive text-white hover:bg-destructive/90 focus-visible:ring-destructive/20 dark:focus-visible:ring-destructive/40 dark:bg-destructive/60",
        outline:
          "border bg-background shadow-xs hover:bg-accent hover:text-accent-foreground dark:bg-input/30 dark:border-input dark:hover:bg-input/50",
        secondary:
          "bg-secondary text-secondary-foreground hover:bg-secondary/80",
        ghost:
          "hover:bg-accent hover:text-accent-foreground dark:hover:bg-accent/50",
        link: "text-primary underline-offset-4 hover:underline",
      },
      size: {
        default: "h-9 px-4 py-2 has-[>svg]:px-3",
        xs: "h-6 gap-1 rounded-md px-2 text-xs has-[>svg]:px-1.5 [&_svg:not([class*='size-'])]:size-3",
        sm: "h-8 rounded-md gap-1.5 px-3 has-[>svg]:px-2.5",
        lg: "h-10 rounded-md px-6 has-[>svg]:px-4",
        icon: "size-9",
        "icon-xs": "size-6 rounded-md [&_svg:not([class*='size-'])]:size-3",
        "icon-sm": "size-8",
        "icon-lg": "size-10",
      },
    },
    defaultVariants: {
      variant: "default",
      size: "default",
    },
  }
)

function Button({
  className,
  variant = "default",
  size = "default",
  asChild = false,
  ...props
}: React.ComponentProps<"button"> &
  VariantProps<typeof buttonVariants> & {
    asChild?: boolean
  }) {
  const Comp = asChild ? Slot : "button"

  return (
    <Comp
      data-slot="button"
      data-variant={variant}
      data-size={size}
      className={cn(buttonVariants({ variant, size, className }))}
      {...props}
    />
  )
}

export { Button, buttonVariants }

--- FILE: components/ui/checkbox.tsx ---
"use client"

import * as React from "react"
import * as CheckboxPrimitive from "@radix-ui/react-checkbox"
import { CheckIcon } from "lucide-react"

import { cn } from "@/lib/utils"

function Checkbox({
  className,
  ...props
}: React.ComponentProps<typeof CheckboxPrimitive.Root>) {
  return (
    <CheckboxPrimitive.Root
      data-slot="checkbox"
      className={cn(
        "peer border-input dark:bg-input/30 data-[state=checked]:bg-primary data-[state=checked]:text-primary-foreground dark:data-[state=checked]:bg-primary data-[state=checked]:border-primary focus-visible:border-ring focus-visible:ring-ring/50 aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive size-4 shrink-0 rounded-[4px] border shadow-xs transition-shadow outline-none focus-visible:ring-[3px] disabled:cursor-not-allowed disabled:opacity-50",
        className
      )}
      {...props}
    >
      <CheckboxPrimitive.Indicator
        data-slot="checkbox-indicator"
        className="grid place-content-center text-current transition-none"
      >
        <CheckIcon className="size-3.5" />
      </CheckboxPrimitive.Indicator>
    </CheckboxPrimitive.Root>
  )
}

export { Checkbox }

--- FILE: components/ui/dropdown-menu.tsx ---
"use client"

import * as React from "react"
import * as DropdownMenuPrimitive from "@radix-ui/react-dropdown-menu"
import { CheckIcon, ChevronRightIcon, CircleIcon } from "lucide-react"

import { cn } from "@/lib/utils"

function DropdownMenu({
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.Root>) {
  return <DropdownMenuPrimitive.Root data-slot="dropdown-menu" {...props} />
}

function DropdownMenuPortal({
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.Portal>) {
  return (
    <DropdownMenuPrimitive.Portal data-slot="dropdown-menu-portal" {...props} />
  )
}

function DropdownMenuTrigger({
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.Trigger>) {
  return (
    <DropdownMenuPrimitive.Trigger
      data-slot="dropdown-menu-trigger"
      {...props}
    />
  )
}

function DropdownMenuContent({
  className,
  sideOffset = 4,
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.Content>) {
  return (
    <DropdownMenuPrimitive.Portal>
      <DropdownMenuPrimitive.Content
        data-slot="dropdown-menu-content"
        sideOffset={sideOffset}
        className={cn(
          "bg-popover text-popover-foreground data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 z-50 max-h-(--radix-dropdown-menu-content-available-height) min-w-[8rem] origin-(--radix-dropdown-menu-content-transform-origin) overflow-x-hidden overflow-y-auto rounded-md border p-1 shadow-md",
          className
        )}
        {...props}
      />
    </DropdownMenuPrimitive.Portal>
  )
}

function DropdownMenuGroup({
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.Group>) {
  return (
    <DropdownMenuPrimitive.Group data-slot="dropdown-menu-group" {...props} />
  )
}

function DropdownMenuItem({
  className,
  inset,
  variant = "default",
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.Item> & {
  inset?: boolean
  variant?: "default" | "destructive"
}) {
  return (
    <DropdownMenuPrimitive.Item
      data-slot="dropdown-menu-item"
      data-inset={inset}
      data-variant={variant}
      className={cn(
        "focus:bg-accent focus:text-accent-foreground data-[variant=destructive]:text-destructive data-[variant=destructive]:focus:bg-destructive/10 dark:data-[variant=destructive]:focus:bg-destructive/20 data-[variant=destructive]:focus:text-destructive data-[variant=destructive]:*:[svg]:!text-destructive [&_svg:not([class*='text-'])]:text-muted-foreground relative flex cursor-default items-center gap-2 rounded-sm px-2 py-1.5 text-sm outline-hidden select-none data-[disabled]:pointer-events-none data-[disabled]:opacity-50 data-[inset]:pl-8 [&_svg]:pointer-events-none [&_svg]:shrink-0 [&_svg:not([class*='size-'])]:size-4",
        className
      )}
      {...props}
    />
  )
}

function DropdownMenuCheckboxItem({
  className,
  children,
  checked,
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.CheckboxItem>) {
  return (
    <DropdownMenuPrimitive.CheckboxItem
      data-slot="dropdown-menu-checkbox-item"
      className={cn(
        "focus:bg-accent focus:text-accent-foreground relative flex cursor-default items-center gap-2 rounded-sm py-1.5 pr-2 pl-8 text-sm outline-hidden select-none data-[disabled]:pointer-events-none data-[disabled]:opacity-50 [&_svg]:pointer-events-none [&_svg]:shrink-0 [&_svg:not([class*='size-'])]:size-4",
        className
      )}
      checked={checked}
      {...props}
    >
      <span className="pointer-events-none absolute left-2 flex size-3.5 items-center justify-center">
        <DropdownMenuPrimitive.ItemIndicator>
          <CheckIcon className="size-4" />
        </DropdownMenuPrimitive.ItemIndicator>
      </span>
      {children}
    </DropdownMenuPrimitive.CheckboxItem>
  )
}

function DropdownMenuRadioGroup({
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.RadioGroup>) {
  return (
    <DropdownMenuPrimitive.RadioGroup
      data-slot="dropdown-menu-radio-group"
      {...props}
    />
  )
}

function DropdownMenuRadioItem({
  className,
  children,
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.RadioItem>) {
  return (
    <DropdownMenuPrimitive.RadioItem
      data-slot="dropdown-menu-radio-item"
      className={cn(
        "focus:bg-accent focus:text-accent-foreground relative flex cursor-default items-center gap-2 rounded-sm py-1.5 pr-2 pl-8 text-sm outline-hidden select-none data-[disabled]:pointer-events-none data-[disabled]:opacity-50 [&_svg]:pointer-events-none [&_svg]:shrink-0 [&_svg:not([class*='size-'])]:size-4",
        className
      )}
      {...props}
    >
      <span className="pointer-events-none absolute left-2 flex size-3.5 items-center justify-center">
        <DropdownMenuPrimitive.ItemIndicator>
          <CircleIcon className="size-2 fill-current" />
        </DropdownMenuPrimitive.ItemIndicator>
      </span>
      {children}
    </DropdownMenuPrimitive.RadioItem>
  )
}

function DropdownMenuLabel({
  className,
  inset,
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.Label> & {
  inset?: boolean
}) {
  return (
    <DropdownMenuPrimitive.Label
      data-slot="dropdown-menu-label"
      data-inset={inset}
      className={cn(
        "px-2 py-1.5 text-sm font-medium data-[inset]:pl-8",
        className
      )}
      {...props}
    />
  )
}

function DropdownMenuSeparator({
  className,
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.Separator>) {
  return (
    <DropdownMenuPrimitive.Separator
      data-slot="dropdown-menu-separator"
      className={cn("bg-border -mx-1 my-1 h-px", className)}
      {...props}
    />
  )
}

function DropdownMenuShortcut({
  className,
  ...props
}: React.ComponentProps<"span">) {
  return (
    <span
      data-slot="dropdown-menu-shortcut"
      className={cn(
        "text-muted-foreground ml-auto text-xs tracking-widest",
        className
      )}
      {...props}
    />
  )
}

function DropdownMenuSub({
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.Sub>) {
  return <DropdownMenuPrimitive.Sub data-slot="dropdown-menu-sub" {...props} />
}

function DropdownMenuSubTrigger({
  className,
  inset,
  children,
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.SubTrigger> & {
  inset?: boolean
}) {
  return (
    <DropdownMenuPrimitive.SubTrigger
      data-slot="dropdown-menu-sub-trigger"
      data-inset={inset}
      className={cn(
        "focus:bg-accent focus:text-accent-foreground data-[state=open]:bg-accent data-[state=open]:text-accent-foreground [&_svg:not([class*='text-'])]:text-muted-foreground flex cursor-default items-center gap-2 rounded-sm px-2 py-1.5 text-sm outline-hidden select-none data-[inset]:pl-8 [&_svg]:pointer-events-none [&_svg]:shrink-0 [&_svg:not([class*='size-'])]:size-4",
        className
      )}
      {...props}
    >
      {children}
      <ChevronRightIcon className="ml-auto size-4" />
    </DropdownMenuPrimitive.SubTrigger>
  )
}

function DropdownMenuSubContent({
  className,
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.SubContent>) {
  return (
    <DropdownMenuPrimitive.SubContent
      data-slot="dropdown-menu-sub-content"
      className={cn(
        "bg-popover text-popover-foreground data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 z-50 min-w-[8rem] origin-(--radix-dropdown-menu-content-transform-origin) overflow-hidden rounded-md border p-1 shadow-lg",
        className
      )}
      {...props}
    />
  )
}

export {
  DropdownMenu,
  DropdownMenuPortal,
  DropdownMenuTrigger,
  DropdownMenuContent,
  DropdownMenuGroup,
  DropdownMenuLabel,
  DropdownMenuItem,
  DropdownMenuCheckboxItem,
  DropdownMenuRadioGroup,
  DropdownMenuRadioItem,
  DropdownMenuSeparator,
  DropdownMenuShortcut,
  DropdownMenuSub,
  DropdownMenuSubTrigger,
  DropdownMenuSubContent,
}

--- FILE: components/ui/FieldError.tsx ---
"use client";

export function FieldError({ message }: { message?: string }) {
  if (!message) return null;

  return (
    <p className="mt-1 text-xs text-red-600 flex items-center gap-1">
      ‚ö†Ô∏è {message}
    </p>
  );
}

--- FILE: components/ui/select.tsx ---
"use client"

import * as React from "react"
import * as SelectPrimitive from "@radix-ui/react-select"
import { CheckIcon, ChevronDownIcon, ChevronUpIcon } from "lucide-react"

import { cn } from "@/lib/utils"

function Select({
  ...props
}: React.ComponentProps<typeof SelectPrimitive.Root>) {
  return <SelectPrimitive.Root data-slot="select" {...props} />
}

function SelectGroup({
  ...props
}: React.ComponentProps<typeof SelectPrimitive.Group>) {
  return <SelectPrimitive.Group data-slot="select-group" {...props} />
}

function SelectValue({
  ...props
}: React.ComponentProps<typeof SelectPrimitive.Value>) {
  return <SelectPrimitive.Value data-slot="select-value" {...props} />
}

function SelectTrigger({
  className,
  size = "default",
  children,
  ...props
}: React.ComponentProps<typeof SelectPrimitive.Trigger> & {
  size?: "sm" | "default"
}) {
  return (
    <SelectPrimitive.Trigger
      data-slot="select-trigger"
      data-size={size}
      className={cn(
        "border-input data-[placeholder]:text-muted-foreground [&_svg:not([class*='text-'])]:text-muted-foreground focus-visible:border-ring focus-visible:ring-ring/50 aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive dark:bg-input/30 dark:hover:bg-input/50 flex w-fit items-center justify-between gap-2 rounded-md border bg-transparent px-3 py-2 text-sm whitespace-nowrap shadow-xs transition-[color,box-shadow] outline-none focus-visible:ring-[3px] disabled:cursor-not-allowed disabled:opacity-50 data-[size=default]:h-9 data-[size=sm]:h-8 *:data-[slot=select-value]:line-clamp-1 *:data-[slot=select-value]:flex *:data-[slot=select-value]:items-center *:data-[slot=select-value]:gap-2 [&_svg]:pointer-events-none [&_svg]:shrink-0 [&_svg:not([class*='size-'])]:size-4",
        className
      )}
      {...props}
    >
      {children}
      <SelectPrimitive.Icon asChild>
        <ChevronDownIcon className="size-4 opacity-50" />
      </SelectPrimitive.Icon>
    </SelectPrimitive.Trigger>
  )
}

function SelectContent({
  className,
  children,
  position = "item-aligned",
  align = "center",
  ...props
}: React.ComponentProps<typeof SelectPrimitive.Content>) {
  return (
    <SelectPrimitive.Portal>
      <SelectPrimitive.Content
        data-slot="select-content"
        className={cn(
          "bg-popover text-popover-foreground data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 relative z-50 max-h-(--radix-select-content-available-height) min-w-[8rem] origin-(--radix-select-content-transform-origin) overflow-x-hidden overflow-y-auto rounded-md border shadow-md",
          position === "popper" &&
            "data-[side=bottom]:translate-y-1 data-[side=left]:-translate-x-1 data-[side=right]:translate-x-1 data-[side=top]:-translate-y-1",
          className
        )}
        position={position}
        align={align}
        {...props}
      >
        <SelectScrollUpButton />
        <SelectPrimitive.Viewport
          className={cn(
            "p-1",
            position === "popper" &&
              "h-[var(--radix-select-trigger-height)] w-full min-w-[var(--radix-select-trigger-width)] scroll-my-1"
          )}
        >
          {children}
        </SelectPrimitive.Viewport>
        <SelectScrollDownButton />
      </SelectPrimitive.Content>
    </SelectPrimitive.Portal>
  )
}

function SelectLabel({
  className,
  ...props
}: React.ComponentProps<typeof SelectPrimitive.Label>) {
  return (
    <SelectPrimitive.Label
      data-slot="select-label"
      className={cn("text-muted-foreground px-2 py-1.5 text-xs", className)}
      {...props}
    />
  )
}

function SelectItem({
  className,
  children,
  ...props
}: React.ComponentProps<typeof SelectPrimitive.Item>) {
  return (
    <SelectPrimitive.Item
      data-slot="select-item"
      className={cn(
        "focus:bg-accent focus:text-accent-foreground [&_svg:not([class*='text-'])]:text-muted-foreground relative flex w-full cursor-default items-center gap-2 rounded-sm py-1.5 pr-8 pl-2 text-sm outline-hidden select-none data-[disabled]:pointer-events-none data-[disabled]:opacity-50 [&_svg]:pointer-events-none [&_svg]:shrink-0 [&_svg:not([class*='size-'])]:size-4 *:[span]:last:flex *:[span]:last:items-center *:[span]:last:gap-2",
        className
      )}
      {...props}
    >
      <span
        data-slot="select-item-indicator"
        className="absolute right-2 flex size-3.5 items-center justify-center"
      >
        <SelectPrimitive.ItemIndicator>
          <CheckIcon className="size-4" />
        </SelectPrimitive.ItemIndicator>
      </span>
      <SelectPrimitive.ItemText>{children}</SelectPrimitive.ItemText>
    </SelectPrimitive.Item>
  )
}

function SelectSeparator({
  className,
  ...props
}: React.ComponentProps<typeof SelectPrimitive.Separator>) {
  return (
    <SelectPrimitive.Separator
      data-slot="select-separator"
      className={cn("bg-border pointer-events-none -mx-1 my-1 h-px", className)}
      {...props}
    />
  )
}

function SelectScrollUpButton({
  className,
  ...props
}: React.ComponentProps<typeof SelectPrimitive.ScrollUpButton>) {
  return (
    <SelectPrimitive.ScrollUpButton
      data-slot="select-scroll-up-button"
      className={cn(
        "flex cursor-default items-center justify-center py-1",
        className
      )}
      {...props}
    >
      <ChevronUpIcon className="size-4" />
    </SelectPrimitive.ScrollUpButton>
  )
}

function SelectScrollDownButton({
  className,
  ...props
}: React.ComponentProps<typeof SelectPrimitive.ScrollDownButton>) {
  return (
    <SelectPrimitive.ScrollDownButton
      data-slot="select-scroll-down-button"
      className={cn(
        "flex cursor-default items-center justify-center py-1",
        className
      )}
      {...props}
    >
      <ChevronDownIcon className="size-4" />
    </SelectPrimitive.ScrollDownButton>
  )
}

export {
  Select,
  SelectContent,
  SelectGroup,
  SelectItem,
  SelectLabel,
  SelectScrollDownButton,
  SelectScrollUpButton,
  SelectSeparator,
  SelectTrigger,
  SelectValue,
}

--- FILE: components/ui/input.tsx ---
import * as React from "react"

import { cn } from "@/lib/utils"

function Input({ className, type, ...props }: React.ComponentProps<"input">) {
  return (
    <input
      type={type}
      data-slot="input"
      className={cn(
        "file:text-foreground placeholder:text-muted-foreground selection:bg-primary selection:text-primary-foreground dark:bg-input/30 border-input h-9 w-full min-w-0 rounded-md border bg-transparent px-3 py-1 text-base shadow-xs transition-[color,box-shadow] outline-none file:inline-flex file:h-7 file:border-0 file:bg-transparent file:text-sm file:font-medium disabled:pointer-events-none disabled:cursor-not-allowed disabled:opacity-50 md:text-sm",
        "focus-visible:border-ring focus-visible:ring-ring/50 focus-visible:ring-[3px]",
        "aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive",
        className
      )}
      {...props}
    />
  )
}

export { Input }

--- FILE: components/ui/skeleton.tsx ---
import { cn } from "@/lib/utils"

function Skeleton({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="skeleton"
      className={cn("bg-accent animate-pulse rounded-md", className)}
      {...props}
    />
  )
}

export { Skeleton }

--- FILE: components/auth/AuthGate.tsx ---
"use client";

import { useEffect, useMemo, useRef, useState } from "react";
import { useRouter, usePathname, useSearchParams } from "next/navigation";
import { useAuth } from "./AuthProvider";
import {
  doesUserProfileExist,
  isProfileComplete,
  getUserRole,
} from "@/services/user-profile.service";

export function AuthGate({ children }: { children: React.ReactNode }) {
  const { user, loading } = useAuth();
  const router = useRouter();
  const pathname = usePathname();
  const searchParams = useSearchParams();

  const [checking, setChecking] = useState(true);

  // ‚úÖ trasy, kt√≥re NIE powinny wymuszaƒá complete-profile
  const publicRoutes = useMemo(
    () =>
      new Set([
        "/",
        "/login",
        "/register",
        "/complete-profile", // pozwalamy wej≈õƒá
      ]),
    []
  );

  // ‚úÖ je≈õli masz jakie≈õ publiczne podstrony, dodaj prefixy:
  const publicPrefixes = useMemo(() => ["/public"], []);

  const isPublicRoute = useMemo(() => {
    if (publicRoutes.has(pathname)) return true;
    return publicPrefixes.some((p) => pathname.startsWith(p));
  }, [pathname, publicRoutes, publicPrefixes]);

  // ‚úÖ trasy wymagajƒÖce profilu (Twoje dashboard/admin)
  const requiresProfile = useMemo(() => {
    // dashboard i admin wymagajƒÖ profilu
    return pathname.startsWith("/dashboard") || pathname.startsWith("/admin");
  }, [pathname]);

  // zapobiega wielokrotnym redirectom w tej samej ‚Äúsesji efektu‚Äù
  const redirectingRef = useRef(false);

  useEffect(() => {
    if (loading) return;

    // zawsze resetuj "redirecting" przy zmianie usera
    redirectingRef.current = false;

    // 1) niezalogowany -> login (tylko gdy to nie jest publiczna strona)
    if (!user) {
      setChecking(false);
      if (!isPublicRoute) {
        const next = `${pathname}${searchParams?.toString() ? `?${searchParams}` : ""}`;
        router.replace(`/login?next=${encodeURIComponent(next)}`);
      }
      return;
    }

    async function verify() {
      setChecking(true);

      try {
        const role = await getUserRole(user!.uid);

        // ‚úÖ admin nie przechodzi przez complete-profile
        if (role === "admin") return;

        const exists = await doesUserProfileExist(user!.uid);

        // 2) brak profilu -> complete-profile (z next)
        if (!exists) {
          if (pathname !== "/complete-profile" && !redirectingRef.current) {
            redirectingRef.current = true;
            const next = `${pathname}${searchParams?.toString() ? `?${searchParams}` : ""}`;
            router.replace(`/complete-profile?next=${encodeURIComponent(next)}`);
          }
          return;
        }

        const complete = await isProfileComplete(user!.uid);

        // 3) profil niekompletny -> complete-profile tylko gdy wchodzisz w strefƒô wymagajƒÖcƒÖ profilu
        if (!complete && requiresProfile) {
          if (pathname !== "/complete-profile" && !redirectingRef.current) {
            redirectingRef.current = true;
            const next = `${pathname}${searchParams?.toString() ? `?${searchParams}` : ""}`;
            router.replace(`/complete-profile?next=${encodeURIComponent(next)}`);
          }
          return;
        }

        // 4) profil kompletny -> blokuj wej≈õcie na complete-profile
        if (complete && pathname === "/complete-profile") {
          router.replace("/dashboard");
          return;
        }
      } finally {
        setChecking(false);
      }
    }

    verify();
  }, [user, loading, pathname, router, isPublicRoute, requiresProfile, searchParams]);

  if (loading || checking) {
    return <div className="p-6">Sprawdzanie profilu‚Ä¶</div>;
  }

  return <>{children}</>;
}

--- FILE: components/auth/AuthProvider.tsx ---
"use client";

import React, {
  createContext,
  useContext,
  useEffect,
  useMemo,
  useState,
} from "react";
import { onAuthStateChanged } from "firebase/auth";
import type { User } from "firebase/auth";
import { auth, db } from "@/lib/firebase/client";
import type { AuthState } from "@/types/auth";
import { doc, serverTimestamp, setDoc } from "firebase/firestore";
import { heartbeat, setOffline, setOnline } from "@/services/presence.service";

const AuthContext = createContext<AuthState | null>(null);

function normalizeProvider(u: User): "google" | "facebook" | "password" {
  // providerData bywa puste lub ma wiele wpis√≥w; bierzemy pierwszy sensowny
  const pid = u.providerData?.find((p) => p?.providerId)?.providerId;

  if (pid === "google.com") return "google";
  if (pid === "facebook.com") return "facebook";
  return "password";
}

async function updateLoginMeta(u: User) {
  // setDoc + merge => nie wywali b≈Çƒôdu gdy users/{uid} nie istnieje jeszcze
  await setDoc(
    doc(db, "users", u.uid),
    {
      provider: normalizeProvider(u),
      lastLoginAt: Date.now(),
      lastLoginAtServer: serverTimestamp(),
    },
    { merge: true }
  );
}

export function AuthProvider({ children }: { children: React.ReactNode }) {
  const [user, setUser] = useState<User | null>(null);
  const [loading, setLoading] = useState(true);

  // 1) tylko listen auth
  useEffect(() => {
    const unsub = onAuthStateChanged(auth, (u) => {
      setUser(u);
      setLoading(false);
    });
    return () => unsub();
  }, []);

  // 2) metadane + presence (osobny effect => poprawny cleanup)
  useEffect(() => {
    if (!user) return;

    let alive = true;

    // ---- meta logowania (jednorazowo po wej≈õciu usera) ----
    updateLoginMeta(user).catch((err) => {
      console.warn("Nie uda≈Ço siƒô zapisaƒá meta logowania", err);
    });

    // ---- presence start ----
    setOnline(user.uid).catch(() => {});

    // heartbeat co 30s
    const intervalId = window.setInterval(() => {
      if (!alive) return;
      heartbeat(user.uid).catch(() => {});
    }, 30_000);

    // gdy tab znika => offline; gdy wraca => online
    const onVis = () => {
      if (!alive) return;
      if (document.visibilityState === "hidden") {
        setOffline(user.uid).catch(() => {});
      } else {
        setOnline(user.uid).catch(() => {});
      }
    };

    // zamkniƒôcie karty / reload (best effort)
    const onBeforeUnload = () => {
      setOffline(user.uid).catch(() => {});
    };

    document.addEventListener("visibilitychange", onVis);
    window.addEventListener("beforeunload", onBeforeUnload);

    return () => {
      alive = false;
      window.clearInterval(intervalId);
      document.removeEventListener("visibilitychange", onVis);
      window.removeEventListener("beforeunload", onBeforeUnload);

      // best effort offline na cleanup (np. wylogowanie / zmiana usera)
      setOffline(user.uid).catch(() => {});
    };
  }, [user]);

  const value = useMemo(() => ({ user, loading }), [user, loading]);

  return <AuthContext.Provider value={value}>{children}</AuthContext.Provider>;
}

export function useAuth() {
  const ctx = useContext(AuthContext);
  if (!ctx) throw new Error("useAuth must be used within AuthProvider");
  return ctx;
}

--- FILE: components/auth/AdminGate.tsx ---
"use client";

import { useEffect, useState } from "react";
import { useRouter } from "next/navigation";
import { useAuth } from "@/components/auth/AuthProvider";
import { getUserRole } from "@/services/role.service";

export function AdminGate({ children }: { children: React.ReactNode }) {
  const { user, loading } = useAuth();
  const router = useRouter();
  const [checking, setChecking] = useState(true);

  useEffect(() => {
    if (loading) return;

    if (!user) {
      router.replace("/login?next=/admin/classes");
      return;
    }

    getUserRole(user.uid)
      .then((role) => {
        if (role !== "admin") {
          router.replace("/dashboard");
        }
      })
      .finally(() => setChecking(false));
  }, [user, loading, router]);

  if (loading || checking) {
    return <div className="p-6">Sprawdzanie uprawnie≈Ñ‚Ä¶</div>;
  }

  return <>{children}</>;
}

--- FILE: components/user-classes/ClassesTabs.tsx ---
"use client";

import { Tabs, TabsContent, TabsList, TabsTrigger } from "@/components/ui/tabs";
import { UserWeekCalendar } from "@/components/user-classes/UserWeekCalendar";
import { AvailableClassesTab } from "@/components/user-classes/AvailableClassesTab";

export function ClassesTabs({ refreshTick }: { refreshTick: number }) {
  return (
    <Tabs defaultValue="schedule" className="w-full">
      <TabsList>
        <TabsTrigger value="schedule">Plan zajƒôƒá</TabsTrigger>
        <TabsTrigger value="available">Dostƒôpne zajƒôcia</TabsTrigger>
        <TabsTrigger value="enrollments">Moje zapisy</TabsTrigger>
      </TabsList>

      <TabsContent value="schedule">
        <UserWeekCalendar refreshTick={refreshTick} />
      </TabsContent>

      <TabsContent value="available">
        <AvailableClassesTab />
      </TabsContent>

      <TabsContent value="enrollments">
        <div className="text-sm text-muted-foreground">
          Tu zrobimy listƒô zapis√≥w (TAB 3).
        </div>
      </TabsContent>
    </Tabs>
  );
}

--- FILE: components/user-classes/EnrollModal.tsx ---
"use client";

import { useEffect, useMemo, useState } from "react";
import type { Class, EnrollmentRequest } from "@/types";
import { collection, getDocsFromServer, query, where } from "firebase/firestore";
import { db } from "@/lib/firebase/client";
 
import { usageKeyForPeriod } from "@/services/time";
import { useAuth } from "@/components/auth/AuthProvider";
import { getParentProfile } from "@/services/user-profile.service";
import {
  createEnrollmentRequest,
  getEnrollmentRequestForChild,
  withdrawEnrollmentRequest,
} from "@/services/enrollment-requests.service";

import { Button } from "@/components/ui/button";
import { Checkbox } from "@/components/ui/checkbox";
import { Dialog, DialogContent, DialogHeader, DialogTitle } from "@/components/ui/dialog";
import { RadioGroup, RadioGroupItem } from "@/components/ui/radio-group";
import {
  AlertDialog,
  AlertDialogTrigger,
  AlertDialogContent,
  AlertDialogHeader,
  AlertDialogTitle,
  AlertDialogDescription,
  AlertDialogFooter,
  AlertDialogCancel,
  AlertDialogAction,
} from "@/components/ui/alert-dialog";

import {
  Calendar,
  Clock,
  MapPin,
  User,
  Repeat,
  Loader2,
  CheckCircle2,
  Hourglass,
  XCircle,
  X,
} from "lucide-react";

import { PurchasePlanModal } from "../billing/PurchasePlanModal";
import { CreditsUsageModal } from "@/components/user-classes/CreditsUsageModal";

/* ================= TYPES ================= */

type Child = { id: string; firstName: string; lastName: string };

type RequestState =
  | { state: "loading" }
  | { state: "none" }
  | { state: "loaded"; request: EnrollmentRequest };

type Props = {
  open: boolean;
  selectedClass: Class | null;
  initialDateYMD?: string | null;
  onClose: () => void;
};

function safeReqDates(req: EnrollmentRequest): string[] {
  const raw = (req as any)?.dates;
  if (!Array.isArray(raw)) return [];
  return raw.map((x) => String(x || "").trim()).filter((x) => /^\d{4}-\d{2}-\d{2}$/.test(x));
}

function monthOf(ymd?: string | null) {
  return ymd ? String(ymd).slice(0, 7) : null; // YYYY-MM
}

/* ================= COMPONENT ================= */

export function EnrollModal({ open, selectedClass, initialDateYMD = null, onClose }: Props) {
  const { user } = useAuth();

  const [children, setChildren] = useState<Child[]>([]);
  const [selectedChildIds, setSelectedChildIds] = useState<string[]>([]);
  const [paymentMethod, setPaymentMethod] =
    useState<"credits" | "online" | "cash" | "declaration">("cash");

  const [requestStates, setRequestStates] = useState<Record<string, RequestState>>({});
  const [submitting, setSubmitting] = useState(false);
  const [withdrawingChildId, setWithdrawingChildId] = useState<string | null>(null);

  const [showPlans, setShowPlans] = useState(false);
  const canShowPlans = showPlans && selectedClass !== null && selectedChildIds.length > 0;

  const [creditsRemaining, setCreditsRemaining] = useState<number | null>(null);
  const [creditsLoadedForChild, setCreditsLoadedForChild] = useState<string | null>(null);

  const [showCreditsUsage, setShowCreditsUsage] = useState(false);
  const [errorMsg, setErrorMsg] = useState<string | null>(null);

  const selectedChildId = selectedChildIds[0] ?? null;
  const clickedMonth = monthOf(initialDateYMD);

  const isPastClicked = useMemo(() => {
    if (!initialDateYMD) return false;
    const d = new Date(initialDateYMD + "T12:00:00");
    const now = new Date();
    const today = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 12, 0, 0, 0);
    return d < today;
  }, [initialDateYMD]);

  /* ================= CREDITS ================= */

  async function loadCredits(forChildId: string) {
    if (!user) return;

    const snap = await getDocsFromServer(
      query(
        collection(db, "entitlements"),
        where("parentId", "==", user.uid),
        where("status", "==", "active")
      )
    );

    const now = Date.now();
    let bestRemaining = 0;
    let hasAny = false;

    snap.forEach((doc) => {
      const data: any = doc.data();
      const entChildId = String(data?.childId || "").trim();

      // bierz parent-scope + child-scope tego dziecka
      if (entChildId && entChildId !== forChildId) return;

      const credits = data?.limits?.credits || {};
      const period = String(credits?.period || "month");
      const total = Number(credits?.amount || 0);
      const unlimited = Boolean(credits?.unlimited);

      if (!unlimited && total <= 0) return;

      const key = usageKeyForPeriod(period, now);
      const used = Number(data?.usage?.credits?.[key] || 0);
      const remaining = unlimited ? 999999 : Math.max(0, total - used);

      bestRemaining = Math.max(bestRemaining, remaining);
      hasAny = true;
    });

    setCreditsLoadedForChild(forChildId);
    setCreditsRemaining(hasAny ? bestRemaining : 0);

    // auto credits, ale nie nadpisuj online
    if (hasAny && bestRemaining > 0) {
      setPaymentMethod((prev) => (prev === "cash" || prev === "declaration" ? "credits" : prev));
    }
  }

  /* ================= LOAD DATA ================= */

  useEffect(() => {
    if (!user || !open || !selectedClass) return;

    setErrorMsg(null);

    getParentProfile(user.uid).then(async (profile) => {
      const kids = profile?.children ?? [];
      setChildren(kids);
      setSelectedChildIds([]);

      const initial: Record<string, RequestState> = {};
      for (const c of kids) initial[c.id] = { state: "loading" };
      setRequestStates(initial);

      for (const c of kids) {
        const req = await getEnrollmentRequestForChild(c.id, selectedClass.id);
        setRequestStates((prev) => ({
          ...prev,
          [c.id]: req ? { state: "loaded", request: req } : { state: "none" },
        }));
      }
    });
  }, [user, open, selectedClass]);

  useEffect(() => {
    if (!open || !user) return;
    if (!selectedChildId) return;
    loadCredits(selectedChildId);
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [open, user, selectedChildId]);

  // credits => max 1 dziecko
  useEffect(() => {
    if (paymentMethod !== "credits") return;
    if (selectedChildIds.length > 1) setSelectedChildIds([selectedChildIds[0]]);
  }, [paymentMethod, selectedChildIds]);

  /* ================= ACTIONS ================= */
  
  function toggleChild(id: string) {
    setSelectedChildIds((prev) => {
      const has = prev.includes(id);
      if (has) return prev.filter((x) => x !== id);

      if (paymentMethod === "credits") return [id];
      return [...prev, id];
    });
  }

  async function enrollWithCredits(childId: string, dates: string[]) {
    if (!user || !selectedClass) return;
    const token = await user.getIdToken();

    const res = await fetch("/api/enrollments/consume", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        Authorization: `Bearer ${token}`,
      },
      body: JSON.stringify({ classId: selectedClass.id, childId, dates }),
    });

    const data = await res.json().catch(() => ({}));
    if (!res.ok) throw new Error(data?.error || "CREDITS_ENROLL_FAILED");

    if (typeof data?.remaining === "number") setCreditsRemaining(data.remaining);
  }

  async function confirmEnrollCashOrDeclaration() {
    if (!user || !selectedClass) return;

    setSubmitting(true);
    setErrorMsg(null);
    try {
      for (const cid of selectedChildIds) {
        setRequestStates((prev) => ({ ...prev, [cid]: { state: "loading" } }));

        await createEnrollmentRequest({
          parentId: user.uid,
          childId: cid,
          classId: selectedClass.id,
          paymentMethod,
        });

        const fresh = await getEnrollmentRequestForChild(cid, selectedClass.id);
        setRequestStates((prev) => ({
          ...prev,
          [cid]: fresh ? { state: "loaded", request: fresh } : { state: "none" },
        }));
      }

      setSelectedChildIds([]);
      onClose();
    } catch (e: any) {
      setErrorMsg(String(e?.message || e));
    } finally {
      setSubmitting(false);
    }
  }

  async function confirmCreditsEnroll(dates: string[]) {
    if (!user || !selectedClass) return;
    if (!selectedChildId) return;

    setSubmitting(true);
    setErrorMsg(null);
    try {
      await enrollWithCredits(selectedChildId, dates);
      await loadCredits(selectedChildId);

      // od≈õwie≈º request dla tego dziecka (≈ºeby badge od razu pokazywa≈Ç nowe daty)
      const fresh = await getEnrollmentRequestForChild(selectedChildId, selectedClass.id);
      setRequestStates((prev) => ({
        ...prev,
        [selectedChildId]: fresh ? { state: "loaded", request: fresh } : { state: "none" },
      }));

      setSelectedChildIds([]);
      onClose();
    } catch (e: any) {
      setErrorMsg(String(e?.message || e));
    } finally {
      setSubmitting(false);
    }
  }

  function handleConfirm() {
    if (paymentMethod === "online") {
      setShowPlans(true);
      return;
    }

    if (paymentMethod === "credits") {
      setShowCreditsUsage(true);
      return;
    }

    confirmEnrollCashOrDeclaration();
  }

  async function handleWithdraw(childId: string) {
    const rs = requestStates[childId];
    if (!rs || rs.state !== "loaded") return;

    setWithdrawingChildId(childId);
    await withdrawEnrollmentRequest(rs.request.id);

    setRequestStates((prev) => ({ ...prev, [childId]: { state: "none" } }));
    setWithdrawingChildId(null);
  }

  /* ================= HELPERS ================= */

  function weekdayLabel(day?: number) {
    const map = {
      1: "Poniedzia≈Çek",
      2: "Wtorek",
      3: "≈öroda",
      4: "Czwartek",
      5: "PiƒÖtek",
      6: "Sobota",
      7: "Niedziela",
    };
    return day ? map[day as keyof typeof map] : "‚Äî";
  }

  function duration(start?: string, end?: string) {
    if (!start || !end) return "‚Äî";
    const [sh, sm] = start.split(":").map(Number);
    const [eh, em] = end.split(":").map(Number);
    return `${eh * 60 + em - (sh * 60 + sm)} min`;
  }

  function StatusBadge({ req }: { req: EnrollmentRequest }) {
    if (req.status === "pending") {
      return (
        <span className="flex items-center gap-1 text-xs bg-yellow-100 text-yellow-800 px-2 py-1 rounded">
          <Hourglass className="w-3 h-3" />
          Oczekuje
        </span>
      );
    }
    if (req.status === "approved") {
      return (
        <span className="flex items-center gap-1 text-xs bg-green-100 text-green-800 px-2 py-1 rounded">
          <CheckCircle2 className="w-3 h-3" />
          Zapisany
        </span>
      );
    }
    if (req.status === "canceled_by_admin") {
      return (
        <span className="flex items-center gap-1 text-xs bg-orange-100 text-orange-800 px-2 py-1 rounded">
          <XCircle className="w-3 h-3" />
          Anulowane przez admina
        </span>
      );
    }
    return (
      <span className="flex items-center gap-1 text-xs bg-red-100 text-red-800 px-2 py-1 rounded">
        <XCircle className="w-3 h-3" />
        Odrzucone
      </span>
    );
  }

  function CreditsBadge({ dates }: { dates: string[] }) {
    if (dates.length === 0) return null;
    console.log("DATES", dates);
    console.log("CLICKED_MONTH", clickedMonth);
    console.log("CLICKED", initialDateYMD);

    const clicked = initialDateYMD ? dates.includes(initialDateYMD) : false;

    const countInMonth = clickedMonth
      ? dates.filter(d => d.startsWith(clickedMonth)).length
      : dates.length;
    if (countInMonth=== 0 ) return null;
    console.log("COUNT_IN_MONTH", countInMonth);

    const inClickedMonth = countInMonth === 0 ? "" : countInMonth;

    console.log("IN_CLICKED_MONTH_FINAL", inClickedMonth);




    if (clicked) {
      return (
        <span className="flex items-center gap-1 text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded">
          Zarezerwowany termin
        </span>
      );
    }

    // je≈õli klikniƒôty miesiƒÖc ma co≈õ, poka≈º count dla tego miesiƒÖca (to usuwa ‚Äúmagiczne ALL‚Äù)
    if (clickedMonth) {
      return null
      // return (
      //   <span className="flex items-center gap-1 text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded">
      //     Zarezerwowane w {clickedMonth}: {inClickedMonth}
      //   </span>
      // );
    }

    return (
      <span className="flex items-center gap-1 text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded">
        Zarezerwowane: {dates.length}
      </span>
    );
  }

  /* ================= UI ================= */

  const showCreditsInfo =
    selectedChildId && creditsLoadedForChild === selectedChildId && creditsRemaining !== null;

  return (
    <>
      <Dialog open={open} onOpenChange={(v) => (!v ? onClose() : null)}>
        <DialogContent className="max-w-2xl space-y-6">
          <DialogHeader>
            <DialogTitle className="text-xl">Zapis na zajƒôcia</DialogTitle>
          </DialogHeader>

          {initialDateYMD && (
            <div className="text-sm text-muted-foreground">
              Klikniƒôty termin: {initialDateYMD}
            </div>
          )}

          <div className="rounded-xl border bg-muted/30 p-5 space-y-3">
            <div className="text-lg font-semibold">{selectedClass?.title}</div>

            {selectedClass?.description && (
              <p className="text-sm text-muted-foreground">{selectedClass.description}</p>
            )}

            <div className="grid grid-cols-2 gap-3 text-sm">
              <div className="flex items-center gap-2">
                <Calendar className="w-4 h-4" />
                {weekdayLabel(selectedClass?.weekday)}
              </div>
              <div className="flex items-center gap-2">
                <Clock className="w-4 h-4" />
                {selectedClass?.startTime} ‚Äì {selectedClass?.endTime} ({duration(selectedClass?.startTime, selectedClass?.endTime)})
              </div>
              <div className="flex items-center gap-2">
                <MapPin className="w-4 h-4" />
                {selectedClass?.location}
              </div>
              <div className="flex items-center gap-2">
                <User className="w-4 h-4" />
                {selectedClass?.instructorName}
              </div>
              <div className="flex items-center gap-2 col-span-2">
                <Repeat className="w-4 h-4" />
                {selectedClass?.recurrence.type === "weekly"
                  ? "Co tydzie≈Ñ"
                  : selectedClass?.recurrence.type === "biweekly"
                  ? "Co dwa tygodnie"
                  : selectedClass?.recurrence.type === "none"
                  ? "Jednorazowe"
                  : "Miesiƒôcznie"}
              </div>
            </div>
          </div>

          <div className="space-y-3">
            <h3 className="text-sm font-medium">Wybierz dzieci</h3>

            {children.map((c) => {
              const rs = requestStates[c.id];

              const req = rs?.state === "loaded" ? rs.request : null;
              const reqDates = req ? safeReqDates(req) : [];
              const isCreditsReq = !!req && ((req as any).paymentMethod === "credits" || reqDates.length > 0);

              // subskrypcja (pending/approved) blokuje checkbox, ale kredyty nie (bo to rezerwacje per data)
              const disabled =
                !isCreditsReq &&
                rs?.state === "loaded" &&
                (rs.request.status === "pending" || rs.request.status === "approved");

              return (
                <div key={c.id} className="flex items-center justify-between rounded-lg border px-4 py-2">
                  <label className="flex items-center gap-3">
                    <Checkbox
                      disabled={disabled}
                      checked={selectedChildIds.includes(c.id)}
                      onCheckedChange={() => toggleChild(c.id)}
                    />
                    {c.firstName} {c.lastName}
                  </label>

                  <div className="flex items-center gap-2">
                    {rs?.state === "loading" && (
                      <span className="flex items-center gap-1 text-xs text-muted-foreground">
                        <Loader2 className="w-3 h-3 animate-spin" />
                        Sprawdzam‚Ä¶
                      </span>
                    )}

                    {rs?.state === "loaded" && req && isCreditsReq && (
                      <CreditsBadge dates={reqDates} />
                    )}

                    {rs?.state === "loaded" && req && !isCreditsReq && (
                      <>
                        <StatusBadge req={req} />
                        {req.status === "pending" && (
                          <Button
                            size="icon"
                            variant="ghost"
                            disabled={withdrawingChildId === c.id}
                            onClick={() => handleWithdraw(c.id)}
                          >
                            {withdrawingChildId === c.id ? (
                              <Loader2 className="w-4 h-4 animate-spin" />
                            ) : (
                              <X className="w-4 h-4" />
                            )}
                          </Button>
                        )}
                      </>
                    )}
                  </div>
                </div>
              );
            })}
          </div>

          {paymentMethod === "credits" && !selectedChildId && (
            <div className="rounded-lg border bg-muted/30 px-3 py-2 text-sm">
              Wybierz dziecko, aby sprawdziƒá dostƒôpne kredyty.
            </div>
          )}

          {paymentMethod === "credits" && showCreditsInfo && (
            <div className="rounded-lg border bg-muted/30 px-3 py-2 text-sm">
              {creditsRemaining! > 0
                ? `Masz dostƒôpne kredyty: ${creditsRemaining}`
                : "Nie masz dostƒôpnych kredyt√≥w w tym okresie."}
            </div>
          )}

          {errorMsg && (
            <div className="rounded-lg border border-red-300 bg-red-50 px-3 py-2 text-sm text-red-700">
              {errorMsg}
            </div>
          )}

          <RadioGroup value={paymentMethod} onValueChange={(v) => setPaymentMethod(v as any)} className="space-y-2">
            {selectedChildId && creditsRemaining !== null && creditsRemaining > 0 && (
              <label className="flex items-center gap-2 text-sm">
                <RadioGroupItem value="credits" />
                U≈ºyj kredytu ({creditsRemaining} dostƒôpne)
              </label>
            )}

            <label className="flex items-center gap-2 text-sm">
              <RadioGroupItem value="online" />
              P≈Çatno≈õƒá online
            </label>

            <label className="flex items-center gap-2 text-sm">
              <RadioGroupItem value="cash" />
              Got√≥wka
            </label>

            <label className="flex items-center gap-2 text-sm">
              <RadioGroupItem value="declaration" />
              Deklaracja
            </label>
          </RadioGroup>

          <AlertDialog>
            <AlertDialogTrigger asChild>
              <Button className="w-full" disabled={selectedChildIds.length === 0 || submitting || isPastClicked}>
                {submitting && <Loader2 className="w-4 h-4 mr-2 animate-spin" />}
                {paymentMethod === "credits" ? "Dalej (wyb√≥r termin√≥w)" : "Wy≈õlij zg≈Çoszenie"}
              </Button>
            </AlertDialogTrigger>

            <AlertDialogContent>
              <AlertDialogHeader>
                <AlertDialogTitle>Potwierdzenie</AlertDialogTitle>
                <AlertDialogDescription>
                  {paymentMethod === "credits"
                    ? "Wybierzesz terminy do rezerwacji w kolejnym kroku."
                    : "Czy na pewno chcesz wys≈Çaƒá zg≈Çoszenie?"}
                </AlertDialogDescription>
              </AlertDialogHeader>

              <AlertDialogFooter>
                <AlertDialogCancel>Anuluj</AlertDialogCancel>
                <AlertDialogAction onClick={handleConfirm}>Dalej</AlertDialogAction>
              </AlertDialogFooter>
            </AlertDialogContent>
          </AlertDialog>

          {canShowPlans && (
            <PurchasePlanModal
              open={showPlans}
              onClose={() => setShowPlans(false)}
              context={{
                type: "class_enrollment",
                classId: selectedClass!.id,
                childId: selectedChildIds[0],
                dateYMD: initialDateYMD ?? undefined,
              }}
              onSuccess={async ({ paymentIntentId }) => {
                try {
                  const res = await fetch("/api/payments/tpay/create", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ intentId: paymentIntentId }),
                  });

                  const data = await res.json().catch(() => ({}));
                  if (!res.ok) {
                    console.error("TPAY OPENAPI ERROR", data);
                    return;
                  }

                  window.location.href = data.paymentUrl;
                } catch (e) {
                  console.error("TPAY OPENAPI EXCEPTION", e);
                }
              }}
            />
          )}
        </DialogContent>
      </Dialog>
      {isPastClicked && (
        <div className="rounded-lg border border-orange-300 bg-orange-50 px-3 py-2 text-sm text-orange-800">
          Ten termin jest w przesz≈Ço≈õci ‚Äî nie mo≈ºna siƒô zapisaƒá.
        </div>
      )}

      {selectedClass && selectedChildId && creditsRemaining !== null && (
        <CreditsUsageModal
          open={showCreditsUsage}
          onClose={() => setShowCreditsUsage(false)}
          selectedClass={selectedClass}
          creditsRemaining={creditsRemaining}
          initialDateYMD={initialDateYMD}
          onConfirm={(dates) => {
            setShowCreditsUsage(false);
            confirmCreditsEnroll(dates);
          }}
        />
      )}
    </>
  );
}

--- FILE: components/user-classes/UserWeekCalendar.tsx ---
"use client";

import { useEffect, useMemo, useState } from "react";
import type { Class } from "@/types/classes";
import type { Enrollment, Child } from "@/types";

import { getActiveClasses } from "@/services/classes.service";
import { getParentEnrollments } from "@/services/enrollments.service";
import { getParentReservationsInRange, type Reservation } from "@/services/reservations.service";
import { getChildrenForParent } from "@/services/children.service";

import { useAuth } from "@/components/auth/AuthProvider";
import { Button } from "@/components/ui/button";
import { cn } from "@/lib/utils";

import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { EnrollModal } from "@/components/user-classes/EnrollModal";

const START_HOUR = 8;
const END_HOUR = 20;
const SLOT_MIN = 30;

function pad2(n: number) {
  return n < 10 ? `0${n}` : `${n}`;
}

function parseYMD(ymd: string): Date {
  const [y, m, d] = ymd.split("-").map(Number);
  return new Date(y, (m ?? 1) - 1, d ?? 1, 12, 0, 0, 0);
}

function formatYMD(d: Date): string {
  return `${d.getFullYear()}-${pad2(d.getMonth() + 1)}-${pad2(d.getDate())}`;
}

function startOfWeekMonday(date: Date): Date {
  const d = new Date(date);
  const day = d.getDay();
  const diff = day === 0 ? -6 : 1 - day;
  d.setDate(d.getDate() + diff);
  d.setHours(12, 0, 0, 0);
  return d;
}

function addDays(date: Date, days: number): Date {
  const d = new Date(date);
  d.setDate(d.getDate() + days);
  return d;
}

function timeToMinutes(t: string): number {
  const [hh, mm] = t.split(":").map(Number);
  return (hh ?? 0) * 60 + (mm ?? 0);
}

function minutesToRow(minSinceStart: number) {
  return Math.floor(minSinceStart / SLOT_MIN) + 1;
}

function weeksBetween(a: Date, b: Date): number {
  const ms = (b.getTime() - a.getTime()) / (1000 * 60 * 60 * 24);
  return Math.floor(ms / 7);
}

function weekIndexInMonth(d: Date): number {
  return Math.floor((d.getDate() - 1) / 7) + 1;
}

function isClassOnDate(cls: Class, dateYMD: string): boolean {
  if (!cls?.recurrence?.startDate) return false;

  const date = parseYMD(dateYMD);
  const start = parseYMD(cls.recurrence.startDate);
  const end = cls.recurrence.endDate ? parseYMD(cls.recurrence.endDate) : null;

  if (date < start) return false;
  if (end && date > end) return false;

  const jsDay = date.getDay();
  const weekday = jsDay === 0 ? 7 : jsDay;
  if (weekday !== cls.weekday) return false;

  const interval = Math.max(1, cls.recurrence.interval || 1);

  if (cls.recurrence.type === "none") {
    return start.getTime() === date.getTime();
  }

  if (cls.recurrence.type === "weekly" || cls.recurrence.type === "biweekly") {
    const w = weeksBetween(startOfWeekMonday(start), startOfWeekMonday(date));
    return w % interval === 0;
  }

  if (cls.recurrence.type === "monthly") {
    const targetWeek = weekIndexInMonth(start);
    const currentWeek = weekIndexInMonth(date);
    if (currentWeek !== targetWeek) return false;

    const months = (date.getFullYear() - start.getFullYear()) * 12 + (date.getMonth() - start.getMonth());
    return months % interval === 0;
  }

  return false;
}

type CalendarEvent = Class & {
  dateYMD: string;
  col: number;
  rowStart: number;
  rowSpan: number;
  bookedKind?: "subscription" | "reservation";
};

function safeDatesFromEnrollment(e: Enrollment): string[] {
  const raw = (e as any)?.dates;
  if (!Array.isArray(raw)) return [];
  return raw.map((x) => String(x || "").trim()).filter((x) => /^\d{4}-\d{2}-\d{2}$/.test(x));
}

function isPastYMD(dateYMD: string) {
  const d = parseYMD(dateYMD);
  const now = new Date();
  const today = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 12, 0, 0, 0);
  return d < today;
}

export function UserWeekCalendar({ refreshTick = 0 }: { refreshTick?: number }) {
  const { user, loading: authLoading } = useAuth();

  const [classes, setClasses] = useState<Class[]>([]);
  const [enrollments, setEnrollments] = useState<Enrollment[]>([]);
  const [reservations, setReservations] = useState<Reservation[]>([]);
  const [children, setChildren] = useState<Child[]>([]);
  const [selectedChildId, setSelectedChildId] = useState<string>("all");

  const [loading, setLoading] = useState(true);
  const [anchorDate, setAnchorDate] = useState(() => new Date());

  const [selectedEvent, setSelectedEvent] = useState<{ cls: Class; dateYMD: string } | null>(null);

  const weekStart = useMemo(() => startOfWeekMonday(anchorDate), [anchorDate]);
  const days = useMemo(() => Array.from({ length: 7 }, (_, i) => addDays(weekStart, i)), [weekStart]);

  const weekFromYMD = useMemo(() => formatYMD(weekStart), [weekStart]);
  const weekToYMD = useMemo(() => formatYMD(addDays(weekStart, 6)), [weekStart]);

  useEffect(() => {
    if (!user) return;

    setLoading(true);

    Promise.all([
      getActiveClasses(),
      getParentEnrollments(user.uid),
      getChildrenForParent(user.uid),
      getParentReservationsInRange({ parentId: user.uid, fromYMD: weekFromYMD, toYMD: weekToYMD }),
    ])
      .then(([allClasses, parentEnrollments, kids, weekReservations]) => {
        setClasses(allClasses);
        setEnrollments(parentEnrollments);
        setChildren(kids);
        setReservations(weekReservations);
      })
      .finally(() => setLoading(false));
  }, [user, refreshTick, weekFromYMD, weekToYMD]);

  const slotsCount = ((END_HOUR - START_HOUR) * 60) / SLOT_MIN;

  // --- ENROLLMENTS: rozdziel subskrypcje (bez dates) vs kredyty (z dates) ---
  const subscriptionEnrollments = useMemo(() => {
    return enrollments.filter((e) => safeDatesFromEnrollment(e).length === 0);
  }, [enrollments]);

  const dateEnrollments = useMemo(() => {
    return enrollments.filter((e) => safeDatesFromEnrollment(e).length > 0);
  }, [enrollments]);

  // subscription: childId__classId
  const subSetAll = useMemo(() => {
    return new Set(subscriptionEnrollments.map((e: any) => `${e.childId}__${e.classId}`));
  }, [subscriptionEnrollments]);

  // subscription: classId (any child)
  const subClassSetAny = useMemo(() => {
    return new Set(subscriptionEnrollments.map((e: any) => `${e.classId}`));
  }, [subscriptionEnrollments]);

  // date-enrollments (credits): childId__classId__date
  const dateEnrollSetAll = useMemo(() => {
    const out: string[] = [];
    for (const e of dateEnrollments as any[]) {
      const dates = safeDatesFromEnrollment(e as Enrollment);
      for (const d of dates) out.push(`${e.childId}__${e.classId}__${d}`);
    }
    return new Set(out);
  }, [dateEnrollments]);

  // date-enrollments (credits): classId__date (any child)
  const dateEnrollSetAny = useMemo(() => {
    const out: string[] = [];
    for (const e of dateEnrollments as any[]) {
      const dates = safeDatesFromEnrollment(e as Enrollment);
      for (const d of dates) out.push(`${e.classId}__${d}`);
    }
    return new Set(out);
  }, [dateEnrollments]);

  // reservations (kolekcja per-date): childId__classId__date
  const reservationSetAll = useMemo(() => {
    return new Set(reservations.map((r) => `${r.childId}__${r.classId}__${r.dateYMD}`));
  }, [reservations]);

  // reservations: classId__date (any child)
  const reservationSetAny = useMemo(() => {
    return new Set(reservations.map((r) => `${r.classId}__${r.dateYMD}`));
  }, [reservations]);

  const allEvents = useMemo(() => {
    const out: CalendarEvent[] = [];

    for (let dayIdx = 0; dayIdx < 7; dayIdx++) {
      const dateYMD = formatYMD(days[dayIdx]);

      for (const cls of classes) {
        if (!isClassOnDate(cls, dateYMD)) continue;

        const startMin = timeToMinutes(cls.startTime) - START_HOUR * 60;
        const endMin = timeToMinutes(cls.endTime) - START_HOUR * 60;

        const rowStart = minutesToRow(Math.max(0, startMin));
        const rowSpan = Math.max(1, Math.ceil((endMin - startMin) / SLOT_MIN));

        // --- czy to jest zapisane (SUB) albo zarezerwowane (DATE) dla tej daty ---
        let isSubscribed = false;
        let isReserved = false;

        if (selectedChildId === "all") {
          isSubscribed = subClassSetAny.has(cls.id);
          isReserved =
            reservationSetAny.has(`${cls.id}__${dateYMD}`) ||
            dateEnrollSetAny.has(`${cls.id}__${dateYMD}`);
        } else {
          isSubscribed = subSetAll.has(`${selectedChildId}__${cls.id}`);
          isReserved =
            reservationSetAll.has(`${selectedChildId}__${cls.id}__${dateYMD}`) ||
            dateEnrollSetAll.has(`${selectedChildId}__${cls.id}__${dateYMD}`);
        }

        const bookedKind: CalendarEvent["bookedKind"] = isSubscribed
          ? "subscription"
          : isReserved
          ? "reservation"
          : undefined;

        out.push({
          ...cls,
          dateYMD,
          col: dayIdx + 2,
          rowStart: rowStart + 1,
          rowSpan,
          bookedKind,
        });
      }
    }

    return out;
  }, [
    classes,
    days,
    selectedChildId,
    subClassSetAny,
    subSetAll,
    reservationSetAny,
    reservationSetAll,
    dateEnrollSetAny,
    dateEnrollSetAll,
  ]);

  // masz jakie≈õ booking w og√≥le?
  const hasAnyBookingsOverall = useMemo(() => {
    if (reservations.length > 0) return true;
    // jakiekolwiek enrollmenty te≈º liczymy
    return enrollments.length > 0;
  }, [reservations.length, enrollments.length]);

  // masz co≈õ "zapisane" w tym tygodniu (dla aktualnego filtra dziecka)?
  const hasAnyBookedInWeek = useMemo(() => {
    return allEvents.some((e) => !!e.bookedKind);
  }, [allEvents]);

  // zachowujemy Tw√≥j UX: gdy masz booking w tym tygodniu => filtruj do "moich"
  const visibleEvents = useMemo(() => {
    if (hasAnyBookingsOverall && hasAnyBookedInWeek) return allEvents.filter((e) => !!e.bookedKind);
    return allEvents;
  }, [allEvents, hasAnyBookingsOverall, hasAnyBookedInWeek]);

  const rangeLabel = useMemo(() => {
    const end = addDays(weekStart, 6);
    return `${weekStart.getDate()} ${weekStart.toLocaleString("pl-PL", { month: "short" })} ‚Äì ${end.getDate()} ${end.toLocaleString("pl-PL", { month: "short" })}`;
  }, [weekStart]);

  if (authLoading) return <div className="text-sm text-muted-foreground">≈Åadowanie‚Ä¶</div>;
  if (!user) return <div className="text-sm text-muted-foreground">Musisz byƒá zalogowany, aby zobaczyƒá plan zajƒôƒá.</div>;

  return (
    <div className="space-y-4">
      <div className="flex items-center justify-between gap-3">
        <div className="flex flex-wrap items-center gap-2">
          <Select value={selectedChildId} onValueChange={setSelectedChildId}>
            <SelectTrigger className="w-[220px]">
              <SelectValue placeholder="Wszystkie dzieci" />
            </SelectTrigger>
            <SelectContent>
              <SelectItem value="all">Wszystkie dzieci</SelectItem>
              {children.map((c) => (
                <SelectItem key={c.id} value={c.id}>
                  {c.firstName} {c.lastName}
                </SelectItem>
              ))}
            </SelectContent>
          </Select>

          <Button variant="outline" onClick={() => setAnchorDate(new Date())}>Dzi≈õ</Button>
          <Button variant="outline" onClick={() => setAnchorDate(addDays(anchorDate, -7))}>‚Üê</Button>
          <Button variant="outline" onClick={() => setAnchorDate(addDays(anchorDate, 7))}>‚Üí</Button>

          <div className="font-medium ml-2">{rangeLabel}</div>
        </div>

        <div className="text-sm text-muted-foreground">
          {loading ? "≈Åadowanie‚Ä¶" : `Zajƒôƒá: ${visibleEvents.length}`}
        </div>
      </div>

      {!loading && children.length === 0 && (
        <div className="text-sm text-orange-600">
          Nie masz dodanych dzieci. Dodaj dziecko w zak≈Çadce ‚ÄûDzieci‚Äù, aby m√≥c zapisywaƒá na zajƒôcia.
        </div>
      )}

      {!loading && !hasAnyBookingsOverall && (
        <div className="text-sm text-muted-foreground">
          Brak zapis√≥w/rezerwacji ‚Äî pokazujƒô wszystkie dostƒôpne zajƒôcia. Kliknij zajƒôcia, aby zapisaƒá dziecko.
        </div>
      )}

      {!loading && hasAnyBookingsOverall && !hasAnyBookedInWeek && (
        <div className="text-sm text-muted-foreground">
          Masz rezerwacje / zapisy, ale nie w tym tygodniu ‚Äî pokazujƒô wszystkie dostƒôpne zajƒôcia.
        </div>
      )}

      <div
        className="relative border rounded-xl bg-background overflow-hidden"
        style={{
          display: "grid",
          gridTemplateColumns: "80px repeat(7, minmax(0, 1fr))",
          gridTemplateRows: `48px repeat(${slotsCount}, 28px)`,
        }}
      >
        <div className="border-b bg-muted/40" />
        {days.map((d, i) => (
          <div key={i} className="border-b border-l bg-muted/40 flex items-center justify-center text-sm font-medium">
            {d.toLocaleDateString("pl-PL", { weekday: "short", day: "2-digit", month: "2-digit" })}
          </div>
        ))}

        {Array.from({ length: slotsCount }).map((_, slotIdx) =>
          days.map((_, dayIdx) => (
            <div key={`${slotIdx}-${dayIdx}`} className={cn("border-t border-l transition", "hover:bg-muted/30")} />
          ))
        )}

        {visibleEvents.map((ev) => {
  const past = isPastYMD(ev.dateYMD);

  return (
    <button
      key={`${ev.id}-${ev.dateYMD}`}
      type="button"
      disabled={past}
      onClick={() => {
        if (past) return;
        setSelectedEvent({ cls: ev as unknown as Class, dateYMD: ev.dateYMD });
      }}
      className={cn(
        "border border-black/10 rounded-lg px-2 py-1 text-xs overflow-hidden text-left",
        "shadow-sm transition-all duration-200 ease-out",
        past
          ? "opacity-40 cursor-not-allowed"
          : "cursor-pointer hover:shadow-md hover:scale-[1.02] hover:opacity-90 hover:ring-2 hover:ring-primary/30 active:scale-[0.98]"
      )}
      style={{
        gridColumn: `${ev.col}`,
        gridRow: `${ev.rowStart} / ${ev.rowStart + ev.rowSpan}`,
        background: ev.color || "#e5e7eb",
      }}
      title={past ? "To zajƒôcia ju≈º siƒô odby≈Çy" : "Kliknij, aby zobaczyƒá szczeg√≥≈Çy / zapisaƒá"}
    >
            <div className="font-medium leading-tight flex items-center justify-between gap-2">
              <span>{ev.title}</span>
              {ev.bookedKind === "reservation" && (
                <span className="text-[10px] px-1.5 py-0.5 rounded bg-black/10">rezerw.</span>
              )}
              {ev.bookedKind === "subscription" && (
                <span className="text-[10px] px-1.5 py-0.5 rounded bg-black/10">sub</span>
              )}
            </div>
            <div className="opacity-80 leading-tight">{ev.startTime}‚Äì{ev.endTime}</div>
            <div className="opacity-70 leading-tight">{ev.instructorName}</div>
          </button>
        )})}

      </div>

      <EnrollModal
        open={!!selectedEvent}
        selectedClass={selectedEvent?.cls ?? null}
        initialDateYMD={selectedEvent?.dateYMD ?? null}
        onClose={() => setSelectedEvent(null)}
      />
    </div>
  );
}

--- FILE: components/user-classes/AvailableClassesTab.tsx ---
"use client";

import { useEffect, useState } from "react";
import { getActiveClasses } from "@/services/classes.service";
import type { Class, Child } from "@/types";
import { Button } from "@/components/ui/button";
import { EnrollModal } from "./EnrollModal";

export function AvailableClassesTab() {
  const [classes, setClasses] = useState<Class[]>([]);
  const [loading, setLoading] = useState(true);
  const [selectedClass, setSelectedClass] = useState<Class | null>(null);

  useEffect(() => {
    getActiveClasses()
      .then(setClasses)
      .finally(() => setLoading(false));
  }, []);

  if (loading) {
    return <div>≈Åadowanie zajƒôƒá...</div>;
  }

  return (
    <div className="space-y-4">
      {classes.map((c) => (
        <div
          key={c.id}
          className="border rounded-lg p-4 flex items-center justify-between"
        >
          <div>
            <div className="font-medium">{c.title}</div>
            <div className="text-sm text-muted-foreground">
              {c.weekday} ‚Ä¢ {c.startTime}‚Äì{c.endTime}
            </div>
          </div>

          <Button onClick={() => setSelectedClass(c)}>
            Zapisz dziecko
          </Button>
        </div>
      ))}

      <EnrollModal
        open={!!selectedClass}
        selectedClass={selectedClass}
        onClose={() => setSelectedClass(null)}
      />
    </div>
  );
}

--- FILE: components/user-classes/CreditsUsageModal.tsx ---
"use client";

import { useEffect, useMemo, useState } from "react";
import type { Class } from "@/types";
import { Dialog, DialogContent, DialogHeader, DialogTitle } from "@/components/ui/dialog";
import { Button } from "@/components/ui/button";
import { Checkbox } from "@/components/ui/checkbox";
import { Card, CardContent, CardHeader } from "@/components/ui/card";
import { Badge } from "@/components/ui/badge";
import { Separator } from "@/components/ui/separator";

function pad2(n: number) {
  return String(n).padStart(2, "0");
}

function parseYMD(ymd: string) {
  const [y, m, d] = ymd.split("-").map(Number);
  return new Date(y, (m ?? 1) - 1, d ?? 1, 12, 0, 0, 0);
}

function formatYMD(d: Date) {
  return `${d.getFullYear()}-${pad2(d.getMonth() + 1)}-${pad2(d.getDate())}`;
}

function addDays(d: Date, days: number) {
  const x = new Date(d);
  x.setDate(x.getDate() + days);
  return x;
}

function startOfWeekMonday(date: Date): Date {
  const d = new Date(date);
  const day = d.getDay();
  const diff = day === 0 ? -6 : 1 - day;
  d.setDate(d.getDate() + diff);
  d.setHours(12, 0, 0, 0);
  return d;
}

function weeksBetween(a: Date, b: Date): number {
  const ms = (b.getTime() - a.getTime()) / (1000 * 60 * 60 * 24);
  return Math.floor(ms / 7);
}

function weekIndexInMonth(d: Date): number {
  return Math.floor((d.getDate() - 1) / 7) + 1;
}

// identyczna logika jak w kalendarzu (weekly/biweekly/monthly/none)
function isClassOnDate(cls: Class, dateYMD: string): boolean {
  const r = cls.recurrence;
  if (!r?.startDate) return false;

  const date = parseYMD(dateYMD);
  const start = parseYMD(r.startDate);
  const end = r.endDate ? parseYMD(r.endDate) : null;

  if (date < start) return false;
  if (end && date > end) return false;

  const jsDay = date.getDay();
  const weekday = jsDay === 0 ? 7 : jsDay;
  if (weekday !== cls.weekday) return false;

  const interval = Math.max(1, r.interval || 1);

  if (r.type === "none") {
    return startOfWeekMonday(start).getTime() === startOfWeekMonday(date).getTime();
  }

  if (r.type === "weekly" || r.type === "biweekly") {
    const w = weeksBetween(startOfWeekMonday(start), startOfWeekMonday(date));
    return w % interval === 0;
  }

  if (r.type === "monthly") {
    const targetWeek = weekIndexInMonth(start);
    const currentWeek = weekIndexInMonth(date);
    if (currentWeek !== targetWeek) return false;

    const months = (date.getFullYear() - start.getFullYear()) * 12 + (date.getMonth() - start.getMonth());
    return months % interval === 0;
  }

  return false;
}

function prettyLabel(ymd: string) {
  const d = parseYMD(ymd);
  const dow = d.toLocaleDateString("pl-PL", { weekday: "short" });
  const dm = d.toLocaleDateString("pl-PL", { day: "2-digit", month: "2-digit" });
  return `${dow} ${dm}`;
}

function occurrencesInMonth(c: Class, baseTs = Date.now()) {
   const base = new Date(baseTs);
  const now = new Date(Date.now());
  const today = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 12, 0, 0, 0);

  const monthStart = new Date(base.getFullYear(), base.getMonth(), 1, 12, 0, 0, 0);
  const monthEnd = new Date(base.getFullYear(), base.getMonth() + 1, 0, 12, 0, 0, 0);
  const out: string[] = [];
  let d = monthStart;

  while (d <= monthEnd) {
    if (d >= today) {
      const ymd = formatYMD(d);
      if (isClassOnDate(c, ymd)) out.push(ymd);
    }
    d = addDays(d, 1);
  }

  return out.sort();
}

type Props = {
  open: boolean;
  onClose: () => void;
  selectedClass: Class;
  creditsRemaining: number;
  onConfirm: (dates: string[]) => void;
  initialDateYMD?: string | null; // klik z kalendarza
};

export function CreditsUsageModal({
  open,
  onClose,
  selectedClass,
  creditsRemaining,
  onConfirm,
  initialDateYMD = null,
}: Props) {
 
  const baseTs = useMemo(() => {
    return initialDateYMD ? parseYMD(initialDateYMD).getTime() : Date.now();
  }, [initialDateYMD]);

  const dates = useMemo(() => occurrencesInMonth(selectedClass, baseTs), [selectedClass, baseTs]);


  const nearest = useMemo(() => (dates[0] ? [dates[0]] : []), [dates]);
  const maxAllCount = Math.min(dates.length, Math.max(0, creditsRemaining));
  const allUpToLimit = useMemo(() => dates.slice(0, maxAllCount), [dates, maxAllCount]);
  
  const defaultSelection = useMemo(() => {
    if (initialDateYMD && dates.includes(initialDateYMD)) return [initialDateYMD];
    return nearest;
  }, [initialDateYMD, dates, nearest]);

  const [manual, setManual] = useState<string[]>(defaultSelection);

  useEffect(() => {
    if (!open) return;
    setManual(defaultSelection);
  }, [open, defaultSelection]);

  function toggle(d: string) {
    setManual((prev) => {
      const has = prev.includes(d);
      if (has) return prev.filter((x) => x !== d);

      if (prev.length >= creditsRemaining) return prev;
      return [...prev, d];
    });
  }

  const manualSorted = useMemo(() => [...manual].sort(), [manual]);
  const canConfirmManual = manualSorted.length > 0 && manualSorted.length <= creditsRemaining;

  const canNearest = nearest.length > 0 && creditsRemaining >= 1;
  const canAll = allUpToLimit.length > 0 && creditsRemaining >= 1;

  return (
    <Dialog open={open} onOpenChange={(v) => (!v ? onClose() : null)}>
      <DialogContent className="sm:max-w-lg">
        <DialogHeader>
          <DialogTitle>Jak wykorzystaƒá kredyty?</DialogTitle>
        </DialogHeader>

        <Card className="border-muted">
          <CardHeader className="pb-3">
            <div className="flex items-center justify-between gap-2">
              <div className="text-sm text-muted-foreground">Wybierz terminy do rezerwacji</div>
              <Badge variant={creditsRemaining > 0 ? "default" : "secondary"}>
                Kredyty: {creditsRemaining}
              </Badge>
            </div>
          </CardHeader>

          <CardContent className="space-y-4">
            {dates.length === 0 ? (
              <div className="text-sm text-muted-foreground">
                Brak termin√≥w w tym miesiƒÖcu (albo wszystkie sƒÖ w przesz≈Ço≈õci).
              </div>
            ) : (
              <>
                <div className="space-y-2">
                  <Button
                    variant="outline"
                    className="w-full justify-between"
                    disabled={!canNearest}
                    onClick={() => onConfirm(nearest)}
                  >
                    <span>Tylko najbli≈ºszy termin</span>
                    <span className="text-xs text-muted-foreground">
                      1 kredyt {nearest[0] ? `‚Ä¢ ${prettyLabel(nearest[0])}` : ""}
                    </span>
                  </Button>

                  <Button
                    variant="outline"
                    className="w-full justify-between"
                    disabled={!canAll}
                    onClick={() => onConfirm(allUpToLimit)}
                  >
                    <span>Wszystkie terminy w tym miesiƒÖcu</span>
                    <span className="text-xs text-muted-foreground">
                      {allUpToLimit.length} / {dates.length}
                    </span>
                  </Button>

                  <div className="text-xs text-muted-foreground">
                    (Je≈õli masz mniej kredyt√≥w ni≈º termin√≥w, rezerwujemy pierwsze {maxAllCount}.)
                  </div>
                </div>

                <Separator />

                <div className="space-y-2">
                  <div className="flex items-center justify-between">
                    <div className="text-sm font-medium">Wyb√≥r rƒôczny</div>
                    <div className="text-xs text-muted-foreground">
                      Wybrano: {manualSorted.length}/{creditsRemaining}
                    </div>
                  </div>

                  <div className="grid grid-cols-2 gap-2">
                    {dates.map((d) => {
                      const checked = manual.includes(d);
                      const disabled = !checked && manual.length >= creditsRemaining;

                      return (
                        <label
                          key={d}
                          className="flex items-center gap-2 rounded-md border px-2 py-2 text-sm hover:bg-muted/40"
                        >
                          <Checkbox checked={checked} disabled={disabled} onCheckedChange={() => toggle(d)} />
                          <div className="flex flex-col leading-tight">
                            <span className="font-medium">{prettyLabel(d)}</span>
                            <span className="text-xs text-muted-foreground">{d}</span>
                          </div>
                        </label>
                      );
                    })}
                  </div>

                  {!canConfirmManual && (
                    <div className="text-xs text-muted-foreground">Wybierz 1‚Ä¶{creditsRemaining} termin√≥w.</div>
                  )}

                  <div className="flex items-center justify-end gap-2 pt-2">
                    <Button variant="ghost" onClick={onClose}>
                      Anuluj
                    </Button>
                    <Button disabled={!canConfirmManual} onClick={() => onConfirm(manualSorted)}>
                      Zarezerwuj ({manualSorted.length})
                    </Button>
                  </div>
                </div>
              </>
            )}
          </CardContent>
        </Card>
      </DialogContent>
    </Dialog>
  );
}

--- FILE: components/classes/ChildFilterSelect.tsx ---

--- FILE: components/classes/PaymentReturnBanner.tsx ---
"use client";

import { useEffect, useMemo, useRef, useState } from "react";
import { useRouter, useSearchParams } from "next/navigation";
import { doc, getDoc, onSnapshot, collection, query, where, getDocs, limit } from "firebase/firestore";
import { db } from "@/lib/firebase/client";
import { Button } from "@/components/ui/button";
import { Loader2, CheckCircle2, XCircle } from "lucide-react";

type BannerState = "idle" | "pending" | "success" | "error";

export function PaymentReturnBanner(props: { onFinalized?: () => void }) {
  const { onFinalized } = props;

  const sp = useSearchParams();
  const router = useRouter();

  const payment = sp.get("payment"); // success | error
  const intentId = sp.get("intent");

  const [state, setState] = useState<BannerState>("idle");
  const [msg, setMsg] = useState<string | null>(null);
  const [details, setDetails] = useState<string | null>(null);

  const doneRef = useRef(false);
  const onFinalizedRef = useRef(onFinalized);

  useEffect(() => {
    onFinalizedRef.current = onFinalized;
  }, [onFinalized]);

  const cleanUrl = useMemo(() => "/dashboard/classes", []);

  useEffect(() => {
    if (!payment || !intentId) return;

    doneRef.current = false;
    setDetails(null);

    let unsub: (() => void) | null = null;
    let clearTimer: any = null;
    let fallbackTimer: any = null;

    const clearQuerySoon = (delayMs: number) => {
      if (clearTimer) clearTimeout(clearTimer);
      clearTimer = setTimeout(() => router.replace(cleanUrl), delayMs);
    };

    const safeSet = (nextState: BannerState, nextMsg: string, nextDetails?: string | null) => {
      if (doneRef.current) return;
      setState(nextState);
      setMsg(nextMsg);
      if (typeof nextDetails !== "undefined") setDetails(nextDetails);
    };

    // payment=error
    if (payment === "error") {
      doneRef.current = true;
      safeSet("error", "‚ùå P≈Çatno≈õƒá nieudana lub anulowana.");
      clearQuerySoon(3500);
      return () => clearTimer && clearTimeout(clearTimer);
    }

    safeSet("pending", "‚è≥ P≈Çatno≈õƒá przyjƒôta. Czekamy na potwierdzenie‚Ä¶");

    const intentRef = doc(db, "payment_intents", intentId);

    // ‚úÖ 1) Najpierw jednorazowy odczyt (≈Çapie stan nawet je≈õli webhook ju≈º zdƒÖ≈ºy≈Ç)
    (async () => {
      try {
        const snap = await getDoc(intentRef);
        if (snap.exists()) {
          const data: any = snap.data();
          const status = String(data?.status || "");
          const finalizedAt = data?.finalizedAt;

          if (finalizedAt) {
            doneRef.current = true;
            setState("success");
            setMsg("‚úÖ Gotowe. Zapisy zosta≈Çy zaktualizowane.");
            onFinalizedRef.current?.();
            clearQuerySoon(1200);
            return;
          }

          if (status === "failed" || status === "cancelled") {
            doneRef.current = true;
            safeSet("error", "‚ùå P≈Çatno≈õƒá oznaczona jako nieudana.");
            clearQuerySoon(3000);
            return;
          }
        }
      } catch (e: any) {
        // np. adblock / permission
        setDetails("Nie mogƒô odczytaƒá statusu p≈Çatno≈õci (blokada / rules). Spr√≥bujƒô potwierdziƒá zapis inaczej‚Ä¶");
      }
    })();

    // ‚úÖ 2) Snapshot (na ≈ºywo)
    unsub = onSnapshot(
      intentRef,
      (snap) => {
        if (!snap.exists()) return;

        const data: any = snap.data();
        const status = String(data?.status || "");
        const finalizedAt = data?.finalizedAt;

        if (status === "paid" && !finalizedAt) {
          safeSet("pending", "‚úÖ P≈Çatno≈õƒá potwierdzona. Finalizujemy zapis‚Ä¶");
          return;
        }

        if (finalizedAt) {
          doneRef.current = true;
          setState("success");
          setMsg("‚úÖ Gotowe. Zapisy zosta≈Çy zaktualizowane.");
          onFinalizedRef.current?.();
          clearQuerySoon(1200);
          return;
        }

        if (status === "failed" || status === "cancelled") {
          doneRef.current = true;
          safeSet("error", "‚ùå P≈Çatno≈õƒá oznaczona jako nieudana.");
          clearQuerySoon(3000);
        }
      },
      (err) => {
        setDetails("Nie mogƒô s≈Çuchaƒá statusu p≈Çatno≈õci (blokada / rules).");
      }
    );

    // ‚úÖ 3) Fallback po 6s: je≈õli intent nie dochodzi, a zapis ju≈º jest (enrollment istnieje) -> poka≈º sukces
    fallbackTimer = setTimeout(async () => {
      if (doneRef.current) return;

      try {
        // spr√≥buj odczytaƒá intent (mo≈ºe ju≈º jest finalizedAt)
        const intentSnap = await getDoc(intentRef);
        const data: any = intentSnap.data() || {};
        const finalizedAt = data?.finalizedAt;

        if (finalizedAt) {
          doneRef.current = true;
          setState("success");
          setMsg("‚úÖ P≈Çatno≈õƒá potwierdzona.");
          onFinalizedRef.current?.();
          clearQuerySoon(1200);
          return;
        }

        // je≈õli nie mo≈ºemy polegaƒá na finalizedAt (rules/adblock), spr√≥buj potwierdziƒá skutki:
        // 1) one-off class -> enrollment
        const classId = String(data?.metadata?.classId || "");
        const childId = String(data?.metadata?.childId || "");

        if (classId && childId) {
          const enrollSnap = await getDocs(
            query(
              collection(db, "enrollments"),
              where("classId", "==", classId),
              where("childId", "==", childId),
              limit(1)
            )
          );

          if (!enrollSnap.empty) {
            doneRef.current = true;
            setState("success");
            setMsg("‚úÖ Zapis na zajƒôcia zosta≈Ç potwierdzony.");
            onFinalizedRef.current?.();
            clearQuerySoon(1200);
            return;
          }
        }

        // 2) monthly/other -> entitlement (u Ciebie entitlements docId = intentId)
        const entSnap = await getDoc(doc(db, "entitlements", intentId));
        if (entSnap.exists()) {
          doneRef.current = true;
          setState("success");
          setMsg("‚úÖ Subskrypcja aktywna. Dostƒôp zosta≈Ç nadany.");
          onFinalizedRef.current?.();
          clearQuerySoon(1200);
          return;
        }
      } catch (e) {
        setDetails((d) => d || "WyglƒÖda na to, ≈ºe co≈õ blokuje po≈ÇƒÖczenie z Firestore (np. adblock).");
      }

      setState("pending");
      setMsg("‚è≥ Nadal czekamy na potwierdzenie. Je≈õli trwa to d≈Çugo, od≈õwie≈º stronƒô.");
    }, 6000);


    return () => {
      if (unsub) unsub();
      if (fallbackTimer) clearTimeout(fallbackTimer);
      if (clearTimer) clearTimeout(clearTimer);
    };
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [payment, intentId, router, cleanUrl]);

  if (!msg || state === "idle") return null;

  const cls =
    state === "success"
      ? "border-green-200 bg-green-50"
      : state === "error"
      ? "border-red-200 bg-red-50"
      : "border-yellow-200 bg-yellow-50";

  const icon =
    state === "success" ? (
      <CheckCircle2 className="w-4 h-4" />
    ) : state === "error" ? (
      <XCircle className="w-4 h-4" />
    ) : (
      <Loader2 className="w-4 h-4 animate-spin" />
    );

  return (
    <div className={`mb-4 rounded-lg border p-3 text-sm ${cls}`}>
      <div className="flex items-start justify-between gap-3">
        <div className="flex items-start gap-2">
          <div className="mt-0.5">{icon}</div>
          <div>
            <div className="font-medium">{msg}</div>
            {details && <div className="mt-1 text-muted-foreground">{details}</div>}
          </div>
        </div>

        {state === "pending" && (
          <Button variant="outline" size="sm" onClick={() => window.location.reload()}>
            Od≈õwie≈º
          </Button>
        )}
      </div>
    </div>
  );
}

--- FILE: components/classes/ScheduleCalendar.tsx ---

--- FILE: components/classes/AvailableClassesList.tsx ---

--- FILE: components/classes/MyEnrollmentsList.tsx ---

--- FILE: components/admin/SelectChildrenModal.tsx ---
"use client";

import { useEffect, useMemo, useState } from "react";
import {
  Dialog,
  DialogContent,
  DialogHeader,
  DialogTitle,
  DialogFooter,
} from "@/components/ui/dialog";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { cn } from "@/lib/utils";
import type { ChildWithParent } from "@/types/children";

type Props = {
  open: boolean;
  childrenList: ChildWithParent[];
  selectedIds: string[];
  onClose(): void;
  onSave(ids: string[]): void;
};

export function SelectChildrenModal({
  open,
  childrenList,
  selectedIds,
  onClose,
  onSave,
}: Props) {
  const [query, setQuery] = useState("");
  const [localSelected, setLocalSelected] =
    useState<string[]>(selectedIds);

  useEffect(() => {
    setLocalSelected(selectedIds);
  }, [selectedIds]);

  const filtered = useMemo(() => {
    const q = query.toLowerCase().trim();

    if (!q) return childrenList;

    return childrenList.filter((c) => {
      const haystack = `${c.firstName} ${c.lastName} ${c.parentName}`.toLowerCase();
      return haystack.includes(q);
    });
  }, [query, childrenList]);

  function toggle(id: string) {
    setLocalSelected((prev) =>
      prev.includes(id)
        ? prev.filter((x) => x !== id)
        : [...prev, id]
    );
  }

  return (
    <Dialog open={open} onOpenChange={onClose}>
      <DialogContent className="max-w-4xl h-[80vh] flex flex-col">
        <DialogHeader>
          <DialogTitle>Wybierz dzieci</DialogTitle>
        </DialogHeader>

        {/* Search */}
        <div className="mb-2">
          <Input
            placeholder="Szukaj dziecka lub rodzica..."
            value={query}
            onChange={(e) => setQuery(e.target.value)}
          />
        </div>

        {/* Table */}
        <div className="flex-1 overflow-auto border rounded-lg">
          <table className="w-full text-sm">
            <thead className="sticky top-0 bg-muted">
              <tr>
                <th className="p-2 w-10"></th>
                <th className="p-2 text-left">Dziecko</th>
                <th className="p-2 text-left">Wiek</th>
                <th className="p-2 text-left">Rodzic</th>
              </tr>
            </thead>

            <tbody>
              {filtered.map((c) => {
                const checked = localSelected.includes(c.id);

                return (
                  <tr
                    key={c.id}
                    className={cn(
                      "border-t cursor-pointer hover:bg-muted/40",
                      checked && "bg-primary/5"
                    )}
                    onClick={() => toggle(c.id)}
                  >
                    <td className="p-2 text-center">
                      <input
                        type="checkbox"
                        checked={checked}
                        onChange={() => toggle(c.id)}
                        onClick={(e) => e.stopPropagation()}
                      />
                    </td>
                    <td className="p-2">
                      {c.firstName} {c.lastName}
                    </td>
                    <td className="p-2">{c.ageYears} lat</td>
                    <td className="p-2 text-muted-foreground">
                      {c.parentName}
                    </td>
                  </tr>
                );
              })}

              {filtered.length === 0 && (
                <tr>
                  <td
                    colSpan={4}
                    className="p-4 text-center text-muted-foreground"
                  >
                    Brak wynik√≥w
                  </td>
                </tr>
              )}
            </tbody>
          </table>
        </div>

        {/* Footer */}
        <DialogFooter className="mt-3 flex justify-between">
          <div className="text-sm text-muted-foreground">
            Wybrano: {localSelected.length}
          </div>

          <div className="flex gap-2">
            <Button variant="outline" onClick={onClose}>
              Anuluj
            </Button>
            <Button onClick={() => onSave(localSelected)}>
              Zapisz
            </Button>
          </div>
        </DialogFooter>
      </DialogContent>
    </Dialog>
  );
}

--- FILE: components/admin/WeekCalendar.tsx ---
"use client";

import { useEffect, useMemo, useState } from "react";
import type { Class } from "@/types/classes";
import { getActiveClasses } from "@/services/classes.service";
import { Button } from "@/components/ui/button";
import { cn } from "@/lib/utils";
import { CreateClassDialog } from "./CreateClassDialog";

const START_HOUR = 8;
const END_HOUR = 20;
const SLOT_MIN = 30; // 30-min

function pad2(n: number) {
  return n < 10 ? `0${n}` : `${n}`;
}

function parseYMD(ymd: string): Date {
  const [y, m, d] = ymd.split("-").map(Number);
  return new Date(y, (m ?? 1) - 1, d ?? 1, 12, 0, 0, 0);
}

function formatYMD(d: Date): string {
  return `${d.getFullYear()}-${pad2(d.getMonth() + 1)}-${pad2(d.getDate())}`;
}

function startOfWeekMonday(date: Date): Date {
  const d = new Date(date);
  const day = d.getDay(); // 0=ndz ... 1=pon
  const diff = day === 0 ? -6 : 1 - day;
  d.setDate(d.getDate() + diff);
  d.setHours(12, 0, 0, 0);
  return d;
}

function addDays(date: Date, days: number): Date {
  const d = new Date(date);
  d.setDate(d.getDate() + days);
  return d;
}

function timeToMinutes(t: string): number {
  const [hh, mm] = t.split(":").map(Number);
  return (hh ?? 0) * 60 + (mm ?? 0);
}

function minutesToRow(minSinceStart: number) {
  return Math.floor(minSinceStart / SLOT_MIN) + 1;
}

function weeksBetween(a: Date, b: Date): number {
  const ms = (b.getTime() - a.getTime()) / (1000 * 60 * 60 * 24);
  return Math.floor(ms / 7);
}

function weekIndexInMonth(d: Date): number {
  return Math.floor((d.getDate() - 1) / 7) + 1;
}

function isClassOnDate(cls: Class, dateYMD: string): boolean {
  const date = parseYMD(dateYMD);
  const start = parseYMD(cls.recurrence.startDate);
  const end = cls.recurrence.endDate
    ? parseYMD(cls.recurrence.endDate)
    : null;

  if (date < start) return false;
  if (end && date > end) return false;

  const jsDay = date.getDay();
  const weekday = jsDay === 0 ? 7 : jsDay;
  if (weekday !== cls.weekday) return false;

  const interval = Math.max(1, cls.recurrence.interval || 1);

  if (cls.recurrence.type === "none") {
    return (
      startOfWeekMonday(start).getTime() ===
      startOfWeekMonday(date).getTime()
    );
  }

  if (
    cls.recurrence.type === "weekly" ||
    cls.recurrence.type === "biweekly"
  ) {
    const w = weeksBetween(
      startOfWeekMonday(start),
      startOfWeekMonday(date)
    );
    return w % interval === 0;
  }

  if (cls.recurrence.type === "monthly") {
    const targetWeek = weekIndexInMonth(start);
    const currentWeek = weekIndexInMonth(date);
    if (currentWeek !== targetWeek) return false;

    const months =
      (date.getFullYear() - start.getFullYear()) * 12 +
      (date.getMonth() - start.getMonth());
    return months % interval === 0;
  }

  return false;
}

export function WeekCalendar() {
  const [classes, setClasses] = useState<Class[]>([]);
  const [loading, setLoading] = useState(true);
  const [anchorDate, setAnchorDate] = useState(() => new Date());

  const [createOpen, setCreateOpen] = useState(false);
  const [draft, setDraft] = useState<{
    dateYMD: string;
    weekday: 1 | 2 | 3 | 4 | 5 | 6 | 7;
    startTime: string;
  } | null>(null);

  const [editing, setEditing] = useState<Class | null>(null);

  function openCreate(payload: {
    dateYMD: string;
    weekday: 1 | 2 | 3 | 4 | 5 | 6 | 7;
    startTime: string;
  }) {
    setDraft(payload);
    setCreateOpen(true);
  }

  const weekStart = useMemo(
    () => startOfWeekMonday(anchorDate),
    [anchorDate]
  );

  const days = useMemo(
    () => Array.from({ length: 7 }, (_, i) => addDays(weekStart, i)),
    [weekStart]
  );

  useEffect(() => {
    setLoading(true);
    getActiveClasses()
      .then(setClasses)
      .finally(() => setLoading(false));
  }, []);

  const slotsCount = ((END_HOUR - START_HOUR) * 60) / SLOT_MIN;

  const events = useMemo(() => {
    const out: Array<
      Class & {
        dateYMD: string;
        col: number;
        rowStart: number;
        rowSpan: number;
      }
    > = [];

    for (let dayIdx = 0; dayIdx < 7; dayIdx++) {
      const dateYMD = formatYMD(days[dayIdx]);

      for (const cls of classes) {
        if (!isClassOnDate(cls, dateYMD)) continue;

        const startMin =
          timeToMinutes(cls.startTime) - START_HOUR * 60;
        const endMin =
          timeToMinutes(cls.endTime) - START_HOUR * 60;

        const rowStart = minutesToRow(Math.max(0, startMin));
        const rowSpan = Math.max(
          1,
          Math.ceil((endMin - startMin) / SLOT_MIN)
        );

        out.push({
          ...cls,
          dateYMD,
          col: dayIdx + 2,
          rowStart: rowStart + 1,
          rowSpan,
        });
      }
    }

    return out;
  }, [classes, days]);

  const rangeLabel = useMemo(() => {
    const end = addDays(weekStart, 6);
    return `${weekStart.getDate()} ${weekStart.toLocaleString("pl-PL", {
      month: "short",
    })} ‚Äì ${end.getDate()} ${end.toLocaleString("pl-PL", {
      month: "short",
    })}`;
  }, [weekStart]);

  return (
    <div className="space-y-4">
      {/* Toolbar */}
      <div className="flex items-center justify-between gap-3">
        <div className="flex items-center gap-2">
          <Button variant="outline" onClick={() => setAnchorDate(new Date())}>
            Dzi≈õ
          </Button>
          <Button
            variant="outline"
            onClick={() => setAnchorDate(addDays(anchorDate, -7))}
          >
            ‚Üê
          </Button>
          <Button
            variant="outline"
            onClick={() => setAnchorDate(addDays(anchorDate, 7))}
          >
            ‚Üí
          </Button>
          <div className="font-medium ml-2">{rangeLabel}</div>
        </div>

        <div className="text-sm text-muted-foreground">
          {loading ? "≈Åadowanie‚Ä¶" : `Zajƒôƒá: ${events.length}`}
        </div>
      </div>

      {/* Grid */}
      <div
        className="relative border rounded-xl bg-background overflow-hidden"
        style={{
          display: "grid",
          gridTemplateColumns: "80px repeat(7, minmax(0, 1fr))",
          gridTemplateRows: `48px repeat(${slotsCount}, 28px)`,
        }}
      >
        {/* Header */}
        <div className="border-b bg-muted/40" />
        {days.map((d, i) => (
          <div
            key={i}
            className="border-b border-l bg-muted/40 flex items-center justify-center text-sm font-medium"
          >
            {d.toLocaleDateString("pl-PL", {
              weekday: "short",
              day: "2-digit",
              month: "2-digit",
            })}
          </div>
        ))}

        {/* Cells */}
        {Array.from({ length: slotsCount }).map((_, slotIdx) =>
          days.map((day, dayIdx) => {
            const minutes = slotIdx * SLOT_MIN;
            const hh = START_HOUR + Math.floor(minutes / 60);
            const mm = minutes % 60;

            const time = `${pad2(hh)}:${pad2(mm)}`;
            const dateYMD = formatYMD(day);

            return (
              <button
                key={`${slotIdx}-${dayIdx}`}
                type="button"
                onClick={() =>
                  openCreate({
                    dateYMD,
                    weekday: (day.getDay() === 0
                      ? 7
                      : day.getDay()) as any,
                    startTime: time,
                  })
                }
                className={cn(
                "border-t border-l transition relative group cursor-pointer",
                "hover:bg-primary/5"
                )}
               >
                <span className="absolute inset-0 hidden group-hover:flex items-center justify-center text-muted-foreground text-lg">
                    Ôºã
                </span>
               </button>
            );
          })
        )}

        {/* Events */}
        {events.map((ev) => (
          <button
            key={`${ev.id}-${ev.dateYMD}`}
            type="button"
            onClick={() => setEditing(ev)}
            className="border border-black/10 rounded-lg px-2 py-1 text-xs shadow-sm overflow-hidden text-left"
            style={{
              gridColumn: `${ev.col}`,
              gridRow: `${ev.rowStart} / ${ev.rowStart + ev.rowSpan}`,
              background: ev.color || "#e5e7eb",
            }}
          >
            <div className="font-medium leading-tight">{ev.title}</div>
            <div className="opacity-80 leading-tight">
              {ev.startTime}‚Äì{ev.endTime}
            </div>
            <div className="opacity-70 leading-tight">
              {ev.instructorName}
            </div>
          </button>
        ))}
      </div>

      {/* Create */}
      {createOpen && draft && (
        <CreateClassDialog
          mode="create"
          initial={{
            weekday: draft.weekday,
            startTime: draft.startTime,
            startDate: draft.dateYMD,
          }}
          onClose={() => setCreateOpen(false)}
          onCreated={(cls) => {
            setClasses((c) => [...c, cls]);
            setCreateOpen(false);
          }}
        />
      )}

     {/* Edit */}
      {editing && (
        <CreateClassDialog
          mode="edit"
          classToEdit={editing}
          initial={{
            weekday: editing.weekday,
            startTime: editing.startTime,
            startDate: editing.recurrence.startDate,
          }}
          onClose={() => setEditing(null)}
          onCreated={(updated) => {
            setClasses((c) => c.map((x) => (x.id === updated.id ? updated : x)));
            setEditing(null);
          }}
          onDeleted={() => {
            setClasses((c) => c.filter((x) => x.id !== editing.id));
            setEditing(null);
          }}
        />
      )}
    </div>
  );
}

--- FILE: components/admin/AdminSidebar.tsx ---
"use client";

import Link from "next/link";
import { usePathname } from "next/navigation";
import { cn } from "@/lib/utils";

const nav = [
  { label: "Zajƒôcia", href: "/admin/classes" },
  { label: "U≈ºytkownicy", href: "/admin/users" },
  { label: "P≈Çatno≈õci", href: "/admin/payments" },
  { label: "Grupy", href: "/admin/groups" },
  { label: "Eventy", href: "/admin/events" },
];

export function AdminSidebar() {
  const pathname = usePathname();

  return (
    <aside className="w-64 border-r bg-background h-screen sticky top-0">
      <div className="p-4 font-semibold text-lg">üëë Admin</div>

      <nav className="px-2 space-y-1">
        {nav.map((item) => {
          const active = pathname === item.href;
          return (
            <Link
              key={item.href}
              href={item.href}
              className={cn(
                "block rounded-md px-3 py-2 text-sm transition",
                active ? "bg-primary text-primary-foreground" : "hover:bg-muted"
              )}
            >
              {item.label}
            </Link>
          );
        })}
      </nav>

      <div className="mt-auto p-4 text-xs text-muted-foreground">
        Panel administracyjny
      </div>
    </aside>
  );
}

--- FILE: components/admin/ProviderIcon.tsx ---
import { Mail, Chrome, Facebook } from "lucide-react";

export function ProviderIcon({ provider }: { provider: string }) {
  if (provider?.includes("google")) {
    return <Chrome className="h-4 w-4 text-red-500" />;
  }

  if (provider?.includes("facebook")) {
    return <Facebook className="h-4 w-4 text-blue-600" />;
  }

  return <Mail className="h-4 w-4 text-muted-foreground" />;
}


--- FILE: components/admin/UserDetailsModal.tsx ---
"use client";

import { useEffect, useMemo, useState } from "react";
import type { AdminUser } from "@/types/admin";
import {
  Dialog,
  DialogContent,
  DialogHeader,
  DialogTitle,
} from "@/components/ui/dialog";
import { Button } from "@/components/ui/button";
import { ProviderIcon } from "@/components/admin/ProviderIcon";
import { getUserProfile, updateUserProfile } from "@/services/profile.service";
import type { ParentFormData } from "@/types/profile";
import { ParentProfileForm } from "@/components/profile/ParentProfileForm";
import { deleteUser } from "@/services/admin-users.service";
import { cn } from "@/lib/utils";

type Props = {
  user: AdminUser | null;
  onClose(): void;
  onUpdated(user: AdminUser): void;
};

function formatTS(ts?: number) {
  if (!ts) return "‚Äî";
  return new Date(ts).toLocaleString("pl-PL");
}

function getPresence(u?: AdminUser | null): { lastSeenAt?: number } {
  if (!u) return {};
  const anyU: any = u as any;
  return {
    lastSeenAt:
      anyU?.presence?.lastSeenAt ??
      anyU?.presenceLastSeenAt ??
      anyU?.lastSeenAtPresence ??
      undefined,
  };
}

function presenceBadge(u?: AdminUser | null) {
  const lastSeenAt = getPresence(u).lastSeenAt;
  if (!lastSeenAt) return { label: "offline", cls: "bg-zinc-100 text-zinc-700 border-zinc-200" };

  const diff = Date.now() - lastSeenAt;
  if (diff <= 2 * 60 * 1000) {
    return { label: "online", cls: "bg-emerald-50 text-emerald-700 border-emerald-200" };
  }
  if (diff <= 60 * 60 * 1000) {
    return { label: "aktywny < 1h", cls: "bg-amber-50 text-amber-800 border-amber-200" };
  }
  return { label: "offline", cls: "bg-zinc-100 text-zinc-700 border-zinc-200" };
}

export function UserDetailsModal({ user, onClose, onUpdated }: Props) {
  const [profile, setProfile] = useState<ParentFormData | null>(null);
  const [view, setView] = useState<"details" | "edit">("details");
  const [loading, setLoading] = useState(false);

  // reset i load profilu
  useEffect(() => {
    if (!user) {
      setProfile(null);
      setView("details");
      return;
    }

    setView("details");
    setLoading(true);
    getUserProfile(user.id)
      .then(setProfile)
      .finally(() => setLoading(false));
  }, [user?.id]);

  const fullName = useMemo(() => {
    if (!user) return "";
    const n = `${user.firstName ?? ""} ${user.lastName ?? ""}`.trim();
    return n || user.email;
  }, [user]);

  async function handleDelete() {
    if (!user) return;
    if (!confirm("Na pewno usunƒÖƒá u≈ºytkownika?")) return;
    await deleteUser(user.id);
    onClose();
  }

  async function handleSave(data: ParentFormData) {
    if (!user) return;

    await updateUserProfile(user.id, data);

    const updated: AdminUser = {
      ...user,
      firstName: data.firstName,
      lastName: data.lastName,
      phone: data.phone,
      // children na li≈õcie masz z admin-users.service; tu tylko od≈õwie≈ºamy podstawy
    };

    onUpdated(updated);
    setProfile(data);
    setView("details");
  }

  const badge = presenceBadge(user);
  const lastSeenAt = getPresence(user).lastSeenAt;

  return (
    <Dialog
      open={!!user}
      onOpenChange={(open) => {
        if (!open) {
          setView("details");
          onClose();
        }
      }}
    >
      <DialogContent className="max-w-4xl">
        <DialogHeader className="space-y-1">
          <DialogTitle className="flex items-center justify-between gap-3">
            <span className="flex items-center gap-3 min-w-0">
              <span className="inline-flex items-center justify-center h-10 w-10 rounded-full bg-muted border shrink-0">
                <ProviderIcon provider={user?.provider ?? "password"} />
              </span>

              <span className="min-w-0">
                <div className="font-semibold truncate">{fullName}</div>
                <div className="text-xs text-muted-foreground font-normal truncate">
                  {user?.email}
                </div>
              </span>

              <span
                className={cn(
                  "ml-2 text-xs border rounded-full px-2 py-0.5",
                  badge.cls
                )}
              >
                {badge.label}
              </span>
            </span>

            {view === "details" ? (
              <Button onClick={() => setView("edit")}>Edytuj</Button>
            ) : (
              <Button variant="outline" onClick={() => setView("details")}>
                Anuluj i wr√≥ƒá
              </Button>
            )}
          </DialogTitle>
        </DialogHeader>

        {loading || !profile ? (
          <div className="py-10 text-sm text-muted-foreground">
            ≈Åadowanie profilu‚Ä¶
          </div>
        ) : (
          <>
            {view === "details" && (
              <div className="space-y-4">
                <div className="grid grid-cols-1 md:grid-cols-3 gap-3">
                  <div className="rounded-xl border p-3">
                    <div className="text-xs text-muted-foreground">Telefon</div>
                    <div className="font-medium">{profile.phone || "‚Äî"}</div>
                  </div>

                  <div className="rounded-xl border p-3">
                    <div className="text-xs text-muted-foreground">Ostatnie logowanie</div>
                    <div className="font-medium">{formatTS(user?.lastLoginAt)}</div>
                    <div className="text-xs text-muted-foreground mt-1">
                      Provider: <span className="font-medium">{user?.provider ?? "password"}</span>
                    </div>
                  </div>

                  <div className="rounded-xl border p-3">
                    <div className="text-xs text-muted-foreground">Aktywno≈õƒá (presence)</div>
                    <div className="font-medium">{formatTS(lastSeenAt)}</div>
                    <div className="text-xs text-muted-foreground mt-1">
                      Status: <span className="font-medium">{badge.label}</span>
                    </div>
                  </div>
                </div>

                <div className="rounded-xl border p-3 text-sm">
                  <div className="text-xs text-muted-foreground mb-1">Adres</div>
                  <div className="font-medium">
                    {[
                      profile.street,
                      profile.houseNumber,
                      profile.apartmentNumber ? `/${profile.apartmentNumber}` : "",
                    ]
                      .filter(Boolean)
                      .join(" ")}
                  </div>
                  <div className="text-muted-foreground">
                    {[profile.postalCode, profile.city].filter(Boolean).join(" ")}
                  </div>
                </div>

                <div className="rounded-xl border p-3">
                  <div className="flex items-center justify-between">
                    <h3 className="font-medium">Dzieci</h3>
                    <div className="text-xs text-muted-foreground">
                      {profile.children.length} zapisanych
                    </div>
                  </div>

                  {profile.children.length === 0 ? (
                    <div className="text-sm text-muted-foreground mt-2">Brak dzieci.</div>
                  ) : (
                    <div className="mt-3 grid grid-cols-1 md:grid-cols-2 gap-2">
                      {profile.children.map((c, idx) => (
                        <div key={idx} className="rounded-lg border p-3">
                          <div className="font-medium">
                            {c.firstName} {c.lastName}
                          </div>
                          <div className="text-xs text-muted-foreground">
                            Wiek: {c.ageYears || "‚Äî"}
                          </div>
                        </div>
                      ))}
                    </div>
                  )}
                </div>

                <div className="flex items-center justify-between pt-2">
                  <Button variant="destructive" onClick={handleDelete}>
                    Usu≈Ñ u≈ºytkownika
                  </Button>
                  <Button onClick={() => setView("edit")}>Edytuj dane</Button>
                </div>
              </div>
            )}

            {view === "edit" && (
              <div className="space-y-3">
                <ParentProfileForm
                  mode="edit"
                  initialValues={profile}
                  submitLabel="Zapisz dane"
                  onSubmit={handleSave}
                />

                <div className="flex justify-end">
                  <Button variant="outline" onClick={() => setView("details")}>
                    Anuluj i wr√≥ƒá
                  </Button>
                </div>
              </div>
            )}
          </>
        )}
      </DialogContent>
    </Dialog>
  );
}

--- FILE: components/admin/AdminLayout.tsx ---
import { AdminSidebar } from "./AdminSidebar";
import { Topbar } from "@/components/dashboard/Topbar";

export function AdminLayout({ children }: { children: React.ReactNode }) {
  return (
    <div className="flex min-h-screen">
      <AdminSidebar />
      <div className="flex flex-col flex-1">
        <Topbar />
        <main className="flex-1 p-6 bg-muted/40">{children}</main>
      </div>
    </div>
  );
}

--- FILE: components/admin/CreateClassDialog.tsx ---
"use client";

import { useEffect, useState } from "react";
import {
  Dialog,
  DialogContent,
  DialogHeader,
  DialogTitle,
  DialogFooter,
} from "@/components/ui/dialog";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { cn } from "@/lib/utils";
import type { Class, RecurrenceType, ClassIcon } from "@/types/classes";
import { Group } from "@/types/groups";
import { createClass, updateClass, deleteClass } from "@/services/classes.service";
import { uploadClassImage } from "@/services/upload.service";
import { useAuth } from "@/components/auth/AuthProvider";
import { getAllGroups } from "@/services/groups.service";

type Props = {
  mode: "create" | "edit";
  classToEdit?: Class;
  initial: {
    weekday: Class["weekday"];
    startTime: string;
    startDate: string;
  };
  onClose(): void;
  onCreated(cls: Class): void;
  onDeleted?(): void; // ‚úÖ ≈ºeby WeekCalendar m√≥g≈Ç usunƒÖƒá z listy
};

export function CreateClassDialog({
  mode,
  classToEdit,
  initial,
  onClose,
  onCreated,
  onDeleted,
}: Props) {
  const { user } = useAuth();
  const initialData = classToEdit;

  const [groups, setGroups] = useState<Group[]>([]);
  const [saving, setSaving] = useState(false);

  const [imageFile, setImageFile] = useState<File | null>(null);
  const [previewUrl, setPreviewUrl] = useState<string | null>(initialData?.imageUrl ?? null);

  const [errors, setErrors] = useState<Record<string, string>>({});

  const [form, setForm] = useState({
    title: initialData?.title ?? "",
    description: initialData?.description ?? "",
    instructorName: initialData?.instructorName ?? "",
    location: initialData?.location ?? "",
    category: initialData?.category ?? "music",
    icon: initialData?.icon ?? "music",
    color: initialData?.color ?? "#6366f1",

    startTime: initialData?.startTime ?? initial.startTime,
    endTime: initialData?.endTime ?? "",

    recurrenceType: (initialData?.recurrence.type ?? "weekly") as RecurrenceType,
    interval: initialData?.recurrence.interval ?? 1,
    startDate: initialData?.recurrence.startDate ?? initial.startDate,
    endDate: initialData?.recurrence.endDate ?? "",

    groupIds: initialData?.groupIds ?? [],
  });

  useEffect(() => {
    getAllGroups().then(setGroups);
  }, []);

  useEffect(() => {
    if (initialData?.imageUrl) setPreviewUrl(initialData.imageUrl);
  }, [initialData?.imageUrl]);

  function update<K extends keyof typeof form>(key: K, value: (typeof form)[K]) {
    setForm((f) => ({ ...f, [key]: value }));
  }

  function validate() {
    const e: Record<string, string> = {};
    if (!form.title.trim()) e.title = "Podaj nazwƒô zajƒôƒá.";
    if (!form.instructorName.trim()) e.instructorName = "Podaj prowadzƒÖcego.";
    if (!form.location.trim()) e.location = "Podaj miejsce.";
    if (!form.startTime) e.startTime = "Podaj godzinƒô rozpoczƒôcia.";
    if (!form.endTime) e.endTime = "Podaj godzinƒô zako≈Ñczenia.";
    if (form.startTime && form.endTime && form.endTime <= form.startTime) {
      e.endTime = "Godzina zako≈Ñczenia musi byƒá p√≥≈∫niejsza.";
    }
    if (!form.startDate) e.startDate = "Podaj datƒô startu.";

    if (form.endDate && form.endDate < form.startDate) {
      e.endDate = "Data ko≈Ñca nie mo≈ºe byƒá wcze≈õniejsza ni≈º start.";
    }

    return e;
  }

  async function submit() {
    if (!user) return;

    const validationErrors = validate();
    setErrors(validationErrors);
    if (Object.keys(validationErrors).length > 0) return;

    setSaving(true);

    try {
      const recurrenceInterval =
        form.recurrenceType === "none" ? 1 : Math.max(1, Number(form.interval || 1));

      const payload: Omit<Class, "id"> = {
        title: form.title.trim(),
        description: form.description?.trim() || "",
        instructorName: form.instructorName.trim(),
        location: form.location.trim(),
        category: form.category,
        color: form.color,
        icon: form.icon as ClassIcon,

        weekday: initial.weekday,
        startTime: form.startTime,
        endTime: form.endTime,

        recurrence: {
          type: form.recurrenceType,
          interval: recurrenceInterval,
          startDate: form.startDate,
          ...(form.endDate ? { endDate: form.endDate } : {}),
        },

        // ‚úÖ zapisujemy groupIds (wcze≈õniej tego brakowa≈Ço)
        groupIds: form.groupIds,

        isActive: true,
        createdAt: initialData?.createdAt ?? Date.now(),
        createdBy: initialData?.createdBy ?? user.uid,
      };

      let classId = initialData?.id;

      if (mode === "create") {
        const ref = await createClass(payload);
        classId = ref.id;
      } else {
        await updateClass(classId!, payload);
      }

      // ‚úÖ upload zdjƒôcia i zapis imageUrl do Firestore
      let imageUrl: string | undefined = initialData?.imageUrl;
      if (imageFile) {
        imageUrl = await uploadClassImage(imageFile, classId!);
        await updateClass(classId!, { imageUrl });
      }

      onCreated({ id: classId!, ...payload, imageUrl });
    } finally {
      setSaving(false);
    }
  }

  async function handleDelete() {
    if (!initialData) return;
    if (!confirm("UsunƒÖƒá zajƒôcia?")) return;

    await deleteClass(initialData.id);
    onDeleted?.();
    onClose();
  }

  return (
    <Dialog open onOpenChange={onClose}>
      <DialogContent className="max-w-xl">
        <DialogHeader>
          <DialogTitle>{mode === "edit" ? "Edytuj zajƒôcia" : "Dodaj zajƒôcia"}</DialogTitle>
        </DialogHeader>

        <div className="space-y-4">
          <div>
            <Input
              placeholder="Nazwa zajƒôƒá *"
              value={form.title}
              onChange={(e) => update("title", e.target.value)}
              className={errors.title ? "border-red-500" : ""}
            />
            {errors.title && <p className="text-xs text-red-500 mt-1">{errors.title}</p>}
          </div>

          <div>
            <Input
              placeholder="Opis (opcjonalnie)"
              value={form.description}
              onChange={(e) => update("description", e.target.value)}
            />
          </div>

          <div>
            <Input
              placeholder="ProwadzƒÖcy *"
              value={form.instructorName}
              onChange={(e) => update("instructorName", e.target.value)}
              className={errors.instructorName ? "border-red-500" : ""}
            />
            {errors.instructorName && <p className="text-xs text-red-500 mt-1">{errors.instructorName}</p>}
          </div>

          <div>
            <Input
              placeholder="Miejsce *"
              value={form.location}
              onChange={(e) => update("location", e.target.value)}
              className={errors.location ? "border-red-500" : ""}
            />
            {errors.location && <p className="text-xs text-red-500 mt-1">{errors.location}</p>}
          </div>

          <div className="grid grid-cols-2 gap-3">
            <div>
              <Input
                type="time"
                value={form.startTime}
                onChange={(e) => update("startTime", e.target.value)}
                className={errors.startTime ? "border-red-500" : ""}
              />
              {errors.startTime && <p className="text-xs text-red-500 mt-1">{errors.startTime}</p>}
            </div>

            <div>
              <Input
                type="time"
                value={form.endTime}
                onChange={(e) => update("endTime", e.target.value)}
                className={errors.endTime ? "border-red-500" : ""}
              />
              {errors.endTime && <p className="text-xs text-red-500 mt-1">{errors.endTime}</p>}
            </div>
          </div>

          <div className="grid grid-cols-2 gap-3">
            <select
              className="input"
              value={form.recurrenceType}
              onChange={(e) => update("recurrenceType", e.target.value as RecurrenceType)}
            >
              <option value="none">Jednorazowo</option>
              <option value="weekly">Co tydzie≈Ñ</option>
              <option value="biweekly">Co 2 tygodnie</option>
              <option value="monthly">Co miesiƒÖc</option>
            </select>

            <Input
              type="number"
              min={1}
              value={form.interval}
              disabled={form.recurrenceType === "none"}
              onChange={(e) => update("interval", Number(e.target.value))}
            />
          </div>

          <div className="grid grid-cols-2 gap-3">
            <div>
              <label className="text-xs text-muted-foreground">Od kiedy *</label>
              <Input
                type="date"
                value={form.startDate}
                onChange={(e) => update("startDate", e.target.value)}
                className={errors.startDate ? "border-red-500" : ""}
              />
              {errors.startDate && <p className="text-xs text-red-500 mt-1">{errors.startDate}</p>}
            </div>

            <div>
              <label className="text-xs text-muted-foreground">Do kiedy (opcjonalnie)</label>
              <Input
                type="date"
                value={form.endDate}
                onChange={(e) => update("endDate", e.target.value)}
                className={errors.endDate ? "border-red-500" : ""}
              />
              {errors.endDate && <p className="text-xs text-red-500 mt-1">{errors.endDate}</p>}
            </div>
          </div>

          <div>
            <label className="text-sm font-medium">Ikona</label>
            <select
              className="input mt-1"
              value={form.icon}
              onChange={(e) => update("icon", e.target.value as any)}
            >
              <option value="music">üéµ Muzyka</option>
              <option value="guitar">üé∏ Gitara</option>
              <option value="piano">üéπ Piano</option>
              <option value="mic">üé§ Wokal</option>
              <option value="headphones">üéß Produkcja</option>
              <option value="drums">ü•Å Perkusja</option>
            </select>
          </div>

          {/* ‚úÖ Grupy (zapis do payload dzia≈Ça) */}
          <div>
            <label className="text-sm font-medium">Grupy</label>
            <div className="mt-2 flex flex-wrap gap-2">
              {groups.map((g) => {
                const active = form.groupIds.includes(g.id);
                return (
                  <button
                    key={g.id}
                    type="button"
                    onClick={() =>
                      update(
                        "groupIds",
                        active ? form.groupIds.filter((id) => id !== g.id) : [...form.groupIds, g.id]
                      )
                    }
                    className={cn(
                      "px-3 py-1 rounded-full text-sm border transition",
                      active ? "bg-primary text-primary-foreground" : "bg-muted hover:bg-muted/70"
                    )}
                  >
                    {g.name}
                  </button>
                );
              })}
            </div>
          </div>

          {/* ‚úÖ Kolor */}
          <div className="flex items-center gap-3">
            <span className="text-sm">Kolor</span>
            <input type="color" value={form.color} onChange={(e) => update("color", e.target.value)} />
          </div>

          {/* ‚úÖ Zdjƒôcie */}
          <div>
            <label className="text-sm font-medium">Zdjƒôcie (opcjonalne)</label>

            <div
              className={cn(
                "mt-2 border-2 border-dashed rounded-lg p-4 text-center cursor-pointer transition",
                previewUrl ? "border-muted" : "border-muted-foreground/30 hover:border-primary"
              )}
              onClick={() => document.getElementById("class-image")?.click()}
            >
              <input
                id="class-image"
                type="file"
                accept="image/*"
                className="hidden"
                onChange={(e) => {
                  const file = e.target.files?.[0];
                  if (!file) return;

                  if (file.size > 2_000_000) {
                    alert("Maksymalny rozmiar zdjƒôcia to 2MB.");
                    return;
                  }

                  setImageFile(file);
                  setPreviewUrl(URL.createObjectURL(file));
                }}
              />

              {previewUrl ? (
                <div className="space-y-2">
                  <img src={previewUrl} className="mx-auto h-32 rounded-md object-cover" />
                  <button
                    type="button"
                    onClick={(e) => {
                      e.stopPropagation();
                      setImageFile(null);
                      setPreviewUrl(null);
                    }}
                    className="text-xs underline text-muted-foreground"
                  >
                    Usu≈Ñ zdjƒôcie
                  </button>
                </div>
              ) : (
                <div className="text-sm text-muted-foreground">
                  Kliknij aby dodaƒá zdjƒôcie
                  <br />
                  <span className="text-xs">(PNG / JPG, max 2MB)</span>
                </div>
              )}
            </div>
          </div>

          {/* ‚ùå USUNIƒòTE: ‚ÄúZapisane dzieci‚Äù (to nie powinno byƒá w klasie) */}
        </div>

        <DialogFooter className="flex justify-between">
          {mode === "edit" && (
            <Button variant="destructive" onClick={handleDelete}>
              Usu≈Ñ
            </Button>
          )}

          <div className="flex gap-2">
            <Button variant="outline" onClick={onClose}>
              Anuluj
            </Button>
            <Button disabled={saving} onClick={submit}>
              {saving ? "Zapisywanie..." : "Zapisz"}
            </Button>
          </div>
        </DialogFooter>
      </DialogContent>
    </Dialog>
  );
}

--- FILE: components/dashboard/Topbar.tsx ---
"use client";

import { usePathname } from "next/navigation";
import { UserMenu } from "./UserMenu";

function breadcrumbFromPath(path: string) {
  const parts = path.split("/").filter(Boolean);

  return parts.map((part, idx) => ({
    label: part,
    href: "/" + parts.slice(0, idx + 1).join("/"),
  }));
}

export function Topbar() {
  const pathname = usePathname();
  const crumbs = breadcrumbFromPath(pathname);

  return (
    <header className="h-14 border-b flex items-center justify-between px-4">
      <div className="flex gap-2 text-sm text-muted-foreground">
        {crumbs.map((c, i) => (
          <span key={c.href}>
            {i > 0 && " / "}
            {c.label}
          </span>
        ))}
      </div>

      <UserMenu />
    </header>
  );
}

--- FILE: components/dashboard/UserMenu.tsx ---
"use client";

import { signOut } from "firebase/auth";
import { auth } from "@/lib/firebase/client";
import { useAuth } from "@/components/auth/AuthProvider";

import {
  DropdownMenu,
  DropdownMenuContent,
  DropdownMenuItem,
  DropdownMenuTrigger,
} from "@/components/ui/dropdown-menu";
import { Avatar, AvatarFallback, AvatarImage } from "@/components/ui/avatar";
import { Button } from "@/components/ui/button";
import { useRouter } from "next/navigation";

export function UserMenu() {
  const { user } = useAuth();
  const router = useRouter();

  if (!user) return null;

  return (
    <DropdownMenu>
      <DropdownMenuTrigger asChild>
        <Button variant="ghost" className="flex gap-2 items-center">
          <Avatar className="h-8 w-8">
            <AvatarImage src={user.photoURL ?? undefined} />
            <AvatarFallback>
              {user.displayName?.[0] ?? "U"}
            </AvatarFallback>
          </Avatar>

          <span className="text-sm hidden sm:block">
            {user.displayName}
          </span>
        </Button>
      </DropdownMenuTrigger>

      <DropdownMenuContent align="end">
        <DropdownMenuItem onClick={() => router.push("/dashboard/profile")}>
          Profil
        </DropdownMenuItem>

        <DropdownMenuItem onClick={() => router.push("/dashboard/settings")}>
          Ustawienia
        </DropdownMenuItem>

        <DropdownMenuItem
          className="text-red-600"
          onClick={() => signOut(auth)}
        >
          Wyloguj
        </DropdownMenuItem>
      </DropdownMenuContent>
    </DropdownMenu>
  );
}

--- FILE: components/dashboard/DashboardLayout.tsx ---
import { Sidebar } from "./Sidebar";
import { Topbar } from "./Topbar";

export function DashboardLayout({
  children,
}: {
  children: React.ReactNode;
}) {
  return (
    <div className="flex min-h-screen">
      <Sidebar />

      <div className="flex flex-col flex-1">
        <Topbar />
        <main className="flex-1 p-6 bg-muted/40">
          {children}
        </main>
      </div>
    </div>
  );
}

--- FILE: components/dashboard/Sidebar.tsx ---
"use client";

import Link from "next/link";
import { usePathname } from "next/navigation";
import { cn } from "@/lib/utils";

const nav = [
  { label: "Dashboard", href: "/dashboard" },
  { label: "Profil", href: "/dashboard/profile" },
  { label: "Zajƒôcia", href: "/dashboard/classes" },
  { label: "P≈Çatno≈õci", href: "/dashboard/payments" },
  { label: "Dzieci", href: "/dashboard/children" },
];

export function Sidebar() {
  const pathname = usePathname();
  
  return (
    <aside className="w-64 border-r bg-background h-screen sticky top-0">
      <div className="p-4 font-semibold text-lg">
        üéµ Music Platform
      </div>

      <nav className="px-2 space-y-1">
        {nav.map((item) => {
          const active = pathname === item.href;

          return (
            <Link
              key={item.href}
              href={item.href}
              className={cn(
                "block rounded-md px-3 py-2 text-sm transition",
                active
                  ? "bg-primary text-primary-foreground"
                  : "hover:bg-muted"
              )}
            >
              {item.label}
            </Link>
          );
        })}
      </nav>
    </aside>
  );
}

--- FILE: components/profile/ParentProfileForm.tsx ---
"use client";
import { useEffect, useMemo, useState } from "react";
import type { ParentFormData } from "@/types/profile";
import type { ChildInput } from "@/types/auth";
import { upsertChildrenForParent } from "@/services/children.service";
//import { updateParentProfile } from "@/services/user-profile.service"; 

import { Input } from "@/components/ui/input";
import { Button } from "@/components/ui/button";
import {
  Dialog,
  DialogContent,
  DialogDescription,
  DialogFooter,
  DialogHeader,
  DialogTitle,
} from "@/components/ui/dialog";
import { Alert, AlertDescription } from "@/components/ui/alert";

function emptyChild(): ChildInput {
  return { firstName: "", lastName: "", ageYears: "" };
}

type Props = {
  initialValues: ParentFormData;
  mode: "register" | "complete" | "edit";
  submitLabel?: string;
  onSubmit(data: ParentFormData): Promise<void>;
};

export function ParentProfileForm({
  initialValues,
  mode,
  submitLabel,
  onSubmit,
}: Props) {
  const [form, setForm] = useState<ParentFormData>(initialValues);
  const [pending, setPending] = useState(false);
  const [error, setError] = useState<string | null>(null);

  const [showConfirm, setShowConfirm] = useState(false);
  const [pendingSubmit, setPendingSubmit] =
    useState<ParentFormData | null>(null);

  const [touched, setTouched] = useState<Record<string, boolean>>({});
  const [errors, setErrors] = useState<Record<string, string>>({});

  useEffect(() => {
    setForm(initialValues);
  }, [initialValues]);

  function touch(name: string) {
    setTouched((t) => ({ ...t, [name]: true }));
  }

  function validate(data: ParentFormData) {
    const e: Record<string, string> = {};

    if (!data.firstName.trim()) e.firstName = "Podaj imiƒô.";
    if (!data.lastName.trim()) e.lastName = "Podaj nazwisko.";
    if (!data.email.trim()) e.email = "Podaj email.";
    if (!data.phone.trim()) e.phone = "Podaj numer telefonu.";

    if (
      !data.children.some(
        (c) =>
          c.firstName.trim() &&
          c.lastName.trim() &&
          Number(c.ageYears) > 0
      )
    ) {
      e.children = "Dodaj co najmniej jedno dziecko (imiƒô, nazwisko, wiek).";
    }

    // Adres ‚Äì miƒôkki
    if (!data.street.trim()) e.street = "Uzupe≈Çnij ulicƒô.";
    if (!data.houseNumber.trim())
      e.houseNumber = "Uzupe≈Çnij numer domu.";
    if (!data.postalCode.trim())
      e.postalCode = "Uzupe≈Çnij kod pocztowy.";
    if (!data.city.trim()) e.city = "Uzupe≈Çnij miasto.";

    return e;
  }

  function update<K extends keyof ParentFormData>(
    key: K,
    value: ParentFormData[K]
  ) {
    setForm((f) => ({ ...f, [key]: value }));
  }

  function updateChild(index: number, patch: Partial<ChildInput>) {
    update(
      "children",
      form.children.map((c, i) => (i === index ? { ...c, ...patch } : c))
    );
  }

  function addChild() {
    update("children", [...form.children, emptyChild()]);
  }

  function removeChild(index: number) {
    update(
      "children",
      form.children.filter((_, i) => i !== index)
    );
  }

  async function submitForm(data: ParentFormData) {
    setPending(true);
    setError(null);

    try {
      await onSubmit(data);
    } catch (err: any) {
      setError(err?.message ?? "Nie uda≈Ço siƒô zapisaƒá danych.");
    } finally {
      setPending(false);
    }
  }

  async function handleSubmit(e: React.FormEvent) {
    e.preventDefault();

    setTouched({
      firstName: true,
      lastName: true,
      email: true,
      phone: true,
      street: true,
      houseNumber: true,
      postalCode: true,
      city: true,
      children: true,
    });

    const validationErrors = validate(form);
    setErrors(validationErrors);

    const hardErrors = [
      "firstName",
      "lastName",
      "email",
      "phone",
      "children",
    ].filter((k) => validationErrors[k]);

    const softErrors = [
      "street",
      "houseNumber",
      "postalCode",
      "city",
    ].filter((k) => validationErrors[k]);

    if (hardErrors.length > 0) {
      setError(
        "Uzupe≈Çnij: imiƒô, nazwisko, email, numer telefonu oraz dane co najmniej jednego dziecka."
      );
      return;
    }

    if (softErrors.length > 0) {
      setPendingSubmit(form);
      setShowConfirm(true);
      return;
    }
    
    await submitForm(form);
  }

  return (
    <form onSubmit={handleSubmit} className="space-y-6">
      {/* Dane rodzica */}
      <section className="space-y-3">
        <h2 className="font-medium">Dane rodzica</h2>

        <div className="grid grid-cols-1 gap-3 sm:grid-cols-2">
          <Input
            placeholder="Imiƒô *"
            value={form.firstName}
            onChange={(e) => update("firstName", e.target.value)}
            onBlur={() => touch("firstName")}
            className={
              errors.firstName && touched.firstName ? "border-red-500" : ""
            }
          />

          <Input
            placeholder="Nazwisko *"
            value={form.lastName}
            onChange={(e) => update("lastName", e.target.value)}
            onBlur={() => touch("lastName")}
            className={
              errors.lastName && touched.lastName ? "border-red-500" : ""
            }
          />
        </div>

        <Input
          placeholder="Email *"
          value={form.email}
          disabled={mode !== "edit"}
          onBlur={() => touch("email")}
          className={
            errors.email && touched.email ? "border-red-500" : ""
          }
        />

        <Input
          placeholder="Telefon *"
          value={form.phone}
          onChange={(e) => update("phone", e.target.value)}
          onBlur={() => touch("phone")}
          className={
            errors.phone && touched.phone ? "border-red-500" : ""
          }
        />

        <Input
          placeholder="Ulica"
          value={form.street}
          onChange={(e) => update("street", e.target.value)}
          onBlur={() => touch("street")}
          className={
            errors.street && touched.street ? "border-red-500" : ""
          }
        />

        <div className="grid grid-cols-1 gap-3 sm:grid-cols-2">
          <Input
            placeholder="Nr domu"
            value={form.houseNumber}
            onChange={(e) => update("houseNumber", e.target.value)}
            onBlur={() => touch("houseNumber")}
            className={
              errors.houseNumber && touched.houseNumber
                ? "border-red-500"
                : ""
            }
          />

          <Input
            placeholder="Nr mieszkania (opcjonalnie)"
            value={form.apartmentNumber ?? ""}
            onChange={(e) =>
              update("apartmentNumber", e.target.value)
            }
          />
        </div>

        <div className="grid grid-cols-1 gap-3 sm:grid-cols-2">
          <Input
            placeholder="Kod pocztowy"
            value={form.postalCode}
            onChange={(e) => update("postalCode", e.target.value)}
            onBlur={() => touch("postalCode")}
            className={
              errors.postalCode && touched.postalCode
                ? "border-red-500"
                : ""
            }
          />

          <Input
            placeholder="Miasto"
            value={form.city}
            onChange={(e) => update("city", e.target.value)}
            onBlur={() => touch("city")}
            className={
              errors.city && touched.city ? "border-red-500" : ""
            }
          />
        </div>
      </section>

      {/* Dzieci */}
      <section className="space-y-3">
        <div className="flex items-center justify-between">
          <h2 className="font-medium">Dzieci</h2>

          <Button
            type="button"
            variant="outline"
            onClick={addChild}
          >
            ‚ûï Dodaj dziecko
          </Button>
        </div>

        {form.children.map((child, idx) => (
          <div key={idx} className="border rounded-xl p-4 space-y-3">
            <div className="flex justify-between">
              <p>Dziecko {idx + 1}</p>

              {form.children.length > 1 && (
                <Button
                  type="button"
                  variant="ghost"
                  onClick={() => removeChild(idx)}
                >
                  Usu≈Ñ
                </Button>
              )}
            </div>

            <div className="grid grid-cols-1 gap-3 sm:grid-cols-3">
              <Input
                placeholder="Imiƒô *"
                value={child.firstName}
                onChange={(e) =>
                  updateChild(idx, { firstName: e.target.value })
                }
              />

              <Input
                placeholder="Nazwisko *"
                value={child.lastName}
                onChange={(e) =>
                  updateChild(idx, { lastName: e.target.value })
                }
              />

              <Input
                type="number"
                min={1}
                placeholder="Wiek *"
                value={child.ageYears}
                onChange={(e) =>
                  updateChild(idx, {
                    ageYears:
                      e.target.value === ""
                        ? ""
                        : Number(e.target.value),
                  })
                }
              />
            </div>
          </div>
        ))}

        {touched.children && errors.children && (
          <Alert variant="destructive">
            <AlertDescription>{errors.children}</AlertDescription>
          </Alert>
        )}
      </section>

      {error && (
        <Alert variant="destructive">
          <AlertDescription>{error}</AlertDescription>
        </Alert>
      )}

      <Button disabled={pending} className="w-full">
        {pending ? "Zapisywanie..." : submitLabel ?? "Zapisz"}
      </Button>

      {/* Dialog */}
      <Dialog open={showConfirm} onOpenChange={setShowConfirm}>
        <DialogContent>
          <DialogHeader>
            <DialogTitle>Niekompletne dane</DialogTitle>
            <DialogDescription>
              Nie uzupe≈Çni≈Çe≈õ pe≈Çnego adresu (ulica, numer domu,
              kod pocztowy, miasto). Adres jest potrzebny do faktur
              i dokument√≥w. Mo≈ºesz uzupe≈Çniƒá go p√≥≈∫niej w profilu.
            </DialogDescription>
          </DialogHeader>

          <DialogFooter className="gap-2">
            <Button
              variant="outline"
              onClick={() => {
                setShowConfirm(false);
                setPendingSubmit(null);
              }}
            >
              Uzupe≈Çnij dane
            </Button>

            <Button
              onClick={async () => {
                if (pendingSubmit) {
                  setShowConfirm(false);
                  await submitForm(pendingSubmit);
                  setPendingSubmit(null);
                }
              }}
            >
              Zapisz mimo to
            </Button>
          </DialogFooter>
        </DialogContent>
      </Dialog>
    </form>
  );
}

--- FILE: components/billing/CreditsBadge.tsx ---
"use client";

import { useEffect, useState } from "react";
import { collection, getDocs, query, where } from "firebase/firestore";
import { db } from "@/lib/firebase/client";
import { useAuth } from "@/components/auth/AuthProvider";
import { usageKeyForPeriod } from "@/services/time";

import { Card } from "@/components/ui/card";
import { Badge } from "@/components/ui/badge";
import { Progress } from "@/components/ui/progress";
import { Skeleton } from "@/components/ui/skeleton";

type CreditsInfo =
  | { state: "loading" }
  | { state: "none" }
  | {
      state: "loaded";
      remaining: number;
      used: number;
      total: number;
      entitlementId: string;
      periodKey: string;
    };

export function CreditsBadge() {
  const { user } = useAuth();
  const [info, setInfo] = useState<CreditsInfo>({ state: "loading" });

  useEffect(() => {
    if (!user) return;

    (async () => {
      setInfo({ state: "loading" });

      const snap = await getDocs(
        query(
          collection(db, "entitlements"),
          where("parentId", "==", user.uid),
          where("status", "==", "active")
        )
      );

      if (snap.empty) {
        setInfo({ state: "none" });
        return;
      }

      const now = Date.now();

      let best:
        | {
            id: string;
            remaining: number;
            used: number;
            total: number;
            periodKey: string;
          }
        | null = null;

      for (const d of snap.docs) {
        const data: any = d.data();

        // üî• validity check
        const validFrom = Number(data?.validFrom || 0);
        const validTo = Number(data?.validTo || 0);
        if (!(validFrom <= now && now <= validTo)) continue;

        const credits = data?.limits?.credits || {};
        const total = Number(credits?.amount || 0);
        const unlimited = Boolean(credits?.unlimited);
        const period = String(credits?.period || "month");

        if (!unlimited && total <= 0) continue;

        const key = usageKeyForPeriod(period, now);
        const used = Number(data?.usage?.credits?.[key] || 0);
        const remaining = unlimited ? 999999 : Math.max(0, total - used);

        const candidate = {
          id: d.id,
          remaining,
          used,
          total: unlimited ? 999999 : total,
          periodKey: key,
        };

        if (!best || candidate.remaining > best.remaining) best = candidate;
      }

      if (!best) {
        setInfo({ state: "none" });
        return;
      }

      setInfo({
        state: "loaded",
        remaining: best.remaining,
        used: best.used,
        total: best.total,
        entitlementId: best.id,
        periodKey: best.periodKey,
      });
    })();
  }, [user]);

  if (info.state === "none") return null;

  if (info.state === "loading") {
    return (
      <Card className="p-4 space-y-2">
        <div className="flex items-center justify-between">
          <Skeleton className="h-4 w-32" />
          <Skeleton className="h-5 w-16" />
        </div>
        <Skeleton className="h-2 w-full" />
        <Skeleton className="h-3 w-40" />
      </Card>
    );
  }

  const percent =
    info.total > 0 ? Math.min(100, Math.round((info.used / info.total) * 100)) : 0;

  return (
    <Card className="p-4 space-y-2">
      <div className="flex items-start justify-between gap-3">
        <div className="space-y-1">
          <div className="text-sm font-medium">Kredyty</div>
          <div className="text-xs text-muted-foreground">
            Okres: <span className="font-mono">{info.periodKey}</span>
          </div>
        </div>

        <Badge variant={info.remaining > 0 ? "default" : "destructive"}>
          {info.remaining}/{info.total}
        </Badge>
      </div>

      <Progress value={percent} />

      <div className="text-xs text-muted-foreground">
        Wykorzystane: <span className="font-medium text-foreground">{info.used}</span>
      </div>
    </Card>
  );
}

--- FILE: components/billing/PurchasePlanModal.tsx ---
"use client";

import { useEffect, useMemo, useState } from "react";
import type { Plan } from "@/types/plans";
import type { PurchaseContext } from "@/types/billing";

import { getPlans } from "@/services/plans.service";
import { createPaymentIntent } from "@/services/payment-intents.service";
import { useAuth } from "@/components/auth/AuthProvider";

import { Dialog, DialogContent, DialogHeader, DialogTitle } from "@/components/ui/dialog";
import { Button } from "@/components/ui/button";
import { Loader2 } from "lucide-react";
import { cn } from "@/lib/utils";

type Props = {
  open: boolean;
  onClose: () => void;
  context: PurchaseContext;
  onSuccess?: (data: { paymentIntentId: string }) => void;
};

export function PurchasePlanModal({ open, onClose, context, onSuccess }: Props) {
  const { user } = useAuth();

  const [plans, setPlans] = useState<Plan[]>([]);
  const [selectedPlanId, setSelectedPlanId] = useState<string | null>(null);
  const [loading, setLoading] = useState(false);

  const selectedPlan = useMemo(
    () => plans.find((p) => p.id === selectedPlanId) ?? null,
    [plans, selectedPlanId]
  );

  useEffect(() => {
    if (!open) return;
    setSelectedPlanId(null);
    getPlans().then((all) => setPlans(all.filter((p) => p.isActive)));
  }, [open]);

  async function handlePurchase() {
    if (!selectedPlanId || !user) return;

    setLoading(true);
    try {
      const plan = plans.find((p) => p.id === selectedPlanId)!;

      const isClass = context.type === "class_enrollment";

      const rawDates = (context as any).dates;
      const dates = Array.isArray(rawDates) ? rawDates : null;

      const dateYMD = (context as any).dateYMD ? String((context as any).dateYMD) : null;

      // domy≈õlnie: jak kupujesz z poziomu terminu zajƒôƒá => chcesz od razu zapisaƒá ten termin
      const enrollNow = (context as any).enrollNow ?? (isClass ? true : false);

      const metadata = isClass
        ? {
            classId: (context as any).classId,
            childId: (context as any).childId,
            enrollNow: Boolean(enrollNow),
            ...(dateYMD ? { dateYMD } : {}),
            ...(dates ? { dates } : {}),
          }
        : {};

      const intentId = await createPaymentIntent({
        parentId: user.uid,
        email: user.email ?? "",
        description: `Plan ${plan.id}`,
        planId: plan.id,
        amountCents: plan.priceCents,
        currency: "PLN",
        provider: "tpay",
        metadata,
      });

      onSuccess?.({ paymentIntentId: intentId });
    } finally {
      setLoading(false);
    }
  }

  return (
    <Dialog open={open} onOpenChange={onClose}>
      <DialogContent className="max-w-3xl space-y-6">
        <DialogHeader>
          <DialogTitle className="text-xl">Wybierz plan</DialogTitle>
        </DialogHeader>

        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
          {plans.map((plan) => (
            <button
              key={plan.id}
              onClick={() => setSelectedPlanId(plan.id)}
              className={cn(
                "rounded-xl border p-5 text-left transition",
                selectedPlanId === plan.id ? "border-primary bg-primary/5" : "hover:bg-muted"
              )}
            >
              <div className="text-lg font-semibold">{plan.name}</div>
              <div className="text-sm text-muted-foreground">{plan.description}</div>
              <div className="mt-4 text-xl font-bold">
                {(plan.priceCents / 100).toFixed(2)} z≈Ç
              </div>
            </button>
          ))}
        </div>

        <Button className="w-full" disabled={!selectedPlanId || loading} onClick={handlePurchase}>
          {loading && <Loader2 className="w-4 h-4 mr-2 animate-spin" />}
          Przejd≈∫ do p≈Çatno≈õci
        </Button>
      </DialogContent>
    </Dialog>
  );
}

--- FILE: components/billing/CreditsByChildPanel.tsx ---
"use client";

import { useEffect, useMemo, useState } from "react";
import { collection, getDocs, query, where } from "firebase/firestore";
import { db } from "@/lib/firebase/client";
import { useAuth } from "@/components/auth/AuthProvider";
import { getParentProfile } from "@/services/user-profile.service";
import { getPlans } from "@/services/plans.service";
import { usageKeyForPeriod } from "@/services/time";

import type { Entitlement } from "@/types/entitlements";
import type { Plan } from "@/types/plans";
import type { Child } from "@/types/child";

import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Badge } from "@/components/ui/badge";
import { Progress } from "@/components/ui/progress";
import { Skeleton } from "@/components/ui/skeleton";

function fmtDate(ts: number) {
  try {
    return new Date(ts).toLocaleDateString("pl-PL");
  } catch {
    return "‚Äî";
  }
}

function planTypeLabel(t?: string) {
  switch (t) {
    case "one_off_class":
      return "P≈Çatno≈õƒá jednorazowa";
    case "monthly_4":
      return "Pakiet 4 zajƒôcia";
    case "subscription_standard":
      return "Subskrypcja STANDARD";
    case "subscription_gold":
      return "Subskrypcja GOLD";
    default:
      return t || "Plan";
  }
}

function cardLabel(v?: "standard" | "gold" | "none") {
  if (v === "gold") return "GOLD";
  if (v === "standard") return "STANDARD";
  return null;
}

type Props = {
  refreshTick?: number;
};

export function CreditsByChildPanel({ refreshTick = 0 }: Props) {
  const { user } = useAuth();

  const [loading, setLoading] = useState(true);
  const [children, setChildren] = useState<Child[]>([]);
  const [ents, setEnts] = useState<Entitlement[]>([]);
  const [plans, setPlans] = useState<Plan[]>([]);
  const [error, setError] = useState<string | null>(null);

  useEffect(() => {
    if (!user) return;

    let alive = true;

    (async () => {
      setLoading(true);
      setError(null);

      try {
        const [profile, plansList, entsSnap] = await Promise.all([
          getParentProfile(user.uid),
          getPlans(),
          getDocs(
            query(
              collection(db, "entitlements"),
              where("parentId", "==", user.uid),
              where("status", "==", "active")
            )
          ),
        ]);

        if (!alive) return;

        const now = Date.now();

        const entList = entsSnap.docs
          .map((d) => ({ id: d.id, ...(d.data() as any) }) as Entitlement)
          // wa≈ºne ‚Äúteraz‚Äù
          .filter((e) => now >= Number(e.validFrom || 0) && now <= Number(e.validTo || 0));

        setChildren((profile?.children as Child[]) ?? []);
        setPlans(plansList ?? []);
        setEnts(entList);
      } catch (e: any) {
        if (!alive) return;
        setError(String(e?.message || e));
      } finally {
        if (alive) setLoading(false);
      }
    })();

    return () => {
      alive = false;
    };
  }, [user, refreshTick]);

  const plansById = useMemo(() => {
    const m = new Map<string, Plan>();
    for (const p of plans) m.set(p.id, p);
    return m;
  }, [plans]);

  const entsByChild = useMemo(() => {
    const map = new Map<string, Entitlement[]>();
    const general: Entitlement[] = [];

    for (const e of ents) {
      if (e.childId) {
        if (!map.has(e.childId)) map.set(e.childId, []);
        map.get(e.childId)!.push(e);
      } else {
        general.push(e);
      }
    }

    // sort: najpierw GOLD/STD potem reszta, potem ko≈Ñc√≥wka wa≈ºno≈õci
    const score = (e: Entitlement) => {
      const card = e.benefits?.membershipCard;
      const s1 = card === "gold" ? 30 : card === "standard" ? 20 : 0;
      const s2 =
        e.type === "subscription_gold"
          ? 30
          : e.type === "subscription_standard"
          ? 20
          : e.type === "monthly_4"
          ? 10
          : 0;
      return s1 + s2;
    };

    for (const [k, arr] of map.entries()) {
      arr.sort((a, b) => score(b) - score(a) || Number(b.validTo) - Number(a.validTo));
    }
    general.sort((a, b) => score(b) - score(a) || Number(b.validTo) - Number(a.validTo));

    return { map, general };
  }, [ents]);

  if (!user) return null;

  if (loading) {
    return (
      <div className="grid gap-4 md:grid-cols-2">
        <Skeleton className="h-40" />
        <Skeleton className="h-40" />
      </div>
    );
  }

  if (error) {
    return (
      <Card>
        <CardHeader>
          <CardTitle>Kredyty</CardTitle>
        </CardHeader>
        <CardContent className="text-sm text-red-600">{error}</CardContent>
      </Card>
    );
  }

  if (children.length === 0 && ents.length === 0) {
    return (
      <Card>
        <CardHeader>
          <CardTitle>Kredyty i subskrypcje</CardTitle>
        </CardHeader>
        <CardContent className="text-sm text-muted-foreground">
          Brak aktywnych pakiet√≥w/subskrypcji.
        </CardContent>
      </Card>
    );
  }

  function EntRow({ e }: { e: Entitlement }) {
    const plan = plansById.get(e.planId);
    const credits = e.limits?.credits;
    const unlimited = Boolean(credits?.unlimited);
    const amount = Number(credits?.amount || 0);
    const period = String(credits?.period || "month");

    const periodKey = usageKeyForPeriod(period, Date.now());
    const used = Number(e.usage?.credits?.[periodKey] || 0);
    const total = unlimited ? Infinity : amount;
    const remaining = unlimited ? Infinity : Math.max(0, amount - used);

    const pct =
      total === Infinity || total <= 0 ? 0 : Math.max(0, Math.min(100, (remaining / total) * 100));

    const card = cardLabel(e.benefits?.membershipCard);

    return (
      <div className="rounded-xl border p-3 space-y-2">
        <div className="flex items-start justify-between gap-3">
          <div className="min-w-0">
            <div className="font-medium truncate">
              {plan?.name ?? planTypeLabel(e.type)}
            </div>
            <div className="text-xs text-muted-foreground">
              Wa≈ºne: {fmtDate(e.validFrom)} ‚Äì {fmtDate(e.validTo)}
            </div>
          </div>

          <div className="flex items-center gap-2 shrink-0">
            {card && <Badge variant={card === "GOLD" ? "default" : "secondary"}>{card}</Badge>}
            <Badge variant="outline">{periodKey}</Badge>
          </div>
        </div>

        {credits ? (
          <>
            <div className="flex items-center justify-between text-sm">
              <span className="text-muted-foreground">Kredyty</span>
              <span className="font-medium">
                {remaining === Infinity ? "‚àû" : remaining} / {total === Infinity ? "‚àû" : total}
              </span>
            </div>
            {total !== Infinity && total > 0 ? <Progress value={pct} /> : null}
          </>
        ) : (
          <div className="text-sm text-muted-foreground">Ten plan nie ma kredyt√≥w.</div>
        )}
      </div>
    );
  }

  return (
    <div className="space-y-4">
      {entsByChild.general.length > 0 && (
        <Card>
          <CardHeader>
            <CardTitle>Pakiety og√≥lne</CardTitle>
          </CardHeader>
          <CardContent className="space-y-3">
            {entsByChild.general.map((e) => (
              <EntRow key={e.id} e={e} />
            ))}
          </CardContent>
        </Card>
      )}

      <div className="grid gap-4 md:grid-cols-2">
        {children.map((c) => {
          const list = entsByChild.map.get(c.id) ?? [];
          return (
            <Card key={c.id}>
              <CardHeader>
                <CardTitle className="flex items-center justify-between">
                  <span className="truncate">
                    {c.firstName} {c.lastName}
                  </span>
                  <Badge variant="outline">{c.ageYears} lat</Badge>
                </CardTitle>
              </CardHeader>

              <CardContent className="space-y-3">
                {list.length === 0 ? (
                  <div className="text-sm text-muted-foreground">
                    Brak aktywnej subskrypcji/pakietu dla tego dziecka.
                  </div>
                ) : (
                  list.map((e) => <EntRow key={e.id} e={e} />)
                )}
              </CardContent>
            </Card>
          );
        })}
      </div>
    </div>
  );
}
--- FILE: components/billing/OrdersList.tsx ---
"use client";

import { useEffect, useMemo, useState } from "react";
import { collection, getDocs, query, where } from "firebase/firestore";
import { db } from "@/lib/firebase/client";
import { useAuth } from "@/components/auth/AuthProvider";
import { getPlans } from "@/services/plans.service";
import { getParentProfile } from "@/services/user-profile.service";

import type { PaymentIntent } from "@/types/payment-intents";
import type { Plan } from "@/types/plans";
import type { Child } from "@/types/child";

import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Badge } from "@/components/ui/badge";
import { Button } from "@/components/ui/button";
import { Skeleton } from "@/components/ui/skeleton";
import { ExternalLink, Loader2 } from "lucide-react";

type Filter = "unpaid" | "paid" | "all";

function moneyPLN(cents: number) {
  const v = Number(cents || 0) / 100;
  return v.toLocaleString("pl-PL", { style: "currency", currency: "PLN" });
}

function fmtDateTime(ts?: number) {
  if (!ts) return "‚Äî";
  return new Date(ts).toLocaleString("pl-PL");
}

function statusBadge(status: string) {
  switch (status) {
    case "paid":
      return <Badge className="bg-green-600">op≈Çacone</Badge>;
    case "redirected":
      return <Badge className="bg-blue-600">rozpoczƒôte</Badge>;
    case "created":
      return <Badge variant="secondary">utworzone</Badge>;
    case "failed":
      return <Badge className="bg-red-600">nieudane</Badge>;
    case "cancelled":
      return <Badge variant="outline">anulowane</Badge>;
    default:
      return <Badge variant="outline">{status}</Badge>;
  }
}

type Props = {
  refreshTick?: number;
};

export function OrdersList({ refreshTick = 0 }: Props) {
  const { user } = useAuth();

  const [loading, setLoading] = useState(true);
  const [items, setItems] = useState<Array<PaymentIntent & { finalizedAt?: number; providerTitle?: string }>>([]);
  const [plans, setPlans] = useState<Plan[]>([]);
  const [children, setChildren] = useState<Child[]>([]);
  const [filter, setFilter] = useState<Filter>("unpaid");
  const [payingId, setPayingId] = useState<string | null>(null);
  const [error, setError] = useState<string | null>(null);

  useEffect(() => {
    if (!user) return;

    let alive = true;

    (async () => {
      setLoading(true);
      setError(null);

      try {
        const [plansList, profile, snap] = await Promise.all([
          getPlans(),
          getParentProfile(user.uid),
          getDocs(query(collection(db, "payment_intents"), where("parentId", "==", user.uid))),
        ]);

        if (!alive) return;

        const list = snap.docs
          .map((d) => ({ id: d.id, ...(d.data() as any) }))
          .map((x) => x as any)
          .sort((a, b) => Number(b.createdAt || 0) - Number(a.createdAt || 0));

        setPlans(plansList ?? []);
        setChildren((profile?.children as Child[]) ?? []);
        setItems(list);
      } catch (e: any) {
        if (!alive) return;
        setError(String(e?.message || e));
      } finally {
        if (alive) setLoading(false);
      }
    })();

    return () => {
      alive = false;
    };
  }, [user, refreshTick]);

  const plansById = useMemo(() => {
    const m = new Map<string, Plan>();
    for (const p of plans) m.set(p.id, p);
    return m;
  }, [plans]);

  const childNameById = useMemo(() => {
    const m = new Map<string, string>();
    for (const c of children) m.set(c.id, `${c.firstName} ${c.lastName}`.trim());
    return m;
  }, [children]);

  const visible = useMemo(() => {
    const isPaid = (s: string) => s === "paid";
    const isUnpaid = (s: string) => s !== "paid" && s !== "cancelled";
    if (filter === "paid") return items.filter((x) => isPaid(String(x.status)));
    if (filter === "unpaid") return items.filter((x) => isUnpaid(String(x.status)));
    return items;
  }, [items, filter]);

  async function pay(intentId: string) {
    setPayingId(intentId);
    setError(null);

    try {
      const res = await fetch("/api/payments/tpay/create", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ intentId }),
      });

      const data = await res.json().catch(() => ({}));
      if (!res.ok) {
        throw new Error(data?.error || data?.details || "Nie uda≈Ço siƒô rozpoczƒÖƒá p≈Çatno≈õci.");
      }

      if (!data?.paymentUrl) throw new Error("Brak paymentUrl z API.");
      window.location.assign(String(data.paymentUrl));
    } catch (e: any) {
      setError(String(e?.message || e));
    } finally {
      setPayingId(null);
    }
  }

  if (!user) return null;

  if (loading) {
    return (
      <div className="space-y-3">
        <Skeleton className="h-28" />
        <Skeleton className="h-28" />
      </div>
    );
  }

  return (
    <div className="space-y-4">
      <div className="flex flex-wrap items-center gap-2">
        <Button
          variant={filter === "unpaid" ? "default" : "outline"}
          onClick={() => setFilter("unpaid")}
        >
          Do op≈Çacenia
        </Button>
        <Button
          variant={filter === "paid" ? "default" : "outline"}
          onClick={() => setFilter("paid")}
        >
          Op≈Çacone
        </Button>
        <Button
          variant={filter === "all" ? "default" : "outline"}
          onClick={() => setFilter("all")}
        >
          Wszystkie
        </Button>
      </div>

      {error && (
        <div className="rounded-lg border border-red-300 bg-red-50 px-3 py-2 text-sm text-red-700">
          {error}
        </div>
      )}

      {visible.length === 0 ? (
        <Card>
          <CardHeader>
            <CardTitle>Zam√≥wienia</CardTitle>
          </CardHeader>
          <CardContent className="text-sm text-muted-foreground">
            Brak pozycji dla wybranego filtra.
          </CardContent>
        </Card>
      ) : (
        <div className="space-y-3">
          {visible.map((x) => {
            const plan = plansById.get(x.planId);
            const status = String(x.status || "");
            const metaChildId = (x.metadata?.childId || x.childId || "") as string;
            const who = metaChildId ? childNameById.get(metaChildId) : null;

            const isPayable = status !== "paid" && status !== "cancelled";
            const isPaying = payingId === x.id;

            return (
              <Card key={x.id}>
                <CardContent className="p-4 space-y-2">
                  <div className="flex items-start justify-between gap-3">
                    <div className="min-w-0">
                      <div className="font-medium truncate">
                        {plan?.name ?? x.description ?? x.planId}
                      </div>

                      <div className="text-xs text-muted-foreground">
                        Utworzono: {fmtDateTime(x.createdAt)} ‚Ä¢ Kwota:{" "}
                        <span className="font-medium">{moneyPLN(x.amountCents)}</span>
                      </div>

                      <div className="text-xs text-muted-foreground">
                        {who ? <>Dla dziecka: <span className="font-medium">{who}</span> ‚Ä¢ </> : null}
                        Intent: <span className="font-mono">{x.id}</span>
                      </div>

                      <div className="text-xs text-muted-foreground">
                        Op≈Çacono: {fmtDateTime(x.paidAt)} ‚Ä¢ Finalizacja:{" "}
                        {fmtDateTime((x as any).finalizedAt)}
                      </div>
                    </div>

                    <div className="flex flex-col items-end gap-2 shrink-0">
                      {statusBadge(status)}

                      <Button
                        size="sm"
                        disabled={!isPayable || isPaying}
                        onClick={() => pay(x.id)}
                      >
                        {isPaying ? (
                          <>
                            <Loader2 className="w-4 h-4 mr-2 animate-spin" />
                            Przekierowujƒô‚Ä¶
                          </>
                        ) : (
                          <>
                            <ExternalLink className="w-4 h-4 mr-2" />
                            {status === "redirected" ? "Kontynuuj" : "Zap≈Çaƒá"}
                          </>
                        )}
                      </Button>
                    </div>
                  </div>
                </CardContent>
              </Card>
            );
          })}
        </div>
      )}
    </div>
  );
}

